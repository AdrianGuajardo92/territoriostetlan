<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, minimum-scale=1" />
    <title>Gestor de Territorios (LS) - Desarrollo Local</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=LS">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS con configuración optimizada -->
<script>
    // Configurar Tailwind antes de cargarlo
    window.tailwind = {
        config: {
            darkMode: 'class',
            corePlugins: {
                preflight: true,
            }
        }
    };
</script>
<script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
<!-- React - Crítico, se carga primero pero con defer -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin defer></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin defer></script>

<!-- Babel - Necesario para JSX, pero puede cargar en paralelo -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>

<!-- Firebase - Puede cargar asíncronamente -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" async></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" async></script>

<!-- Preconectar a los dominios para acelerar las descargas -->
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://www.gstatic.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://www.gstatic.com">

<!-- Precargar recursos críticos -->
<link rel="preload" href="https://unpkg.com/react@18/umd/react.production.min.js" as="script">
<!-- SheetJS para exportar a Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" async></script>
<!-- Leaflet para mapas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" async></script>
<link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" as="script">
    <style>
        @import url('https://rsms.me/inter/inter.css');
        :root {
            --primary-color: #4f46e5;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding-top: 40px; /* Espacio para el banner de desarrollo */
            padding-bottom: env(safe-area-inset-bottom, 80px);
            overscroll-behavior-y: contain;
        }
        
        /* Mejora de performance con will-change */
        .transition-transform {
            will-change: transform;
        }
        
        /* Animaciones optimizadas */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        .fade-in-out {
            animation: fadeInOut 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* Estilos para el Resplandor Suave y Temporal */
        @keyframes navigating-pulse-glow {
            0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
        .highlight-navigating {
            animation: navigating-pulse-glow 1.5s infinite;
            z-index: 10;
        }


        /* Estilos para el Pulso Triple (Ondas) */
        @keyframes ripple-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5),
                            0 0 0 0 rgba(59, 130, 246, 0.5),
                            0 0 0 0 rgba(59, 130, 246, 0.5);
            }
            100% {
                box-shadow: 0 0 0 30px rgba(59, 130, 246, 0),
                            0 0 0 20px rgba(59, 130, 246, 0),
                            0 0 0 10px rgba(59, 130, 246, 0);
            }
        }
        .highlight-ripple {
            animation: ripple-pulse 2s ease-out infinite;
        }



        /* Estilos para el Indicador de Flecha */
        @keyframes bounce-arrow {
            0%, 100% { transform: translate(-50%, -50%); }
            50% { transform: translate(calc(-50% - 8px), -50%); }
        }
        .highlight-arrow-indicator::before {
            content: '➤';
            position: absolute;
            left: -12px; /* Ajustado para mejor posicionamiento */
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #3b82f6;
            animation: bounce-arrow 1.2s ease-in-out infinite;
            text-shadow: 0 0 5px white;
        }





        @keyframes slideDownFade {
            0% { transform: translateY(-150%); opacity: 0; }
            15% { transform: translateY(0); opacity: 1; }
            85% { opacity: 1; transform: translateY(0); }
            100% { transform: translateY(-150%); opacity: 0; }
        }
        
        .completion-banner-animate {
            animation: slideDownFade 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .check-animation {
            animation: checkmark 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        

        .glow-shadow-pending {
            box-shadow: 0 0 25px 8px rgba(55, 65, 81, 0.4), 0 4px 6px -2px rgba(55, 65, 81, 0.1);
        }



        /* Skeleton mejorado con gradiente más suave */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(243, 244, 246, 1) 0%,
                rgba(229, 231, 235, 0.8) 50%,
                rgba(243, 244, 246, 1) 100%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

                /* Estilos para el efecto de resplandor (glow) */
        .glow-shadow-pending {
            box-shadow: 0 0 25px 8px rgba(55, 65, 81, 0.4), 0 4px 6px -2px rgba(55, 65, 81, 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .glow-shadow-completed {
            box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.3), 0 4px 6px -2px rgba(34, 197, 94, 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }

        
        /* Mejora para scroll en iOS */
        .scrollable {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Focus mejorado para accesibilidad */
        *:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Transiciones optimizadas */
        .transition-base {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
        
        /* Card hover mejorado */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        /* Animación de pulse para resaltado */
        @keyframes highlight-flash {
    0%, 100% { 
        /* Regresa al color de fondo original de la tarjeta */
        background-color: transparent; 
    }
    25%, 75% { 
        /* Color del primer destello */
        background-color: rgba(224, 231, 255, 0.9); 
    }
    50% { 
        /* Color del segundo destello, un poco más intenso */
        background-color: rgba(199, 210, 254, 0.9); 
    }
}

.highlight-card {
    /* Esta clase se aplica a la tarjeta que fue buscada */
    animation: highlight-flash 3s ease-in-out;
    border-color: #4f46e5 !important; /* Mantenemos el borde para un resaltado extra */
    border-width: 3px !important;
}
        
        /* Toast mejorado */
        @keyframes slideInRight {
            from { 
                transform: translateX(110%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(110%);
                opacity: 0;
            }
        }
        
        .toast-enter {
            animation: slideInRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        .toast-exit {
            animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
        }
        
        /* Loading spinner mejorado */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Print styles mejorados */
        @media print {
            .no-print { display: none !important; }
            body { 
                background: white;
                padding-bottom: 0;
                font-size: 12pt;
            }
            .print-break { page-break-after: always; }
            .print-no-break { page-break-inside: avoid; }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            /* Aquí podrías agregar estilos para modo oscuro */
        }
        
        /* Mejora para dispositivos táctiles */
        @media (hover: none) {
            .card-hover:active {
                transform: scale(0.98);
            }
        }
        
        /* Safe areas para iPhone X+ */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        /* Mejora de legibilidad */
        .text-balance {
            text-wrap: balance;
        }
        
        /* Estilos para marcadores personalizados del mapa */
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }
        
        /* Asegurar que el contenedor del mapa use todo el espacio disponible */
        .leaflet-container {
            width: 100%;
            height: 100%;
        }
        
        /* Animación para el panel inferior */
        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Banner de Desarrollo -->
    <div id="dev-banner" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #10b981;
        color: white;
        text-align: center;
        padding: 8px;
        font-size: 14px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
        🚧 MODO DESARROLLO - Los cambios de código NO afectan producción 🚧
    </div>
    <!-- Splash Screen -->
<div id="splash-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Verde para desarrollo */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    transition: opacity 0.3s ease-out;
">
    <div style="text-align: center; animation: fadeInUp 0.8s ease-out;">
        <!-- Logo/Icono -->
        <div style="
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        ">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        </div>
        
        <!-- Título -->
        <h1 style="
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        ">Gestor de Territorios</h1>
        
        <!-- Subtítulo -->
        <p style="
            color: rgba(255, 255, 255, 0.8);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            font-weight: 400;
            margin: 0 0 32px 0;
        ">LS Coyoacán - MODO DESARROLLO</p>
        
        <!-- Spinner -->
        <div style="
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        "></div>
    </div>
</div>

<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
    <div id="root"></div>
<!-- Script de inicialización inteligente -->
<script>
    // Esperar a que los recursos críticos estén listos
    let resourcesReady = {
        react: false,
        reactDOM: false,
        babel: false,
        firebase: false
    };
    
    // Verificar disponibilidad de librerías
    function checkResources() {
        resourcesReady.react = typeof React !== 'undefined';
        resourcesReady.reactDOM = typeof ReactDOM !== 'undefined';
        resourcesReady.babel = typeof Babel !== 'undefined';
        resourcesReady.firebase = typeof firebase !== 'undefined';
        
        const allReady = Object.values(resourcesReady).every(ready => ready);
        
        if (allReady) {
            console.log('✅ Todos los recursos están listos');
            initializeApp();
        } else {
            // Mostrar qué falta
            const pending = Object.entries(resourcesReady)
                .filter(([key, ready]) => !ready)
                .map(([key]) => key);
            console.log('⏳ Esperando recursos:', pending.join(', '));
            
            // Reintentar en 100ms
            setTimeout(checkResources, 100);
        }
    }
    
    // Función para inicializar la app
    function initializeApp() {
        // Remover el splash screen suavemente
        const splash = document.getElementById('splash-screen');
        if (splash && !window.splashRemoved) {
            window.splashRemoved = true;
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.remove();
                }, 300);
            }, 300);
        }
        
        // Indicar que la app está lista
        document.body.classList.add('app-ready');
        console.log('🚀 Aplicación inicializada');
    }
    
    // Optimización de rendimiento: RequestIdleCallback
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
            checkResources();
        });
    } else {
        // Fallback para navegadores sin requestIdleCallback
        setTimeout(checkResources, 0);
    }
    
    // Prevenir FOUC (Flash of Unstyled Content)
    document.addEventListener('DOMContentLoaded', () => {
        document.body.style.visibility = 'visible';
    });
</script>

<!-- Estilo para prevenir FOUC -->
<style>
    body {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    body.app-ready {
        visibility: visible;
        opacity: 1;
    }
</style>
    <script type="text/babel">


        // --- Configuración y constantes ---
// Ya no necesitamos contraseñas hardcodeadas
// Los usuarios ahora están en Firebase
        


        const { useState, useEffect, useLayoutEffect, useMemo, createContext, useContext, useCallback, useRef, memo, useReducer } = React;
        
        // --- Utilidades mejoradas ---
        const normalizeText = (text) => {
            if (!text) return '';
            return text
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim();
        };
        
        // Hook personalizado para debounce mejorado
        const useDebounce = (value, delay = 300) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            const timeoutRef = useRef(null);
            
            useEffect(() => {
                if (timeoutRef.current) {
                    clearTimeout(timeoutRef.current);
                }
                
                timeoutRef.current = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                
                return () => {
                    if (timeoutRef.current) {
                        clearTimeout(timeoutRef.current);
                    }
                };
            }, [value, delay]);
            
            return debouncedValue;
        };
        
        // Hook para detectar el tipo de dispositivo
        const useDeviceType = () => {
            const [deviceType, setDeviceType] = useState('desktop');
            
            useEffect(() => {
                const checkDevice = () => {
                    const width = window.innerWidth;
                    if (width < 640) setDeviceType('mobile');
                    else if (width < 1024) setDeviceType('tablet');
                    else setDeviceType('desktop');
                };
                
                checkDevice();
                window.addEventListener('resize', checkDevice);
                return () => window.removeEventListener('resize', checkDevice);
            }, []);
            
            return deviceType;
        };
        
        // Hook para manejar el estado de conexión mejorado
        const useOnlineStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [connectionQuality, setConnectionQuality] = useState('good');
            
            useEffect(() => {
                const updateOnlineStatus = () => setIsOnline(navigator.onLine);
                
                // Verificar calidad de conexión
                const checkConnectionQuality = async () => {
                    if (!navigator.onLine) {
                        setConnectionQuality('offline');
                        return;
                    }
                    
                    try {
                        const start = Date.now();
                        await fetch('https://www.google.com/favicon.ico', { 
                            mode: 'no-cors',
                            cache: 'no-cache' 
                        });
                        const latency = Date.now() - start;
                        
                        if (latency < 100) setConnectionQuality('excellent');
                        else if (latency < 300) setConnectionQuality('good');
                        else if (latency < 1000) setConnectionQuality('fair');
                        else setConnectionQuality('poor');
                    } catch {
                        setConnectionQuality('poor');
                    }
                };
                
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                
                const interval = setInterval(checkConnectionQuality, 30000);
                checkConnectionQuality();
                
                return () => {
                    window.removeEventListener('online', updateOnlineStatus);
                    window.removeEventListener('offline', updateOnlineStatus);
                    clearInterval(interval);
                };
            }, []);
            
            return { isOnline, connectionQuality };
        };

        // --- Utilidades para formatear fechas mejoradas ---
        const formatDate = (date, options = {}) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            
            if (isNaN(d.getTime())) return 'Fecha inválida';
            
            const defaultOptions = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                ...options
            };
            
            return d.toLocaleDateString('es-MX', defaultOptions);
        };
        
        const formatShortDate = (date) => {
            return formatDate(date, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        };
        
        const formatRelativeTime = (date) => {
            if (!date) return null;
            const d = date.toDate ? date.toDate() : new Date(date);
            if (isNaN(d.getTime())) return 'Fecha inválida';
            
            const now = new Date();
            const diff = now - d;
            
            const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30.44);
            const years = Math.floor(days / 365.25);
            
            if (years > 0) return rtf.format(-years, 'year');
            if (months > 0) return rtf.format(-months, 'month');
            if (days > 0) return rtf.format(-days, 'day');
            if (hours > 0) return rtf.format(-hours, 'hour');
            if (minutes > 0) return rtf.format(-minutes, 'minute');
            return 'Hace unos segundos';
        };

// --- Componentes de iconos mejorados con props por defecto ---
const Icon = ({ name, size = 24, color = "currentColor", className = "", ...props }) => {
    const icons = {
        navigation: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polygon points="3 11 22 2 13 21 11 13 3 11"/>
            </svg>
        ),
        map: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line>
            </svg>
        ),
        apps: (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect>
            </svg>
        ),
        plusCircle: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
        ),
        plus: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        ),
        edit: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        ),
        trash: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        ),
        arrowLeft: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
            </svg>
        ),
        mapPin: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
            </svg>
        ),
        cloudOff: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/><line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
        ),
        wifi: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>
            </svg>
        ),
        uploadCloud: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/>
            </svg>
        ),
        chevronLeft: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="m15 18-6-6 6-6"/>
            </svg>
        ),
        chevronRight: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        ),
        download: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        ),
        logOut: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
        ),
        checkCircle: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        ),
        rotateCcw: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
            </svg>
        ),
        search: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
        ),
        x: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        ),
        alertCircle: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        ),
        barChart: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>
            </svg>
        ),
        lock: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
        ),
        shield: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
        ),
        fileText: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
            </svg>
        ),
        printer: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
            </svg>
        ),
        calendar: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        ),
        user: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
        ),
        users: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        ),
        home: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        ),
        clock: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        ),
        info: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
        ),
        checkSquare: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
        ),
        activity: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
        ),
        flag: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>
            </svg>
        ),
        walking: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <circle cx="12" cy="5" r="1"/><path d="m7 20 1.5-5 2 1 1-4 1.5 2 1 4 1.5-2 1.5 5"/><path d="m8.5 13-1.5-3h8l-1.5 3"/>
            </svg>
        ),
        bookmark: (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
        )
    };
    
    return icons[name] || null;
};

// --- Componente: Modal de "Mis Propuestas" ---
// --- Componente: Modal de "Mis Propuestas" ---
const MyProposalsModal = ({ isOpen, onClose, currentUser }) => {
    const [proposals, setProposals] = useState([]);
    const [loading, setLoading] = useState(true);
    const { db, territories } = useContext(AppContext);

    const safeClose = useCallback(() => {
        try {
            if (onClose && typeof onClose === 'function') {
                onClose();
            }
        } catch (error) {
            console.error('Error al cerrar modal de propuestas:', error);
            if (window.history && window.history.length > 1) {
                window.history.back();
            }
        }
    }, [onClose]);
    
    useEffect(() => {
        if (!isOpen || !db || !currentUser) return;
        setLoading(true);
        const unsubscribe = db.collection('addressChangeProposals')
            .where('proposedByUserId', '==', currentUser.id)
            .orderBy('proposedAt', 'desc')
            .onSnapshot(
                snapshot => {
                    const userProposals = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setProposals(userProposals);
                    setLoading(false);
                },
                error => {
                    console.error('Error al cargar propuestas:', error);
                    setLoading(false);
                }
            );
        return () => unsubscribe();
    }, [isOpen, db, currentUser]);

    useEffect(() => {
        if (!isOpen || !db || !currentUser) return;
        const markAsRead = async () => {
            try {
                const unreadProposals = await db.collection('addressChangeProposals')
                    .where('proposedByUserId', '==', currentUser.id)
                    .where('status', 'in', ['approved', 'rejected'])
                    .where('notificationRead', '==', false)
                    .get();
                const batch = db.batch();
                unreadProposals.docs.forEach(doc => {
                    batch.update(doc.ref, { notificationRead: true });
                });
                await batch.commit();
            } catch (error) {
                console.error('Error al marcar notificaciones como leídas:', error);
            }
        };
        markAsRead();    
    }, [isOpen, db, currentUser]);
    
    if (!isOpen) return null;

    const getStatusBadge = (status) => {
        const config = {
            pending: { text: 'Pendiente', bg: 'bg-yellow-100', color: 'text-yellow-800', icon: 'clock' },
            approved: { text: 'Aprobada', bg: 'bg-green-100', color: 'text-green-800', icon: 'checkCircle' },
            rejected: { text: 'Rechazada', bg: 'bg-red-100', color: 'text-red-800', icon: 'x' }
        };
        return config[status] || config.pending;
    };
    
    return (
        <div className="fixed inset-0 z-[70] bg-white flex flex-col">
            <div className="bg-gray-50 border-b border-gray-200">
                <div className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold text-gray-800">Mis Propuestas de Cambios</h2>
                        <button onClick={safeClose} className="p-2 hover:bg-gray-200 rounded-lg transition-colors">
                            <Icon name="x" size={24} className="text-gray-600" />
                        </button>
                    </div>
                </div>
            </div>
            
            <div className="flex-1 overflow-y-auto bg-gray-50">
                {loading ? (
                    <div className="flex items-center justify-center h-full"><div className="text-center"><div className="animate-spin w-12 h-12 border-4 border-gray-800 border-t-transparent rounded-full mx-auto"></div><p className="text-gray-600 mt-4">Cargando propuestas...</p></div></div>
                ) : proposals.length === 0 ? (
                    <div className="flex items-center justify-center h-full px-8"><div className="text-center"><div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="checkSquare" size={40} className="text-gray-300" /></div><h3 className="text-lg font-semibold text-gray-700 mb-2">No has enviado propuestas aún</h3><p className="text-sm text-gray-500">Cuando propongas cambios en direcciones, aparecerán aquí.</p></div></div>
                ) : (
                    <div className="p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {proposals.map(proposal => {
                                const territory = territories.find(t => t.id === proposal.territoryId);
                                const statusConfig = getStatusBadge(proposal.status);
                                
                                if (proposal.proposalType === 'delete') {
                                    return (
                                        <div key={proposal.id} className="bg-white rounded-lg border border-gray-200 shadow-sm">
                                            <div className="p-4 border-b border-gray-100">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <p className={`font-semibold ${statusConfig.color}`}>{proposal.status === 'approved' ? 'Eliminación Aprobada' : 'Propuesta de Eliminación'}</p>
                                                        <p className="text-sm text-gray-500">{territory?.name?.replace('Territorio ', '') || 'Desconocido'}</p>
                                                    </div>
                                                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusConfig.bg} ${statusConfig.color}`}><Icon name={statusConfig.icon} size={14} className="mr-1" />{statusConfig.text}</span>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-2">{proposal.proposedAt?.toDate ? formatRelativeTime(proposal.proposedAt.toDate()) : 'Fecha desconocida'}</p>
                                            </div>
                                            <div className="p-4">
                                                <p className="text-xs font-medium text-gray-500 mb-1">Dirección propuesta para eliminar:</p>
                                                <p className="text-sm text-red-700 font-medium p-3 bg-red-50 rounded-lg">{proposal.original?.address || 'N/A'}</p>
                                            </div>
                                            {(proposal.status === 'approved' || proposal.status === 'rejected') && proposal.reviewedBy && (
                                                <div className="px-4 pb-4">
                                                    <div className={`p-3 rounded-lg text-sm ${proposal.status === 'approved' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                                        <p className="font-medium">{proposal.status === 'approved' ? 'Aprobada' : 'Rechazada'} por:</p>
                                                        <p className="text-xs mt-1">{proposal.reviewedBy}</p>
                                                        {proposal.reviewedAt && (<p className="text-xs opacity-75 mt-1">{formatRelativeTime(proposal.reviewedAt.toDate())}</p>)}
                                                        {proposal.status === 'rejected' && proposal.rejectionReason && (
                                                            <div className="mt-3 pt-3 border-t border-red-200">
                                                                <p className="text-xs font-medium mb-1">Razón del rechazo:</p>
                                                                <p className="text-sm italic">"{proposal.rejectionReason}"</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                }
                                
                                return (
                                    <div key={proposal.id} className="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all">
                                        <div className="p-4 border-b border-gray-100">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1"><p className="text-sm text-gray-500">Territorio</p><p className="font-semibold text-gray-800">{territory?.name?.replace('Territorio ', '') || 'Desconocido'}</p></div>
                                                <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusConfig.bg} ${statusConfig.color}`}><Icon name={statusConfig.icon} size={14} className="mr-1" />{statusConfig.text}</span>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">{proposal.proposedAt?.toDate ? formatRelativeTime(proposal.proposedAt.toDate()) : 'Fecha desconocida'}</p>
                                        </div>
                                        <div className="p-4">
                                            <h4 className="text-sm font-medium text-gray-700 mb-3">Cambios propuestos</h4>
                                            {proposal.proposed && proposal.original?.address !== proposal.proposed.address && (
                                                <div className="mb-3 p-3 bg-gray-50 rounded-lg"><p className="text-xs font-medium text-gray-500 mb-1">Dirección</p><p className="text-sm line-through text-gray-400 mb-1">{proposal.original?.address || 'N/A'}</p><p className="text-sm text-gray-800 font-medium flex items-center"><Icon name="arrowRight" size={14} className="mr-1 text-green-600" />{proposal.proposed.address}</p></div>
                                            )}
                                            {proposal.changeReason && (
                                                <div className="p-3 bg-blue-50 rounded-lg"><p className="text-xs font-medium text-blue-700 mb-1">Tu razón</p><p className="text-sm text-blue-900 italic">"{proposal.changeReason}"</p></div>
                                            )}
                                        </div>
                                        {(proposal.status === 'approved' || proposal.status === 'rejected') && proposal.reviewedBy && (
                                                        <div className="px-4 pb-4">
                                                            <div className={`p-3 rounded-lg text-sm ${proposal.status === 'approved' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                                                <p className="font-medium">{proposal.status === 'approved' ? 'Aprobada' : 'Rechazada'} por:</p>
                                                                <p className="text-xs mt-1">{proposal.reviewedBy}</p>
                                                                {proposal.reviewedAt && (<p className="text-xs opacity-75 mt-1">{formatRelativeTime(proposal.reviewedAt.toDate())}</p>)}
                                                                {proposal.status === 'rejected' && proposal.rejectionReason && (
                                                                    <div className="mt-3 pt-3 border-t border-red-200">
                                                                        <p className="text-xs font-medium mb-1">Razón del rechazo:</p>
                                                                        <p className="text-sm italic">"{proposal.rejectionReason}"</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
            </div>
            
            <div className="bg-white border-t border-gray-200 px-6 py-4">
                <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600">Mostrando <span className="font-semibold">{proposals.length}</span> de <span className="font-semibold">{proposals.length}</span> propuestas</div>
                    <button onClick={safeClose} className="px-4 py-2 bg-gray-800 text-white font-medium rounded-lg hover:bg-gray-900 transition-colors">Cerrar</button>
                </div>
            </div>
        </div>
    );
};
// --- Fin: Componente "Mis Propuestas" ---





        // --- CONTEXTO DE LA APLICACIÓN MEJORADO ---
        const AppContext = createContext();
        
        // Acciones para el reducer
        const APP_ACTIONS = {
            SET_LOADING: 'SET_LOADING',
            SET_ERROR: 'SET_ERROR',
            SET_TERRITORIES: 'SET_TERRITORIES',
            SET_ADDRESSES: 'SET_ADDRESSES',
            SET_HISTORY: 'SET_HISTORY',
            SET_ONLINE: 'SET_ONLINE',
            SET_SYNCING: 'SET_SYNCING',
            ADD_PENDING_WRITE: 'ADD_PENDING_WRITE',
            REMOVE_PENDING_WRITE: 'REMOVE_PENDING_WRITE',
            CLEAR_PENDING_WRITES: 'CLEAR_PENDING_WRITES',
            SET_NOTIFICATION_PERMISSION: 'SET_NOTIFICATION_PERMISSION'
        };
        
        // Reducer para manejar el estado de la aplicación
        const appReducer = (state, action) => {
            switch (action.type) {
                case APP_ACTIONS.SET_LOADING:
                    return { ...state, isLoading: action.payload };
                case APP_ACTIONS.SET_ERROR:
                    return { ...state, error: action.payload };
                case APP_ACTIONS.SET_TERRITORIES:
                    return { ...state, territories: action.payload };
                case APP_ACTIONS.SET_ADDRESSES:
                    return { ...state, addresses: action.payload };
                case APP_ACTIONS.SET_HISTORY:
                    return { ...state, territoryHistory: action.payload };
                case APP_ACTIONS.SET_ONLINE:
                    return { ...state, isOnline: action.payload };
                case APP_ACTIONS.SET_SYNCING:
                    return { ...state, isSyncing: action.payload };
                case APP_ACTIONS.ADD_PENDING_WRITE:
                    return { 
                        ...state, 
                        pendingWrites: [...state.pendingWrites, action.payload] 
                    };
                case APP_ACTIONS.REMOVE_PENDING_WRITE:
                    return { 
                        ...state, 
                        pendingWrites: state.pendingWrites.filter(w => w.id !== action.payload) 
                    };
                case APP_ACTIONS.CLEAR_PENDING_WRITES:
                    return { ...state, pendingWrites: [] };
                case APP_ACTIONS.SET_NOTIFICATION_PERMISSION:
                    return { ...state, notificationPermission: action.payload };
                default:
                    return state;
            }
        };
        
        // Estado inicial
        const initialAppState = {
            isLoading: true,
            error: null,
            territories: [],
            addresses: [],
            territoryHistory: [],
            isOnline: navigator.onLine,
            isSyncing: false,
            pendingWrites: [],
            notificationPermission: 'default'
        };
        
        // --- Sistema de Notificaciones Toast Mejorado ---
        const ToastContext = createContext();
        
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const toastTimers = useRef({});
            
            const showToast = useCallback((message, type = 'info', duration = 3000, options = {}) => {
                const id = Date.now() + Math.random();
                const newToast = { 
                    id, 
                    message, 
                    type,
                    action: options.action,
                    actionLabel: options.actionLabel || 'Acción'
                };
                
                setToasts(prev => [...prev, newToast]);
                
                if (duration > 0) {
                    toastTimers.current[id] = setTimeout(() => {
                        removeToast(id);
                    }, duration);
                }
                
                return id;
            }, []);
            
            const removeToast = useCallback((id) => {
                if (toastTimers.current[id]) {
                    clearTimeout(toastTimers.current[id]);
                    delete toastTimers.current[id];
                }
                
                setToasts(prev => prev.filter(t => t.id !== id));
            }, []);
            
            // Limpiar timers al desmontar
            useEffect(() => {
                return () => {
                    Object.values(toastTimers.current).forEach(timer => clearTimeout(timer));
                };
            }, []);
            
            const toastColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const toastIcons = {
                success: 'checkCircle',
                error: 'alertCircle',
                warning: 'alertCircle',
                info: 'info'
            };
            
            return (
                <ToastContext.Provider value={{ showToast, removeToast }}>
                    {children}
                    <div className="fixed top-4 right-4 z-[100] space-y-2 no-print" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
                        {toasts.map(toast => (
                            <div
                                key={toast.id}
                                className={`toast-enter p-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[280px] max-w-md ${toastColors[toast.type]} text-white`}
                                role="alert"
                                aria-live="assertive"
                            >
                                <Icon name={toastIcons[toast.type]} size={20} />
                                <div className="flex-1">
                                    <p className="font-medium">{toast.message}</p>
                                    {toast.action && (
                                        <button
                                            onClick={() => {
                                                toast.action();
                                                removeToast(toast.id);
                                            }}
                                            className="mt-1 text-sm underline hover:no-underline"
                                        >
                                            {toast.actionLabel}
                                        </button>
                                    )}
                                </div>
                                <button
                                    onClick={() => removeToast(toast.id)}
                                    className="ml-2 hover:opacity-80"
                                    aria-label="Cerrar notificación"
                                >
                                    <Icon name="x" size={16} />
                                </button>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        
        const useToast = () => {
            const context = useContext(ToastContext);
            if (!context) {
                throw new Error('useToast debe ser usado dentro de ToastProvider');
            }
            return context;
        };

        // --- Componente de Modal Base Mejorado ---
        const Modal = ({ isOpen, onClose, title, children, size = 'md', className = '', showCloseButton = true }) => {
            const modalRef = useRef(null);
            
            // Cerrar con ESC
            useEffect(() => {
                const handleEsc = (e) => {
                    if (e.key === 'Escape' && isOpen) {
                        onClose();
                    }
                };
                
                if (isOpen) {
                    document.addEventListener('keydown', handleEsc);
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
                
                return () => {
                    document.removeEventListener('keydown', handleEsc);
                    document.body.style.overflow = '';
                };
            }, [isOpen, onClose]);
            
            // Click fuera del modal
            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };
            
            if (!isOpen) return null;
            
            const sizeClasses = {
                sm: 'max-w-sm',
                md: 'max-w-md',
                lg: 'max-w-lg',
                xl: 'max-w-xl',
                '2xl': 'max-w-2xl',
                '4xl': 'max-w-4xl',
                full: 'max-w-full'
            };
            
            return (
<div 
    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4 no-print"
                    onClick={handleBackdropClick}
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="modal-title"
                >
                    <div 
                        ref={modalRef}
                        className={`bg-white rounded-lg shadow-xl w-full ${sizeClasses[size]} max-h-[90vh] overflow-hidden flex flex-col ${className}`}
                    >
                        {title && (
                            <div className="flex justify-between items-center p-6 border-b">
                                <h3 id="modal-title" className="text-xl font-bold text-gray-900">{title}</h3>
                                {showCloseButton && (
                                    <button 
                                        onClick={onClose} 
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                        aria-label="Cerrar modal"
                                    >
                                        <Icon name="x" size={24} />
                                    </button>
                                )}
                            </div>
                        )}
                        <div className="flex-1 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ChangePasswordModal = ({ isOpen, onClose, currentUser }) => {
    const [currentPassword, setCurrentPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [success, setSuccess] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [showPasswords, setShowPasswords] = useState(false);
    const { db, showToast } = useContext(AppContext);
    
    // Resetear cuando se abre/cierra
    useEffect(() => {
        if (isOpen) {
            setCurrentPassword('');
            setNewPassword('');
            setConfirmPassword('');
            setError('');
            setSuccess(false);
            setShowPasswords(false);
        }
    }, [isOpen]);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Validaciones
        if (!currentPassword || !newPassword || !confirmPassword) {
            setError('Todos los campos son obligatorios');
            return;
        }
        
        if (newPassword.length < 6) {
            setError('La nueva contraseña debe tener al menos 6 caracteres');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            setError('Las contraseñas nuevas no coinciden');
            return;
        }
        
        if (currentPassword === newPassword) {
            setError('La nueva contraseña debe ser diferente a la actual');
            return;
        }
        
        setIsLoading(true);
        setError('');
        
        try {
            // Verificar contraseña actual en Firebase
            const userDoc = await db.collection('users').doc(currentUser.id).get();
            const userData = userDoc.data();
            
            if (userData.password !== currentPassword) {
                setError('La contraseña actual es incorrecta');
                setIsLoading(false);
                return;
            }
            
            // Actualizar contraseña
            await db.collection('users').doc(currentUser.id).update({
                password: newPassword,
                lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            setSuccess(true);
            showToast('¡Contraseña cambiada exitosamente!', 'success');
            
            // Cerrar modal después de 2 segundos
            setTimeout(() => {
                onClose();
            }, 2000);
            
        } catch (error) {
            console.error('Error al cambiar contraseña:', error);
            setError('Error al cambiar la contraseña. Intenta de nuevo.');
        } finally {
            setIsLoading(false);
        }
    };
    
    if (!isOpen) return null;
    
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="" size="sm">
            <div className="flex flex-col h-full">
                {/* Header minimalista */}
                <div className="bg-gray-50 border-b border-gray-200 p-6">
                    <div className="flex items-center justify-between">
                        <h2 className="text-xl font-semibold text-gray-800">Cambiar Contraseña</h2>
                        <button 
                            onClick={onClose}
                            className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                        >
                            <Icon name="x" size={20} className="text-gray-600" />
                        </button>
                    </div>
                </div>
                
                {/* Contenido */}
                <div className="flex-1 p-6">
                    {success ? (
                        <div className="text-center py-12">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icon name="checkCircle" size={40} className="text-green-500" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 mb-2">
                                ¡Contraseña actualizada!
                            </h3>
                            <p className="text-gray-600">Tu contraseña ha sido cambiada exitosamente.</p>
                        </div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Info del usuario */}
                            <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                <div className="flex items-center">
                                    <div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                                        <Icon name="user" size={24} className="text-gray-600" />
                                    </div>
                                    <div>
                                        <p className="font-semibold text-gray-900">{currentUser.name}</p>
                                        <p className="text-sm text-gray-500">Cambio de credenciales</p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Contraseña actual */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Contraseña actual
                                </label>
                                <div className="relative">
                                    <input
                                        type={showPasswords ? "text" : "password"}
                                        value={currentPassword}
                                        onChange={(e) => {
                                            setCurrentPassword(e.target.value);
                                            setError('');
                                        }}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-colors"
                                        placeholder="Ingresa tu contraseña actual"
                                        disabled={isLoading}
                                    />
                                    <Icon 
                                        name="lock" 
                                        size={20} 
                                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                                    />
                                </div>
                            </div>
                            
                            {/* Nueva contraseña */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Nueva contraseña
                                </label>
                                <div className="relative">
                                    <input
                                        type={showPasswords ? "text" : "password"}
                                        value={newPassword}
                                        onChange={(e) => {
                                            setNewPassword(e.target.value);
                                            setError('');
                                        }}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-colors"
                                        placeholder="Mínimo 6 caracteres"
                                        disabled={isLoading}
                                    />
                                    <Icon 
                                        name="key" 
                                        size={20} 
                                        className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                                    />
                                </div>
                                <p className="mt-1 text-xs text-gray-500">
                                    La contraseña debe tener al menos 6 caracteres
                                </p>
                            </div>
                            
                            {/* Confirmar contraseña */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Confirmar nueva contraseña
                                </label>
                                <div className="relative">
                                    <input
                                        type={showPasswords ? "text" : "password"}
                                        value={confirmPassword}
                                        onChange={(e) => {
                                            setConfirmPassword(e.target.value);
                                            setError('');
                                        }}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-colors"
                                        placeholder="Repite la nueva contraseña"
                                        disabled={isLoading}
                                    />
                                    <Icon 
                                        name="checkCircle" 
                                        size={20} 
                                        className={`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none transition-colors ${
                                            confirmPassword && newPassword === confirmPassword 
                                                ? 'text-green-500' 
                                                : 'text-gray-400'
                                        }`}
                                    />
                                </div>
                            </div>
                            
                            {/* Mostrar/ocultar contraseñas */}
                            <div className="flex items-center">
                                <input
                                    type="checkbox"
                                    id="showPasswords"
                                    checked={showPasswords}
                                    onChange={(e) => setShowPasswords(e.target.checked)}
                                    className="w-4 h-4 text-gray-800 border-gray-300 rounded focus:ring-gray-800"
                                />
                                <label htmlFor="showPasswords" className="ml-2 text-sm text-gray-600 cursor-pointer">
                                    Mostrar contraseñas
                                </label>
                            </div>
                            
                            {/* Error */}
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm flex items-center">
                                    <Icon name="alertCircle" size={16} className="mr-2 flex-shrink-0" />
                                    {error}
                                </div>
                            )}
                        </form>
                    )}
                </div>
                
                {/* Footer con botones */}
                {!success && (
                    <div className="bg-gray-50 border-t border-gray-200 px-6 py-4">
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                disabled={isLoading}
                                className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleSubmit}
                                disabled={isLoading || !currentPassword || !newPassword || !confirmPassword}
                                className="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 disabled:bg-gray-400 transition-colors flex items-center"
                            >
                                {isLoading ? (
                                    <>
                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                        </svg>
                                        Cambiando...
                                    </>
                                ) : (
                                    <>
                                        <Icon name="shield" size={16} className="mr-2" />
                                        Cambiar contraseña
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </Modal>
    );
};





// --- Modal para "Mis Revisitas y Estudios" ---
const MyActivityModal = ({ isOpen, onClose, onNavigateToDetail }) => {
    const { addresses, territories, currentUser, handleUpdateAddress } = useContext(AppContext);
    const { showToast } = useToast();
    
    // Estado para gestionar el modal de confirmación
    const [unmarkState, setUnmarkState] = useState({ isOpen: false, address: null, type: '' });

    // Lógica de filtrado y ordenamiento de datos
    const { studies, revisits } = useMemo(() => {
        if (!currentUser || addresses.length === 0) {
            return { studies: [], revisits: [] };
        }

        const myStudies = [];
        const myRevisits = new Map();

        addresses.forEach(addr => {
            const isMyStudy = addr.isEstudio && addr.estudioBy === currentUser.name;
            const isMyRevisit = addr.isRevisita && addr.revisitaBy === currentUser.name;

            if (isMyStudy) {
                myStudies.push(addr);
                if (myRevisits.has(addr.id)) {
                    myRevisits.delete(addr.id);
                }
            } else if (isMyRevisit) {
                if (!myStudies.some(s => s.id === addr.id)) {
                   myRevisits.set(addr.id, addr);
                }
            }
        });

        const addTerritoryInfo = (addrList) => addrList.map(addr => ({
            ...addr,
            territoryName: territories.find(t => t.id === addr.territoryId)?.name || 'N/D'
        }));
        
        const sortedStudies = myStudies.sort((a, b) => a.address.localeCompare(b.address, 'es', { numeric: true }));
        const sortedRevisits = Array.from(myRevisits.values()).sort((a, b) => a.address.localeCompare(b.address, 'es', { numeric: true }));

        return {
            studies: addTerritoryInfo(sortedStudies),
            revisits: addTerritoryInfo(sortedRevisits)
        };
    }, [addresses, territories, currentUser]);

    const totalItems = studies.length + revisits.length;

    const handleTerritoryClick = (territory) => {
        onClose();
        setTimeout(() => {
            onNavigateToDetail(territory);
        }, 150);
    };

    // Abre el modal de confirmación
    const handleUnmarkClick = (addressToUnmark, type) => {
        setUnmarkState({ isOpen: true, address: addressToUnmark, type: type });
    };

    // Ejecuta la acción de desmarcar
    const executeUnmark = async () => {
        const { address, type } = unmarkState;
        if (!address || !type) return;

        const updateData = type === 'study'
            ? { isEstudio: false, estudioBy: '' }
            : { isRevisita: false, revisitaBy: '' };

        try {
            await handleUpdateAddress(address.id, updateData);
            showToast(`La dirección ha sido liberada de tus ${type === 'study' ? 'estudios' : 'revisitas'}.`, 'success');
        } catch (error) {
            showToast('Error al liberar la dirección.', 'error');
        } finally {
            setUnmarkState({ isOpen: false, address: null, type: '' });
        }
    };

    if (!isOpen) return null;

    return (
        <>
            <div className="fixed inset-0 z-[70] bg-white flex flex-col">
                {/* Header */}
                <div className="bg-gray-50 border-b border-gray-200 p-6">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center">
                             <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                <i className="fas fa-bookmark text-2xl text-purple-600"></i>
                             </div>
                             <div>
                                <h2 className="text-xl font-semibold text-gray-800">Mis Revisitas y Estudios</h2>
                                <p className="text-sm text-gray-500">{totalItems > 0 ? `${totalItems} asignaciones activas` : 'No tienes asignaciones activas'}</p>
                             </div>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg transition-colors">
                            <Icon name="x" size={24} className="text-gray-600" />
                        </button>
                    </div>
                </div>

                {/* Contenido */}
                <div className="flex-1 overflow-y-auto bg-gray-50">
                    {totalItems === 0 ? (
                        <div className="p-6">
                            <div className="text-center mb-6 bg-white p-6 rounded-lg border">
                                 <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="map" size={32} className="text-gray-400" />
                                </div>
                                <h3 className="text-lg font-semibold text-gray-700">No tienes revisitas o estudios</h3>
                                <p className="text-sm text-gray-500 mt-1">
                                    Puedes explorar los territorios para marcar nuevas direcciones.
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="p-6 space-y-8">
                            {studies.length > 0 && (
                                <section>
                                    <h3 className="text-lg font-bold text-blue-700 mb-3 pb-2 border-b-2 border-blue-200 flex items-center">
                                        <i className="fas fa-book-open mr-3"></i>Estudios Bíblicos ({studies.length})
                                    </h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {studies.map(addr => <AddressCard key={addr.id} address={addr} viewMode="grid-full" isToggleVisitedEnabled={false} isEditEnabled={false} onUnmark={() => handleUnmarkClick(addr, 'study')} />)}
                                    </div>
                                </section>
                            )}
                            {revisits.length > 0 && (
                                <section>
                                    <h3 className="text-lg font-bold text-purple-700 mb-3 pb-2 border-b-2 border-purple-200 flex items-center">
                                        <i className="fas fa-bookmark mr-3"></i>Revisitas ({revisits.length})
                                    </h3>
                                    <div className="grid grid-cols-1 gap-4">
                                        {revisits.map(addr => <AddressCard key={addr.id} address={addr} viewMode="grid-full" isToggleVisitedEnabled={false} isEditEnabled={false} onUnmark={() => handleUnmarkClick(addr, 'revisit')} />)}
                                    </div>
                                </section>
                            )}
                        </div>
                    )}
                </div>
            </div>
            
            <ConfirmationModal
                isOpen={unmarkState.isOpen}
                onConfirm={executeUnmark}
                onCancel={() => setUnmarkState({ isOpen: false, address: null, type: '' })}
                title={`¿Liberar ${unmarkState.type === 'study' ? 'Estudio' : 'Revisita'}?`}
                message={`¿Estás seguro de que quieres quitar esta dirección de tu lista de ${unmarkState.type === 'study' ? 'estudios' : 'revisitas'}? La dirección no se eliminará del territorio.`}
                confirmText="Sí, liberar"
                type="warning"
            />
        </>
    );
};

const ConfirmationModal = ({ 
            isOpen, 
            onConfirm, 
            onCancel,
            title, 
            message, 
            confirmText = "Confirmar", 
            cancelText = "Cancelar", 
            type = "warning",
            isLoading = false 
        }) => {
            const colors = {
                warning: {
                    bg: 'bg-yellow-100',
                    text: 'text-yellow-800',
                    button: 'bg-yellow-600 hover:bg-yellow-700',
                    icon: 'alertCircle'
                },
                danger: {
                    bg: 'bg-red-100',
                    text: 'text-red-800',
                    button: 'bg-red-600 hover:bg-red-700',
                    icon: 'alertCircle'
                },
                info: {
                    bg: 'bg-blue-100',
                    text: 'text-blue-800',
                    button: 'bg-blue-600 hover:bg-blue-700',
                    icon: 'info'
                },
                success: {
                    bg: 'bg-green-100',
                    text: 'text-green-800',
                    button: 'bg-green-600 hover:bg-green-700',
                    icon: 'checkCircle'
                }
            };
            
            const colorScheme = colors[type] || colors.warning;
            
            return (
                <Modal isOpen={isOpen} onClose={onCancel} size="sm" showCloseButton={false}>
                    <div className="p-6">
                        <div className={`p-4 rounded-lg mb-4 ${colorScheme.bg} ${colorScheme.text} flex items-start`}>
                            <Icon name={colorScheme.icon} size={24} className="mr-3 mt-0.5" />
                            <div>
                                <h3 className="text-lg font-semibold mb-1">{title}</h3>
                                <p className="text-sm">{message}</p>
                            </div>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={onCancel}
                                disabled={isLoading}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50"
                            >
                                {cancelText}
                            </button>
                            <button
                                onClick={onConfirm}
                                disabled={isLoading}
                                className={`px-4 py-2 rounded-md text-white transition-colors disabled:opacity-50 ${colorScheme.button}`}
                            >
                                {isLoading ? (
                                    <span className="flex items-center">
                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                        </svg>
                                        Procesando...
                                    </span>
                                ) : confirmText}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

const ReportsModal = ({ isOpen, onClose }) => {
    const { territories, addresses, territoryHistory } = useContext(AppContext);
    const { showToast } = useToast();
    const [reportType, setReportType] = useState('active');
    const [selectedPublisher, setSelectedPublisher] = useState('');
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    const [isGenerating, setIsGenerating] = useState(false);
    const [showFilters, setShowFilters] = useState(false);
    const [exportMenuOpen, setExportMenuOpen] = useState(false);
    
    // Estados específicos para S-13
    const [s13DateRange, setS13DateRange] = useState({
        start: new Date(new Date().getFullYear(), new Date().getMonth() - 3, 1).toISOString().slice(0, 10),
        end: new Date().toISOString().slice(0, 10)
    });
    
    // Hook para detectar si es móvil
    const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
    
    useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);
    
    // Funciones utilitarias necesarias
    const formatDate = (date, options = {}) => {
        if (!date) return 'N/A';
        const d = date.toDate ? date.toDate() : new Date(date);
        
        if (isNaN(d.getTime())) return 'Fecha inválida';
        
        const defaultOptions = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            ...options
        };
        
        return d.toLocaleDateString('es-MX', defaultOptions);
    };
    
    const formatShortDate = (date) => {
        if (!date) return 'N/A';
        const d = date.toDate ? date.toDate() : new Date(date);
        
        if (isNaN(d.getTime())) return 'Fecha inválida';
        
        return d.toLocaleDateString('es-MX', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    };
    
    const normalizeText = (text) => {
        if (!text) return '';
        return text
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .trim();
    };
    
    // Función mejorada para generar reportes
    const generateReport = useCallback(() => {
        switch (reportType) {
            case 'active':
                return generateActiveReport();
            case 'history':
                return generateHistoryReport();
            case 'publisher':
                return generatePublisherReport();
            case 's13':
                return generateS13Report();
            default:
                return [];
        }
    }, [reportType, territories, addresses, territoryHistory, selectedPublisher, dateRange, s13DateRange]);
    
    const generateActiveReport = () => {
        return territories
            .filter(t => t.status === 'En uso')
            .map(territory => {
                const territoryAddresses = addresses.filter(a => a.territoryId === territory.id);
                const visitedCount = territoryAddresses.filter(a => a.isVisited).length;
                const totalCount = territoryAddresses.length;
                const progress = totalCount > 0 ? (visitedCount / totalCount * 100).toFixed(1) : 0;
                
                return {
                    ...territory,
                    visitedCount,
                    totalCount,
                    progress,
                    daysSinceAssigned: territory.assignedDate ? 
                        Math.floor((new Date() - territory.assignedDate.toDate()) / (1000 * 60 * 60 * 24)) : 0
                };
            })
            .sort((a, b) => b.daysSinceAssigned - a.daysSinceAssigned);
    };
    
    const generateHistoryReport = () => {
        let report = territoryHistory || [];
        
        if (dateRange.start || dateRange.end) {
            report = report.filter(record => {
                const recordDate = record.assignedDate?.toDate() || new Date();
                const start = dateRange.start ? new Date(dateRange.start) : new Date('1900-01-01');
                const end = dateRange.end ? new Date(dateRange.end) : new Date();
                end.setHours(23, 59, 59, 999);
                return recordDate >= start && recordDate <= end;
            });
        }
        
        if (selectedPublisher) {
            const normalizedSearch = normalizeText(selectedPublisher);
            report = report.filter(record => 
                normalizeText(record.assignedTo || '').includes(normalizedSearch)
            );
        }
        
        return report.sort((a, b) => {
            const dateA = a.assignedDate?.toDate() || new Date();
            const dateB = b.assignedDate?.toDate() || new Date();
            return dateB - dateA;
        });
    };
    
    const generatePublisherReport = () => {
        const publisherStats = {};
        
        (territoryHistory || []).forEach(record => {
            const publisher = record.assignedTo || 'Sin asignar';
            if (!publisherStats[publisher]) {
                publisherStats[publisher] = {
                    name: publisher,
                    totalAssignments: 0,
                    completedTerritories: 0,
                    averageDays: [],
                    territories: [],
                    currentlyAssigned: 0
                };
            }
            
            publisherStats[publisher].totalAssignments++;
            
            if (record.status === 'Terminado') {
                publisherStats[publisher].completedTerritories++;
            }
            
            if (record.completedDate && record.assignedDate) {
                const days = Math.floor((record.completedDate.toDate() - record.assignedDate.toDate()) / (1000 * 60 * 60 * 24));
                publisherStats[publisher].averageDays.push(days);
            }
            
            publisherStats[publisher].territories.push({
                name: record.territoryName,
                date: record.assignedDate,
                status: record.status
            });
        });
        
        // Contar territorios actualmente asignados
        territories.forEach(territory => {
            if (territory.status === 'En uso' && territory.assignedTo) {
                if (publisherStats[territory.assignedTo]) {
                    publisherStats[territory.assignedTo].currentlyAssigned++;
                }
            }
        });
        
        // Calcular promedios
        Object.values(publisherStats).forEach(stat => {
            if (stat.averageDays.length > 0) {
                stat.averageCompletionDays = Math.round(
                    stat.averageDays.reduce((a, b) => a + b, 0) / stat.averageDays.length
                );
            } else {
                stat.averageCompletionDays = 'N/A';
            }
        });
        
        return Object.values(publisherStats).sort((a, b) => b.totalAssignments - a.totalAssignments);
    };
    
    // Nueva función para generar reporte S-13
    const generateS13Report = () => {
        const start = new Date(s13DateRange.start);
        const end = new Date(s13DateRange.end);
        end.setHours(23, 59, 59, 999);
        
        // Agrupar por territorio para obtener todas las asignaciones en el rango
        const territoryAssignments = {};
        
        // Procesar el historial
        (territoryHistory || []).forEach(record => {
            if (!record.assignedDate) return;
            
            const assignedDate = record.assignedDate.toDate();
            
            // Verificar si la asignación está en el rango de fechas
            if (assignedDate >= start && assignedDate <= end) {
                const territoryKey = record.territoryId || record.territoryName;
                
                if (!territoryAssignments[territoryKey]) {
                    territoryAssignments[territoryKey] = [];
                }
                
                territoryAssignments[territoryKey].push({
                    territoryName: record.territoryName,
                    territoryId: record.territoryId,
                    assignedTo: record.assignedTo || 'No especificado',
                    assignedDate: record.assignedDate,
                    completedDate: record.completedDate || null,
                    status: record.status
                });
            }
        });
        
        // También incluir territorios actualmente asignados si fueron asignados en el rango
        territories.forEach(territory => {
            if (territory.status === 'En uso' && territory.assignedDate) {
                const assignedDate = territory.assignedDate.toDate();
                
                if (assignedDate >= start && assignedDate <= end) {
                    const territoryKey = territory.id;
                    
                    // Verificar si ya no está en la lista (para evitar duplicados)
                    const existingRecords = territoryAssignments[territoryKey] || [];
                    const hasCurrentAssignment = existingRecords.some(r => 
                        r.assignedTo === territory.assignedTo && 
                        r.assignedDate.toDate().getTime() === assignedDate.getTime()
                    );
                    
                    if (!hasCurrentAssignment) {
                        if (!territoryAssignments[territoryKey]) {
                            territoryAssignments[territoryKey] = [];
                        }
                        
                        territoryAssignments[territoryKey].push({
                            territoryName: territory.name,
                            territoryId: territory.id,
                            assignedTo: territory.assignedTo,
                            assignedDate: territory.assignedDate,
                            completedDate: null,
                            status: 'En uso'
                        });
                    }
                }
            }
        });
        
        // Convertir a array plano y ordenar
        const flatReport = [];
        Object.entries(territoryAssignments).forEach(([territoryKey, assignments]) => {
            assignments.forEach(assignment => {
                flatReport.push(assignment);
            });
        });
        
        // Ordenar por número de territorio y luego por fecha de asignación
        return flatReport.sort((a, b) => {
            // Manejar casos donde territoryName puede ser undefined
            const nameA = a.territoryName || '';
            const nameB = b.territoryName || '';
            
            const territoryCompare = nameA.localeCompare(nameB, undefined, { numeric: true });
            if (territoryCompare !== 0) return territoryCompare;
            
            const dateA = a.assignedDate?.toDate() || new Date();
            const dateB = b.assignedDate?.toDate() || new Date();
            return dateA - dateB;
        });
    };
    
    const handlePrint = () => {
        window.print();
        showToast('Reporte listo para imprimir', 'success');
    };
    
    const handleExportCSV = async () => {
        setIsGenerating(true);
        try {
            let csvContent = '\uFEFF'; // BOM para UTF-8
            const data = generateReport();
            
            switch (reportType) {
                case 'active':
                    csvContent += 'Territorio,Asignado a,Fecha Asignación,Días Transcurridos,Progreso,Visitadas,Total\n';
                    data.forEach(t => {
                        csvContent += `"${t.name}","${t.assignedTo}","${formatShortDate(t.assignedDate)}",${t.daysSinceAssigned},${t.progress}%,${t.visitedCount},${t.totalCount}\n`;
                    });
                    break;
                case 'history':
                    csvContent += 'Territorio,Publicador,Fecha Asignación,Estado\n';
                    data.forEach(r => {
                        csvContent += `"${r.territoryName}","${r.assignedTo || 'N/A'}","${formatShortDate(r.assignedDate)}","${r.status}"\n`;
                    });
                    break;
                case 'publisher':
                    csvContent += 'Publicador,Total Asignaciones,Territorios Completados,Asignados Actualmente,Promedio Días\n';
                    data.forEach(p => {
                        csvContent += `"${p.name}",${p.totalAssignments},${p.completedTerritories},${p.currentlyAssigned},${p.averageCompletionDays}\n`;
                    });
                    break;
                case 's13':
                    csvContent += 'Número de Territorio,Asignado a,Fecha de Asignación,Fecha de Completación,Estado\n';
                    data.forEach(r => {
                        const completedDate = r.completedDate ? formatShortDate(r.completedDate) : 'En proceso';
                        csvContent += `"${r.territoryName}","${r.assignedTo}","${formatShortDate(r.assignedDate)}","${completedDate}","${r.status}"\n`;
                    });
                    break;
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte-${reportType}-${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Reporte exportado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar:', error);
            showToast('Error al exportar el reporte', 'error');
        } finally {
            setIsGenerating(false);
        }
    };
    
    // Nueva función para exportar a Excel
    const handleExportExcel = async () => {
        setIsGenerating(true);
        try {
// Verificar si XLSX está disponible y cargarlo si no existe
if (typeof XLSX === 'undefined') {
    showToast('Cargando librería de Excel...', 'info');
    
    try {
        // Cargar XLSX dinámicamente
        await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
        
        // Pequeña pausa para asegurar que XLSX esté completamente cargado
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Verificar nuevamente
        if (typeof XLSX === 'undefined') {
            showToast('Error al cargar la librería de Excel', 'error');
            return;
        }
    } catch (error) {
        console.error('Error cargando XLSX:', error);
        showToast('Error al cargar la librería de Excel', 'error');
        return;
    }
}
            
            const data = generateReport();
            
            // Preparar datos para Excel según el tipo de reporte
            let worksheetData = [];
            let sheetName = '';
            
            if (reportType === 's13') {
                sheetName = 'Formulario S-13';
                // Headers
                worksheetData.push([
                    'Número de Territorio',
                    'Asignado a',
                    'Fecha de Asignación',
                    'Fecha de Completación',
                    'Días en Campo',
                    'Estado'
                ]);
                
                // Data
                data.forEach(r => {
                    const assignedDate = r.assignedDate?.toDate() || new Date();
                    const completedDate = r.completedDate?.toDate();
                    const daysInField = completedDate 
                        ? Math.floor((completedDate - assignedDate) / (1000 * 60 * 60 * 24))
                        : Math.floor((new Date() - assignedDate) / (1000 * 60 * 60 * 24));
                    
                    worksheetData.push([
                        r.territoryName,
                        r.assignedTo,
                        formatShortDate(r.assignedDate),
                        completedDate ? formatShortDate(r.completedDate) : 'En proceso',
                        daysInField,
                        r.status
                    ]);
                });
            } else if (reportType === 'active') {
                sheetName = 'Territorios Activos';
                worksheetData.push(['Territorio', 'Asignado a', 'Fecha Asignación', 'Días', 'Progreso %', 'Visitadas', 'Total']);
                data.forEach(t => {
                    worksheetData.push([
                        t.name,
                        t.assignedTo,
                        formatShortDate(t.assignedDate),
                        t.daysSinceAssigned,
                        parseFloat(t.progress),
                        t.visitedCount,
                        t.totalCount
                    ]);
                });
            } else if (reportType === 'history') {
                sheetName = 'Historial';
                worksheetData.push(['Territorio', 'Publicador', 'Fecha Asignación', 'Estado']);
                data.forEach(r => {
                    worksheetData.push([
                        r.territoryName,
                        r.assignedTo || 'N/A',
                        formatShortDate(r.assignedDate),
                        r.status
                    ]);
                });
            } else if (reportType === 'publisher') {
                sheetName = 'Por Publicador';
                worksheetData.push(['Publicador', 'Total Asignaciones', 'Completados', 'En Proceso', 'Promedio Días']);
                data.forEach(p => {
                    worksheetData.push([
                        p.name,
                        p.totalAssignments,
                        p.completedTerritories,
                        p.currentlyAssigned,
                        p.averageCompletionDays
                    ]);
                });
            }
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Ajustar anchos de columna
            const colWidths = worksheetData[0].map((_, colIndex) => {
                const maxLength = Math.max(...worksheetData.map(row => 
                    String(row[colIndex] || '').length
                ));
                return { wch: Math.min(maxLength + 2, 30) };
            });
            ws['!cols'] = colWidths;
            
            // Agregar hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Agregar información adicional en una segunda hoja si es S-13
            if (reportType === 's13') {
                const infoSheet = [
                    ['Reporte S-13 - Registro de Asignaciones de Territorio'],
                    [''],
                    ['Congregación:', 'LS Coyoacán'],
                    ['Período:', `${formatDate(new Date(s13DateRange.start))} - ${formatDate(new Date(s13DateRange.end))}`],
                    ['Fecha de generación:', formatDate(new Date())],
                    ['Total de asignaciones:', data.length]
                ];
                
                const wsInfo = XLSX.utils.aoa_to_sheet(infoSheet);
                XLSX.utils.book_append_sheet(wb, wsInfo, 'Información');
            }
            
            // Escribir archivo
            const fileName = reportType === 's13' 
                ? `S-13_${new Date().toISOString().slice(0, 10)}.xlsx`
                : `reporte-${reportType}-${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            
            showToast('Reporte Excel generado correctamente', 'success');
        } catch (error) {
            console.error('Error al exportar Excel:', error);
            showToast('Error al generar el archivo Excel', 'error');
        } finally {
            setIsGenerating(false);
        }
    };
    
    // Nueva función para exportar a PDF
    const handleExportPDF = async () => {
        setIsGenerating(true);
        try {
            // Crear script para jsPDF si no existe
            if (!window.jspdf) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                // Cargar también autotable para tablas
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = generateReport();
            
            // Configurar PDF según el tipo de reporte
            if (reportType === 's13') {
                // Título del documento
                doc.setFontSize(16);
                doc.text('Formulario S-13', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text('Registro de Asignaciones de Territorio', 105, 28, { align: 'center' });
                
                // Información del encabezado
                doc.setFontSize(10);
                doc.text(`Congregación: LS Coyoacán`, 14, 40);
                doc.text(`Período: ${formatDate(new Date(s13DateRange.start))} - ${formatDate(new Date(s13DateRange.end))}`, 14, 46);
                doc.text(`Fecha: ${formatDate(new Date())}`, 14, 52);
                
                // Preparar datos para la tabla
                const tableData = data.map(r => {
                    const completedDate = r.completedDate ? formatShortDate(r.completedDate) : 'En proceso';
                    const assignedDate = r.assignedDate?.toDate() || new Date();
                    const completed = r.completedDate?.toDate();
                    const daysInField = completed 
                        ? Math.floor((completed - assignedDate) / (1000 * 60 * 60 * 24))
                        : Math.floor((new Date() - assignedDate) / (1000 * 60 * 60 * 24));
                    
                    return [
                        r.territoryName,
                        r.assignedTo,
                        formatShortDate(r.assignedDate),
                        completedDate,
                        `${daysInField} días`
                    ];
                });
                
                // Generar tabla
                doc.autoTable({
                    head: [['Territorio', 'Asignado a', 'Fecha Asignación', 'Fecha Completación', 'Tiempo']],
                    body: tableData,
                    startY: 60,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [79, 70, 229] }
                });
            } else {
                // Para otros tipos de reporte
                doc.setFontSize(14);
                doc.text(`Reporte de ${reportType === 'active' ? 'Territorios Activos' : reportType === 'history' ? 'Historial' : 'Publicadores'}`, 14, 20);
                
                let tableData = [];
                let headers = [];
                
                if (reportType === 'active') {
                    headers = ['Territorio', 'Asignado a', 'Días', 'Progreso'];
                    tableData = data.map(t => [
                        t.name,
                        t.assignedTo,
                        t.daysSinceAssigned,
                        `${t.progress}%`
                    ]);
                } else if (reportType === 'history') {
                    headers = ['Territorio', 'Publicador', 'Fecha', 'Estado'];
                    tableData = data.map(r => [
                        r.territoryName,
                        r.assignedTo || 'N/A',
                        formatShortDate(r.assignedDate),
                        r.status
                    ]);
                } else if (reportType === 'publisher') {
                    headers = ['Publicador', 'Asignaciones', 'Completados', 'En Proceso'];
                    tableData = data.map(p => [
                        p.name,
                        p.totalAssignments,
                        p.completedTerritories,
                        p.currentlyAssigned
                    ]);
                }
                
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: 30
                });
            }
            
            // Guardar PDF
            const fileName = reportType === 's13' 
                ? `S-13_${new Date().toISOString().slice(0, 10)}.pdf`
                : `reporte-${reportType}-${new Date().toISOString().slice(0, 10)}.pdf`;
            
            doc.save(fileName);
            
            showToast('PDF generado correctamente', 'success');
        } catch (error) {
            console.error('Error al generar PDF:', error);
            showToast('Error al generar el PDF', 'error');
        } finally {
            setIsGenerating(false);
        }
    };
    
    const reportData = useMemo(() => generateReport(), [generateReport]);
    
    // Componente para tabla responsiva
    const ResponsiveTable = ({ data, type }) => {
        if (isMobile) {
            // Vista de tarjetas para móvil
            return (
                <div className="space-y-3">
                    {data.map((item, idx) => (
                        <div key={idx} className="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
                            {type === 'active' && (
                                <>
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="font-semibold text-gray-900">{item.name}</h4>
                                        <span className={`text-xs px-2 py-1 rounded-full font-medium ${
                                            item.daysSinceAssigned > 120 ? 'bg-red-100 text-red-700' :
                                            item.daysSinceAssigned > 90 ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-green-100 text-green-700'
                                        }`}>
                                            {item.daysSinceAssigned} días
                                        </span>
                                    </div>
                                    <p className="text-sm text-gray-600 mb-2">
                                        <Icon name="user" size={14} className="inline mr-1" />
                                        {item.assignedTo}
                                    </p>
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs text-gray-500">
                                            {formatShortDate(item.assignedDate)}
                                        </span>
                                        <div className="flex items-center">
                                            <div className="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                                <div 
                                                    className="bg-gray-800 h-2 rounded-full transition-all"
                                                    style={{ width: `${item.progress}%` }}
                                                />
                                            </div>
                                            <span className="text-sm font-medium">{item.progress}%</span>
                                        </div>
                                    </div>
                                </>
                            )}
                            
                            {type === 'history' && (
                                <>
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="font-semibold text-gray-900">{item.territoryName}</h4>
                                        <span className={`text-xs px-2 py-1 rounded-full font-medium ${
                                            item.status === 'Terminado' ? 'bg-green-100 text-green-700' :
                                            item.status === 'En uso' ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-gray-100 text-gray-700'
                                        }`}>
                                            {item.status}
                                        </span>
                                    </div>
                                    <p className="text-sm text-gray-600">
                                        <Icon name="user" size={14} className="inline mr-1" />
                                        {item.assignedTo || 'N/A'}
                                    </p>
                                    <p className="text-xs text-gray-500 mt-1">
                                        {formatShortDate(item.assignedDate)}
                                    </p>
                                </>
                            )}
                            
                            {type === 's13' && (
                                <>
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="font-semibold text-gray-900">{item.territoryName}</h4>
                                        {item.completedDate ? (
                                            <Icon name="checkCircle" size={16} className="text-green-600" />
                                        ) : (
                                            <Icon name="clock" size={16} className="text-yellow-600" />
                                        )}
                                    </div>
                                    <p className="text-sm text-gray-600 mb-1">
                                        <Icon name="user" size={14} className="inline mr-1" />
                                        {item.assignedTo}
                                    </p>
                                    <div className="flex justify-between items-end">
                                        <div className="text-xs text-gray-500">
                                            <p>Asignado: {formatShortDate(item.assignedDate)}</p>
                                            {item.completedDate && (
                                                <p>Completado: {formatShortDate(item.completedDate)}</p>
                                            )}
                                        </div>
                                        <span className={`text-xs px-2 py-1 rounded-full font-medium ${
                                            (() => {
                                                const assignedDate = item.assignedDate?.toDate() || new Date();
                                                const completedDate = item.completedDate?.toDate();
                                                const days = completedDate 
                                                    ? Math.floor((completedDate - assignedDate) / (1000 * 60 * 60 * 24))
                                                    : Math.floor((new Date() - assignedDate) / (1000 * 60 * 60 * 24));
                                                return days > 120 ? 'bg-red-100 text-red-700' :
                                                       days > 90 ? 'bg-yellow-100 text-yellow-700' :
                                                       'bg-green-100 text-green-700';
                                            })()
                                        }`}>
                                            {(() => {
                                                const assignedDate = item.assignedDate?.toDate() || new Date();
                                                const completedDate = item.completedDate?.toDate();
                                                const days = completedDate 
                                                    ? Math.floor((completedDate - assignedDate) / (1000 * 60 * 60 * 24))
                                                    : Math.floor((new Date() - assignedDate) / (1000 * 60 * 60 * 24));
                                                return `${days} días`;
                                            })()}
                                        </span>
                                    </div>
                                </>
                            )}
                        </div>
                    ))}
                </div>
            );
        }
        
        // Vista de tabla para escritorio
        if (type === 'active') {
            return (
                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territorio</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignado a</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Días</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progreso</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {data.map((territory, idx) => (
                                <tr key={idx} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{territory.name}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{territory.assignedTo}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatShortDate(territory.assignedDate)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                            territory.daysSinceAssigned > 120 ? 'bg-red-100 text-red-800' :
                                            territory.daysSinceAssigned > 90 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }`}>
                                            {territory.daysSinceAssigned} días
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <div className="flex items-center">
                                            <div className="flex-1 bg-gray-200 rounded-full h-2 mr-2 max-w-[100px]">
                                                <div 
                                                    className="bg-gray-800 h-2 rounded-full transition-all duration-300"
                                                    style={{ width: `${territory.progress}%` }}
                                                />
                                            </div>
                                            <span className="text-sm text-gray-900 font-medium">{territory.progress}%</span>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }
        
        if (type === 'history') {
            return (
                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territorio</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Publicador</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Asignación</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {data.map((record, idx) => (
                                <tr key={idx} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{record.territoryName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{record.assignedTo || 'N/A'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatShortDate(record.assignedDate)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                            record.status === 'Terminado' ? 'bg-green-100 text-green-800' :
                                            record.status === 'En uso' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-gray-100 text-gray-800'
                                        }`}>
                                            {record.status}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }
        
        if (type === 's13') {
            return (
                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-indigo-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Número de Territorio</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Asignado a</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Fecha de Asignación</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Fecha de Completación</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Días en Campo</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {data.map((record, idx) => {
                                const assignedDate = record.assignedDate?.toDate() || new Date();
                                const completedDate = record.completedDate?.toDate();
                                const daysInField = completedDate 
                                    ? Math.floor((completedDate - assignedDate) / (1000 * 60 * 60 * 24))
                                    : Math.floor((new Date() - assignedDate) / (1000 * 60 * 60 * 24));
                                
                                return (
                                    <tr key={idx} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{record.territoryName}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{record.assignedTo}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatShortDate(record.assignedDate)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {completedDate ? (
                                                <span className="text-green-700 font-medium">{formatShortDate(record.completedDate)}</span>
                                            ) : (
                                                <span className="text-yellow-600 italic">En proceso</span>
                                            )}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                daysInField > 120 ? 'bg-red-100 text-red-800' :
                                                daysInField > 90 ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-green-100 text-green-800'
                                            }`}>
                                                {daysInField} días
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        }
        
        return null;
    };
    
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="" size="4xl">
            <div className="flex flex-col h-full max-h-[90vh]">
                {/* Header mejorado y responsivo */}
                <div className="bg-gray-50 border-b border-gray-200 p-4 sm:p-6 pb-0 flex-shrink-0">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg sm:text-xl font-semibold text-gray-800">Reportes de Territorios</h2>
                        <button 
                            onClick={onClose}
                            className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                        >
                            <Icon name="x" size={20} className="text-gray-600" />
                        </button>
                    </div>
                    
                    {/* Tabs responsivos mejorados */}
                    <div className="flex overflow-x-auto pb-px -mx-4 sm:mx-0 px-4 sm:px-0" style={{ scrollbarWidth: 'none', '-ms-overflow-style': 'none', '::-webkit-scrollbar': { display: 'none' } }}>
                        <div className="flex space-x-1 min-w-max">
                            {[
                                { id: 'active', label: 'Activos', icon: 'activity' },
                                { id: 'history', label: 'Historial', icon: 'clock' },
                                { id: 'publisher', label: 'Publicadores', icon: 'users' },
                                { id: 's13', label: 'S-13', icon: 'fileText' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setReportType(tab.id)}
                                    className={`flex items-center gap-1.5 px-3 sm:px-4 py-2.5 sm:py-3 font-medium text-xs sm:text-sm whitespace-nowrap transition-all border-b-2 ${
                                        reportType === tab.id 
                                            ? 'text-gray-900 border-gray-800 bg-white' 
                                            : 'text-gray-500 border-transparent hover:text-gray-700'
                                    }`}
                                >
                                    <Icon name={tab.icon} size={16} className={isMobile ? 'hidden' : ''} />
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
                
                {/* Filtros colapsables para móvil */}
                {(reportType === 'history' || reportType === 's13') && (
                    <div className={`bg-gray-50 border-b border-gray-200 ${isMobile ? 'px-4 py-3' : 'px-6 py-4'}`}>
                        {isMobile && (
                            <button
                                onClick={() => setShowFilters(!showFilters)}
                                className="flex items-center justify-between w-full text-sm font-medium text-gray-700 mb-3"
                            >
                                <span className="flex items-center">
                                    <Icon name="filter" size={16} className="mr-2" />
                                    Filtros
                                </span>
                                <Icon name={showFilters ? 'chevronUp' : 'chevronDown'} size={16} />
                            </button>
                        )}
                        
                        <div className={`${isMobile && !showFilters ? 'hidden' : ''}`}>
                            {reportType === 'history' && (
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Publicador</label>
                                        <input
                                            type="text"
                                            value={selectedPublisher}
                                            onChange={(e) => setSelectedPublisher(e.target.value)}
                                            placeholder="Buscar..."
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                                        <input
                                            type="date"
                                            value={dateRange.start}
                                            onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                                        <input
                                            type="date"
                                            value={dateRange.end}
                                            onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent text-sm"
                                        />
                                    </div>
                                </div>
                            )}
                            
                            {reportType === 's13' && (
                                <div className="bg-blue-50 p-3 sm:p-4 rounded-lg">
                                    <div className="flex items-center mb-2 sm:mb-3">
                                        <Icon name="calendar" size={18} className="text-blue-600 mr-2" />
                                        <h3 className="font-semibold text-blue-900 text-sm sm:text-base">Período del Reporte S-13</h3>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-blue-700 mb-1">Desde</label>
                                            <input
                                                type="date"
                                                value={s13DateRange.start}
                                                onChange={(e) => setS13DateRange(prev => ({ ...prev, start: e.target.value }))}
                                                className="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-blue-700 mb-1">Hasta</label>
                                            <input
                                                type="date"
                                                value={s13DateRange.end}
                                                onChange={(e) => setS13DateRange(prev => ({ ...prev, end: e.target.value }))}
                                                className="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {/* Contenido del reporte - scrolleable y responsivo */}
                <div className="flex-1 overflow-y-auto p-4 sm:p-6 bg-white">
                    {reportType === 'active' && (
                        <div className="space-y-4">
                            {reportData.length > 0 ? (
                                <ResponsiveTable data={reportData} type="active" />
                            ) : (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <Icon name="activity" size={48} className="text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-600 font-medium">No hay territorios activos</p>
                                    <p className="text-sm text-gray-500 mt-2">Los territorios asignados aparecerán aquí</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {reportType === 'history' && (
                        <div className="space-y-4">
                            {reportData.length > 0 ? (
                                <ResponsiveTable data={reportData} type="history" />
                            ) : (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <Icon name="clock" size={48} className="text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-600 font-medium">No se encontraron registros</p>
                                    <p className="text-sm text-gray-500 mt-2">Ajusta los filtros para ver resultados</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {reportType === 'publisher' && (
                        <div className="space-y-4">
                            {reportData.length > 0 ? (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {reportData.map((publisher, idx) => (
                                        <div key={idx} className="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 hover:border-gray-300 hover:shadow-sm transition-all">
                                            <div className="flex items-center mb-4">
                                                <div className="w-10 h-10 sm:w-12 sm:h-12 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                                    <Icon name="user" size={20} className="text-gray-600" />
                                                </div>
                                                <h5 className="font-semibold text-gray-900 text-base sm:text-lg">{publisher.name}</h5>
                                            </div>
                                            
                                            <div className="space-y-2 sm:space-y-3">
                                                <div className="flex justify-between items-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                                                    <span className="text-xs sm:text-sm text-gray-600">Total</span>
                                                    <span className="text-base sm:text-lg font-bold text-gray-900">{publisher.totalAssignments}</span>
                                                </div>
                                                
                                                <div className="flex justify-between items-center p-2 sm:p-3 bg-green-50 rounded-lg">
                                                    <span className="text-xs sm:text-sm text-green-700">Completados</span>
                                                    <span className="text-base sm:text-lg font-bold text-green-700">{publisher.completedTerritories}</span>
                                                </div>
                                                
                                                <div className="flex justify-between items-center p-2 sm:p-3 bg-yellow-50 rounded-lg">
                                                    <span className="text-xs sm:text-sm text-yellow-700">En proceso</span>
                                                    <span className="text-base sm:text-lg font-bold text-yellow-700">{publisher.currentlyAssigned}</span>
                                                </div>
                                                
                                                <div className="flex justify-between items-center p-2 sm:p-3 bg-blue-50 rounded-lg">
                                                    <span className="text-xs sm:text-sm text-blue-700">Promedio días</span>
                                                    <span className="text-base sm:text-lg font-bold text-blue-700">{publisher.averageCompletionDays}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <Icon name="users" size={48} className="text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-600 font-medium">No hay datos de publicadores</p>
                                    <p className="text-sm text-gray-500 mt-2">Los datos aparecerán cuando haya actividad</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {reportType === 's13' && (
                        <div className="space-y-4">
                            {reportData.length > 0 ? (
                                <>
                                    {/* Resumen del período */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <h4 className="font-semibold text-blue-900 text-sm sm:text-base">Período del Reporte</h4>
                                                <p className="text-xs sm:text-sm text-blue-700">
                                                    {formatDate(new Date(s13DateRange.start))} - {formatDate(new Date(s13DateRange.end))}
                                                </p>
                                            </div>
                                            <div className="text-left sm:text-right">
                                                <p className="text-2xl font-bold text-blue-900">{reportData.length}</p>
                                                <p className="text-xs sm:text-sm text-blue-700">Asignaciones</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Tabla S-13 */}
                                    <ResponsiveTable data={reportData} type="s13" />
                                </>
                            ) : (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <Icon name="fileText" size={48} className="text-gray-300 mx-auto mb-4" />
                                    <p className="text-gray-600 font-medium">No hay asignaciones en este período</p>
                                    <p className="text-sm text-gray-500 mt-2">Ajusta las fechas para ver asignaciones</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
                
                {/* Footer con acciones - siempre visible y responsivo */}
                <div className="bg-gray-50 border-t border-gray-200 p-4 sm:px-6 sm:py-4 flex-shrink-0">
                    {isMobile ? (
                        // Vista móvil con menú de exportación flotante
                        <div className="relative">
                            <button
                                onClick={() => setExportMenuOpen(!exportMenuOpen)}
                                disabled={reportData.length === 0}
                                className="w-full bg-gray-800 text-white font-medium py-3 px-4 rounded-lg hover:bg-gray-900 disabled:bg-gray-400 transition-colors flex items-center justify-center"
                            >
                                <Icon name="download" size={16} className="mr-2" />
                                Exportar Reporte
                            </button>
                            
                            {exportMenuOpen && reportData.length > 0 && (
                                <>
                                    <div 
                                        className="fixed inset-0 z-40" 
                                        onClick={() => setExportMenuOpen(false)}
                                    />
                                    <div className="absolute bottom-full left-0 right-0 mb-2 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                        <button
                                            onClick={() => {
                                                handlePrint();
                                                setExportMenuOpen(false);
                                            }}
                                            className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center border-b border-gray-200"
                                        >
                                            <Icon name="printer" size={16} className="mr-3 text-gray-600" />
                                            <span>Imprimir</span>
                                        </button>
                                        <button
                                            onClick={() => {
                                                handleExportCSV();
                                                setExportMenuOpen(false);
                                            }}
                                            disabled={isGenerating}
                                            className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center border-b border-gray-200"
                                        >
                                            <Icon name="fileText" size={16} className="mr-3 text-gray-600" />
                                            <span>Exportar CSV</span>
                                        </button>
                                        {reportType === 's13' ? (
                                            <>
                                                <button
                                                    onClick={() => {
                                                        handleExportExcel();
                                                        setExportMenuOpen(false);
                                                    }}
                                                    disabled={isGenerating}
                                                    className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center border-b border-gray-200"
                                                >
                                                    <Icon name="fileText" size={16} className="mr-3 text-green-600" />
                                                    <span>Exportar Excel</span>
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        handleExportPDF();
                                                        setExportMenuOpen(false);
                                                    }}
                                                    disabled={isGenerating}
                                                    className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center"
                                                >
                                                    <Icon name="download" size={16} className="mr-3 text-red-600" />
                                                    <span>Exportar PDF</span>
                                                </button>
                                            </>
                                        ) : reportType !== 'publisher' && (
                                            <button
                                                onClick={() => {
                                                    handleExportExcel();
                                                    setExportMenuOpen(false);
                                                }}
                                                disabled={isGenerating}
                                                className="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center"
                                            >
                                                <Icon name="fileText" size={16} className="mr-3 text-green-600" />
                                                <span>Exportar Excel</span>
                                            </button>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    ) : (
                        // Vista escritorio con botones individuales
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={handlePrint}
                                disabled={reportData.length === 0}
                                className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center"
                            >
                                <Icon name="printer" size={16} className="mr-2" />
                                Imprimir
                            </button>
                            {reportType === 's13' ? (
                                <>
                                    <button
                                        onClick={handleExportExcel}
                                        disabled={isGenerating || reportData.length === 0}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-colors flex items-center"
                                    >
                                        <Icon name="fileText" size={16} className="mr-2" />
                                        {isGenerating ? 'Generando...' : 'Exportar Excel'}
                                    </button>
                                    <button
                                        onClick={handleExportPDF}
                                        disabled={isGenerating || reportData.length === 0}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400 transition-colors flex items-center"
                                    >
                                        <Icon name="download" size={16} className="mr-2" />
                                        {isGenerating ? 'Generando...' : 'Exportar PDF'}
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={handleExportCSV}
                                        disabled={isGenerating || reportData.length === 0}
                                        className="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 disabled:bg-gray-400 transition-colors flex items-center"
                                    >
                                        <Icon name="download" size={16} className="mr-2" />
                                        {isGenerating ? 'Generando...' : 'Exportar CSV'}
                                    </button>
                                    {reportType !== 'publisher' && (
                                        <button
                                            onClick={handleExportExcel}
                                            disabled={isGenerating || reportData.length === 0}
                                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-colors flex items-center"
                                        >
                                            <Icon name="fileText" size={16} className="mr-2" />
                                            {isGenerating ? 'Generando...' : 'Excel'}
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </Modal>
    );
};

const TerritoryMapModal = ({ isOpen, onClose, territory, addresses, isAssignedToMe, isAdmin, onEditAddress, sortState, onSortByDistance, onOptimizedRoute, onResetSort }) => {
    const mapRef = useRef(null);
    const mapInstanceRef = useRef(null);
    const [mapError, setMapError] = useState(false);
    const [isMapReady, setIsMapReady] = useState(false);
    const [selectedAddress, setSelectedAddress] = useState(null);
    const [selectedAddressIndex, setSelectedAddressIndex] = useState(null);
    const { showToast } = useToast();
    const markersRef = useRef({});
    const routeLineRef = useRef(null);
    
    useEffect(() => {
        if (selectedAddress) {
            const updatedSelectedAddress = addresses.find(a => a.id === selectedAddress.id);
            if (updatedSelectedAddress) {
                setSelectedAddress(updatedSelectedAddress);
            }
        }
    }, [addresses]);

    const extractCoordinatesFromUrl = (url) => {
        if (!url) return null;
        const patterns = [
            /@(-?\d+\.?\d*),(-?\d+\.?\d*)/,
            /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
            /q=(-?\d+\.?\d*),(-?\d+\.?\d*)/,
            /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) {
                return {
                    lat: parseFloat(match[1]),
                    lng: parseFloat(match[2])
                };
            }
        }
        return null;
    };
    
    const updateMapMarkers = (addressesToShow) => {
        if (!mapInstanceRef.current) return;
        
        Object.values(markersRef.current).forEach(marker => {
            mapInstanceRef.current.removeLayer(marker);
        });
        markersRef.current = {};
        
        const markersGroup = L.featureGroup();
        
        addressesToShow.forEach((address, index) => {
            const coords = (address.latitude && address.longitude) ? { lat: address.latitude, lng: address.longitude } : extractCoordinatesFromUrl(address.mapUrl);
            if (!coords) return;
            
            const getMarkerColor = (addr) => {
                if (addr.isVisited) return '#ef4444';
                if (addr.isRevisita) return '#a855f7';
                if (addr.isEstudio) return '#3b82f6';
                return '#22c55e';
            };
            
            const displayNumber = sortState.sortOrder === 'optimized' && address.routeOrder ? address.routeOrder : index + 1;
            
            const markerHtml = `<div style="background-color: ${getMarkerColor(address)}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;">${displayNumber}</div>`;
            
            const customIcon = L.divIcon({ html: markerHtml, iconSize: [30, 30], className: 'custom-marker' });
            
            const marker = L.marker([coords.lat, coords.lng], { icon: customIcon });
            
            marker.on('click', () => {
                const currentAddressState = addresses.find(a => a.id === address.id);
                setSelectedAddress(currentAddressState || address);
                setSelectedAddressIndex(index);
            });
            
            markersRef.current[address.id] = marker;
            markersGroup.addLayer(marker);
        });
        
        if(Object.keys(markersRef.current).length > 0) {
            markersGroup.addTo(mapInstanceRef.current);
        }

        if (sortState.userLocation && mapInstanceRef.current) {
            const userIcon = L.divIcon({
                html: `<div style="background-color: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4); position: relative;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background-color: white; border-radius: 50%;"></div></div>`,
                iconSize: [20, 20],
                className: 'user-location-marker'
            });
            
            L.marker([sortState.userLocation.lat, sortState.userLocation.lng], { icon: userIcon })
                .addTo(mapInstanceRef.current)
                .bindPopup('Tu ubicación');
        }
    };
    
    const drawRouteLine = (orderedList) => {
        if (!mapInstanceRef.current) return;

        if (routeLineRef.current) {
            mapInstanceRef.current.removeLayer(routeLineRef.current);
        }
        
        const routeCoords = [];
        if (sortState.userLocation) {
            routeCoords.push([sortState.userLocation.lat, sortState.userLocation.lng]);
        }
        
        orderedList.forEach(address => {
            const coords = (address.latitude && address.longitude) ? { lat: address.latitude, lng: address.longitude } : extractCoordinatesFromUrl(address.mapUrl);
            if (coords) routeCoords.push([coords.lat, coords.lng]);
        });
        
        if (routeCoords.length > 1) {
            routeLineRef.current = L.polyline(routeCoords, { color: '#4f46e5', weight: 3, opacity: 0.7, dashArray: '10, 10', lineJoin: 'round' }).addTo(mapInstanceRef.current);
        }
    };
    
    useEffect(() => {
        if (!isOpen) return;

        const initializeMap = () => {
            if (!mapRef.current || mapInstanceRef.current) return;
            try {
                const addressesWithCoords = addresses.filter(addr => (addr.latitude && addr.longitude) || extractCoordinatesFromUrl(addr.mapUrl));
                if (addressesWithCoords.length === 0) {
                    setMapError(true);
                    return;
                }
                const map = L.map(mapRef.current, { zoomControl: true, attributionControl: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors', maxZoom: 19 }).addTo(map);
                mapInstanceRef.current = map;
                setIsMapReady(true);
            } catch (error) {
                console.error('Error al inicializar el mapa:', error);
                setMapError(true);
            }
        };

        const checkLeaflet = () => {
            if (typeof L !== 'undefined') {
                initializeMap();
            } else {
                setTimeout(() => typeof L !== 'undefined' ? initializeMap() : setMapError(true), 1000);
            }
        };
        
        checkLeaflet();
        
        return () => {
            if (mapInstanceRef.current) {
                mapInstanceRef.current.remove();
                mapInstanceRef.current = null;
            }
            setIsMapReady(false);
            setMapError(false);
            setSelectedAddress(null);
        };
    }, [isOpen]);
    
    useEffect(() => {
        if (!isOpen || !isMapReady || !mapInstanceRef.current) return;
        
        updateMapMarkers(addresses);

        if (sortState.sortOrder === 'optimized') {
            drawRouteLine(addresses);
        } else {
            if (routeLineRef.current) {
                mapInstanceRef.current.removeLayer(routeLineRef.current);
                routeLineRef.current = null;
            }
        }
        
        const addressesWithCoords = addresses.filter(addr => (addr.latitude && addr.longitude) || extractCoordinatesFromUrl(addr.mapUrl));
        if (addressesWithCoords.length > 0) {
             const markerBounds = L.featureGroup(Object.values(markersRef.current)).getBounds();
             if(markerBounds.isValid()) {
                mapInstanceRef.current.fitBounds(markerBounds, { padding: [50, 50] });
             }
        }

        setTimeout(() => mapInstanceRef.current.invalidateSize(), 100);

    }, [isOpen, isMapReady, addresses, sortState]);
    
    if (!isOpen) return null;
    
    return (
        <div className="fixed inset-0 z-[70] bg-white flex flex-col">
            <div className="bg-gray-50 border-b border-gray-200 px-4 sm:px-6 py-4">
                <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center">
                        <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition-colors mr-3" aria-label="Cerrar mapa"><Icon name="arrowLeft" size={20} className="text-gray-600" /></button>
                        <div className="flex items-center">
                            <div className="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3"><Icon name="map" size={20} className="text-indigo-600" /></div>
                            <div>
                                <h2 className="text-lg font-semibold text-gray-800">{territory.name}</h2>
                                <p className="text-xs text-gray-600">
                                    {sortState.sortOrder === 'optimized' ? 'Ruta optimizada activa' : 'Haz clic en un marcador'}
                                </p>
                            </div>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg transition-colors"><Icon name="x" size={20} className="text-gray-600" /></button>
                </div>
                <div className="flex items-center justify-end space-x-2">
                    {sortState.sortOrder !== 'alpha' ? (
                        <button onClick={onResetSort} className="p-2.5 text-red-500 bg-white rounded-lg shadow-sm border border-red-200 hover:bg-red-50 transition-all" title="Restaurar orden original"><Icon name="x" size={18} /></button>
                    ) : (
                        <button onClick={onSortByDistance} disabled={sortState.isLocating} className="p-2.5 text-slate-500 hover:text-blue-600 bg-white rounded-lg shadow-sm border border-slate-200 hover:border-blue-300 disabled:opacity-50 transition-all" title="Ordenar por proximidad">
                            {sortState.isLocating ? <div className="animate-spin w-[18px] h-[18px] border-2 border-slate-400 border-t-transparent rounded-full"></div> : <Icon name="navigation" size={18} />}
                        </button>
                    )}
                    <button onClick={onOptimizedRoute} disabled={sortState.isCalculatingRoute} className={`p-2.5 rounded-lg shadow-sm border transition-all ${sortState.sortOrder === 'optimized' ? 'bg-green-600 text-white border-green-700' : 'bg-white text-slate-500 hover:text-green-600 border-slate-200 hover:border-green-300'}`} title="Activar/Desactivar ruta optimizada">
                        {sortState.isCalculatingRoute ? <div className="animate-spin w-[18px] h-[18px] border-2 border-current border-t-transparent rounded-full"></div> : <Icon name="activity" size={18} />}
                    </button>
                </div>
            </div>
            
            <div className="flex-1 relative bg-gray-100 flex flex-col">
                <div className={`${selectedAddress ? 'flex-1' : 'h-full'} transition-all duration-300 relative`}>
                    {mapError ? (
                        <div className="absolute inset-0 flex items-center justify-center text-center"><p className="text-gray-600">No se pudo cargar el mapa.<br/>No hay direcciones con ubicación GPS.</p></div>
                    ) : (
                        <>
                            {!isMapReady && (<div className="absolute inset-0 flex items-center justify-center bg-white z-10"><div className="text-center"><div className="animate-spin w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div><p className="text-gray-600 mt-4">Cargando mapa...</p></div></div>)}
                            <div ref={mapRef} className="w-full h-full" style={{ minHeight: '400px' }} />
                        </>
                    )}
                </div>
                
                {selectedAddress && (
                    <div className="w-full bg-white border-t border-gray-300 shadow-lg animate-slide-up" style={{ maxHeight: '50vh', minHeight: '200px' }}>
                        <div className="p-4"><div className="mb-3 flex items-center justify-between"><h3 className="text-base font-semibold text-gray-800 flex items-center"><span className="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-2">{selectedAddress.routeOrder || selectedAddressIndex + 1}</span>Dirección Seleccionada</h3><button onClick={() => setSelectedAddress(null)} className="p-2 hover:bg-gray-100 rounded-full transition-colors" aria-label="Cerrar detalle"><Icon name="chevronDown" size={20} className="text-gray-500" /></button></div><div className="overflow-y-auto" style={{ maxHeight: 'calc(50vh - 100px)' }}><AddressCard address={selectedAddress} isAssigned={isAssignedToMe} index={selectedAddressIndex} onEdit={(addr) => { onEditAddress(addr); onClose(); }} isAdmin={isAdmin} viewMode="grid-full" /></div></div>
                    </div>
                )}
            </div>
            
            <div className="bg-white border-t border-gray-200 p-4">
                <div className="flex flex-wrap items-center justify-center gap-4 text-sm">
                    <div className="flex items-center"><div className="w-4 h-4 bg-green-500 rounded-full mr-2"></div><span className="text-gray-600">Pendiente</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-red-500 rounded-full mr-2"></div><span className="text-gray-600">Visitada</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-purple-500 rounded-full mr-2"></div><span className="text-gray-600">Revisita</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-blue-500 rounded-full mr-2"></div><span className="text-gray-600">Estudio</span></div>
                    {sortState.userLocation && (<div className="flex items-center"><div className="w-4 h-4 bg-blue-600 rounded-full mr-2 relative"><div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-white rounded-full"></div></div><span className="text-gray-600">Tu ubicación</span></div>)}
                </div>
            </div>
        </div>
    );
};

// --- INICIO DEL BLOQUE DE CÓDIGO ---

// Componente AddressFormModal ACTUALIZADO con lógica de propuesta de eliminación
const AddressFormModal = ({ isOpen, onClose, onSave, onDelete, address, isSubmitting }) => {
    const { useState, useEffect, useRef, useContext } = React;
    const { currentUser, handleProposeDeletion } = useContext(AppContext);
    
    const [formData, setFormData] = useState({
        address: '', notes: '', isRevisita: false, isEstudio: false, revisitaBy: '', estudioBy: '',
        gender: 'Desconocido', mapUrl: '', latitude: null, longitude: null
    });
    const [manualCoords, setManualCoords] = useState('');
    const [errors, setErrors] = useState({});
    const [isGeocoding, setIsGeocoding] = useState(false);
    const [showCoordinatesInput, setShowCoordinatesInput] = useState(false);
    
    const [isLocationLocked, setIsLocationLocked] = useState(true);
    const [changeReason, setChangeReason] = useState('');
    const [isLocationExpanded, setIsLocationExpanded] = useState(false);
    const addressInputRef = useRef(null);
    const { showToast } = useToast();
    const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);

    useEffect(() => {
        if (isOpen) {
            const initialData = address ? {
                address: address.address || '',
                notes: address.notes || '',
                isRevisita: address.isRevisita || false,
                isEstudio: address.isEstudio || false,
                revisitaBy: address.revisitaBy || '',
                estudioBy: address.estudioBy || '',
                gender: address.gender || 'Desconocido',
                mapUrl: address.mapUrl || '',
                latitude: address.latitude || null,
                longitude: address.longitude || null
            } : {
                address: '', notes: '', isRevisita: false, isEstudio: false, revisitaBy: '', estudioBy: '',
                gender: 'Desconocido', mapUrl: '', latitude: null, longitude: null
            };
            setFormData(initialData);

            const hasCoordinates = initialData.latitude && initialData.longitude;
            setIsLocationLocked(!!address && hasCoordinates);

            if (hasCoordinates) {
                setManualCoords(`${initialData.latitude}, ${initialData.longitude}`);
            } else {
                setManualCoords('');
            }
            
            setShowCoordinatesInput(false);
            setErrors({});
            setIsDeleteConfirmOpen(false);
            // Si es una dirección existente con coordenadas, expandir la sección
            setIsLocationExpanded(!!address && (!!address.latitude || !!address.mapUrl));
            // Removido el autofocus para permitir ver todo el formulario primero
        }
    }, [address, isOpen]);

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        if (type === 'checkbox') {
            // Si se marca revisita o estudio, automáticamente asignar el nombre del usuario actual
            if ((name === 'isRevisita' || name === 'isEstudio') && checked) {
                const byField = name === 'isRevisita' ? 'revisitaBy' : 'estudioBy';
                setFormData(prev => ({ 
                    ...prev, 
                    [name]: checked,
                    [byField]: currentUser.name
                }));
            } else {
                setFormData(prev => ({ ...prev, [name]: checked }));
            }
        } else {
            setFormData(prev => ({ ...prev, [name]: value }));
        }
        if (errors[name]) setErrors(prev => ({ ...prev, [name]: '' }));
    };
    
    const validateForm = () => {
        const newErrors = {};
        if (!formData.address.trim()) newErrors.address = 'La dirección es obligatoria';
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        if (validateForm()) {
            const reason = currentUser?.role === 'admin' ? '' : changeReason;
            onSave(formData, reason);
        }
    };

    // --- LÓGICA DE ELIMINACIÓN CORREGIDA ---
    const handleDeleteConfirm = async () => {
        if (!address) return;
        
        // Si el usuario no es admin, propone la eliminación.
        if (currentUser.role !== 'admin') {
            await handleProposeDeletion(address.id);
            // No se necesita toast aquí, `handleProposeDeletion` ya lo muestra.
            setIsDeleteConfirmOpen(false);
            onClose(); // Cierra el modal de formulario principal
        } else {
            // Si es admin, usa la función de eliminación directa que viene por props.
            onDelete(address.id);
            // El toast de éxito o error lo maneja la función que implementa onDelete.
            setIsDeleteConfirmOpen(false);
        }
    };


    const genderOptions = [
        { value: 'Hombre', label: 'Hombre', icon: 'fa-person' },
        { value: 'Mujer', label: 'Mujer', icon: 'fa-person-dress' },
        { value: 'Pareja', label: 'Pareja', icon: 'fa-user-group' }
    ];

    const extractCoordinatesFromUrl = (url) => { if (!url) return null; try { const decodedUrl = decodeURIComponent(url); const patterns = [/@(-?\d+\.\d+),(-?\d+\.\d+)/, /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/, /ll=(-?\d+\.\d+),(-?\d+\.\d+)/, /q=(-?\d+\.\d+),(-?\d+\.\d+)/]; for (const pattern of patterns) { const match = decodedUrl.match(pattern); if (match) { const lat = parseFloat(match[1]); const lng = parseFloat(match[2]); if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) return { lat, lng }; } } } catch (error) { console.error('Error extrayendo coordenadas:', error); } return null; };
    const geocodeAddress = async (addressText) => { if (!addressText.trim()) return null; setIsGeocoding(true); try { const fullAddress = `${addressText}, Guadalajara, Jalisco, México`; const encodedAddress = encodeURIComponent(fullAddress); const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodedAddress}&format=json&limit=1&addressdetails=1`, { headers: { 'Accept-Language': 'es' } }); const data = await response.json(); if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } catch (error) { console.error('Error geocodificando:', error); } finally { setIsGeocoding(false); } return null; };
    const syncCoordsToUI = (lat, lng) => { setFormData(prev => ({ ...prev, latitude: lat, longitude: lng })); setManualCoords(`${lat}, ${lng}`); };
    const handleMapUrlChange = (e) => { const url = e.target.value; setFormData(prev => ({ ...prev, mapUrl: url })); const coords = extractCoordinatesFromUrl(url); if (coords) { syncCoordsToUI(coords.lat, coords.lng); showToast(`✅ Coordenadas extraídas de URL`, 'success'); } };
    const handleManualCoordinateChange = (e) => { const value = e.target.value; setManualCoords(value); const coordsRegex = /^\s*(-?\d{1,3}(?:\.\d+)?)\s*[,; ]+\s*(-?\d{1,3}(?:\.\d+)?)\s*$/; const match = value.trim().match(coordsRegex); if (match) { const lat = parseFloat(match[1]); const lng = parseFloat(match[2]); if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) { setFormData(prev => ({ ...prev, latitude: lat, longitude: lng })); showToast('Coordenadas reconocidas.', 'success', 1500); } else { showToast('Coordenadas fuera de rango.', 'warning'); } } };
    const handleGeocodeClick = async () => { if (!formData.address.trim()) { showToast('Ingresa una dirección primero', 'warning'); return; } const coords = await geocodeAddress(formData.address); if (coords) { syncCoordsToUI(coords.lat, coords.lng); showToast(`✅ Coordenadas obtenidas para la dirección`, 'success'); } else { showToast('No se pudieron obtener coordenadas. Intenta con un enlace de Google Maps.', 'warning'); setShowCoordinatesInput(true); } };
    const handleGetCurrentLocation = () => { if (!navigator.geolocation) { showToast('Tu navegador no soporta geolocalización', 'error'); return; } showToast('Obteniendo tu ubicación...', 'info'); navigator.geolocation.getCurrentPosition( (position) => { syncCoordsToUI(position.coords.latitude, position.coords.longitude); showToast(`✅ Ubicación actual obtenida`, 'success'); }, (error) => { showToast('No se pudo obtener tu ubicación', 'error'); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); };

    return (
        <>
            <Modal isOpen={isOpen} onClose={onClose} title={address ? 'Editar Dirección' : 'Proponer Nueva Dirección'} size="md">
                <form onSubmit={handleSubmit} noValidate className="flex flex-col h-full">
                    <div className="p-6 space-y-4 flex-1 overflow-y-auto">
                        <div>
                            <label htmlFor="address" className="block text-sm font-medium text-gray-700 mb-1">Dirección *</label>
                            <input ref={addressInputRef} type="text" id="address" name="address" value={formData.address} onChange={handleChange} className={`w-full px-3 py-2 border rounded-md ${errors.address ? 'border-red-300' : 'border-gray-300'}`} placeholder="Ej: Calle Ejemplo 123, Colonia Centro" />
                            {errors.address && <p className="mt-1 text-sm text-red-600">{errors.address}</p>}
                        </div>
                        
                        <div className="border border-gray-200 rounded-lg">
                            <button
                                type="button"
                                onClick={() => setIsLocationExpanded(!isLocationExpanded)}
                                className="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-lg flex items-center justify-between"
                            >
                                <h4 className="font-medium text-gray-700 flex items-center">
                                    <Icon name="mapPin" size={16} className="mr-2" />
                                    Ubicación Precisa
                                    <span className="text-sm text-gray-500 ml-2">(Opcional)</span>
                                </h4>
                                <Icon 
                                    name={isLocationExpanded ? "chevronUp" : "chevronDown"} 
                                    size={20} 
                                    className="text-gray-400"
                                />
                            </button>
                            
                            {isLocationExpanded && (
                                <div className="p-4 bg-blue-50 border-t border-gray-200 space-y-3">
                                    {isLocationLocked && address ? (
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-medium text-blue-900">Información guardada</span>
                                                <button
                                                    type="button"
                                                    onClick={() => setIsLocationLocked(false)}
                                                    className="px-3 py-1.5 bg-yellow-400 text-yellow-900 rounded-md hover:bg-yellow-500 flex items-center justify-center text-sm font-semibold"
                                                >
                                                    <Icon name="lockOpen" size={14} className="mr-1.5" />
                                                    Editar
                                                </button>
                                            </div>
                                            <div className="space-y-3 bg-white p-4 rounded-md border border-blue-200">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-500">Enlace de Google Maps</label>
                                                    <p className="text-sm text-gray-800 break-words">
                                                        {formData.mapUrl || <span className="text-gray-400 italic">No asignado</span>}
                                                    </p>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-500">Coordenadas</label>
                                                    {formData.latitude && formData.longitude ? (
                                                        <p className="text-sm text-green-700 font-mono">
                                                            📍 {formData.latitude.toFixed(6)}, {formData.longitude.toFixed(6)}
                                                        </p>
                                                    ) : (
                                                        <p className="text-sm text-gray-400 italic">No asignadas</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button type="button" onClick={handleGeocodeClick} disabled={isGeocoding || !formData.address.trim()} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center text-sm">
                                                    {isGeocoding ? <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> : <><Icon name="search" size={16} className="mr-1" />Buscar Coords</>}
                                                </button>
                                                <button type="button" onClick={handleGetCurrentLocation} className="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center text-sm">
                                                    <Icon name="mapPin" size={16} className="mr-1" /> Mi Ubicación
                                                </button>
                                            </div>
                                            <div>
                                                <label htmlFor="mapUrl" className="block text-sm font-medium text-gray-700 mb-1">Enlace de Google Maps</label>
                                                <textarea id="mapUrl" name="mapUrl" value={formData.mapUrl} onChange={handleMapUrlChange} placeholder="Pega aquí el enlace de Google Maps..." className="w-full px-3 py-2 border rounded-md border-gray-300 text-sm" rows="2" />
                                            </div>
                                            <div className="bg-white p-3 rounded-md border border-blue-200">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-sm font-medium text-gray-700">Coordenadas:</span>
                                                    <button type="button" onClick={() => setShowCoordinatesInput(prev => !prev)} className="text-xs text-blue-600 hover:text-blue-800">
                                                        {showCoordinatesInput ? 'Ocultar' : 'Editar manualmente'}
                                                    </button>
                                                </div>
                                                {showCoordinatesInput && (
                                                    <div>
                                                        <label htmlFor="manualCoords" className="block text-xs font-medium text-gray-600 mb-1">Pegar coordenadas (latitud, longitud)</label>
                                                        <textarea id="manualCoords" placeholder="Ej: 20.6521, -103.3628" className="w-full px-2 py-1 text-sm border rounded-md font-mono" rows="2" value={manualCoords} onChange={handleManualCoordinateChange} />
                                                        <p className="text-xs text-gray-600 mt-1">Pega latitud y longitud separadas por coma o espacio.</p>
                                                    </div>
                                                )}
                                                {!showCoordinatesInput && formData.latitude && formData.longitude && (
                                                    <p className="text-sm text-green-700 font-mono">📍 {formData.latitude.toFixed(6)}, {formData.longitude.toFixed(6)}</p>
                                                )}
                                                {!showCoordinatesInput && !(formData.latitude && formData.longitude) && (
                                                    <p className="text-sm text-gray-500">No hay coordenadas asignadas.</p>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Género</label>
                            <div className="flex items-center justify-around bg-gray-50 p-2 rounded-lg">
                                {genderOptions.map(option => (
                                    <label key={option.value} className={`cursor-pointer p-2 rounded-lg flex flex-col items-center transition-all w-20 h-20 justify-center ${formData.gender === option.value ? 'bg-indigo-100 text-indigo-600 ring-2 ring-indigo-300' : 'text-gray-500 hover:bg-gray-200'}`}>
                                        <input type="radio" name="gender" value={option.value} checked={formData.gender === option.value} onChange={handleChange} className="sr-only" />
                                        <i className={`fas ${option.icon} text-2xl`}></i>
                                        <span className="text-xs font-semibold mt-2">{option.label}</span>
                                    </label>
                                ))}
                                <label className={`cursor-pointer p-2 rounded-lg flex flex-col items-center transition-all w-20 h-20 justify-center ${formData.gender === 'Desconocido' || !formData.gender ? 'bg-gray-200 text-gray-800 ring-2 ring-gray-400' : 'text-gray-500 hover:bg-gray-200'}`}>
                                    <input type="radio" name="gender" value="Desconocido" checked={formData.gender === 'Desconocido' || !formData.gender} onChange={handleChange} className="sr-only" />
                                    <i className="fas fa-ban text-2xl"></i>
                                    <span className="text-xs font-semibold mt-2">Desconocido</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                            <textarea id="notes" name="notes" value={formData.notes} onChange={handleChange} rows="3" className="w-full px-3 py-2 border rounded-md border-gray-300" placeholder="Información adicional..." />
                        </div>

                        <div className="pt-4 border-t space-y-4">
                            <h4 className="text-sm font-medium text-gray-700 mb-2">Marcar esta dirección como:</h4>
                            
                            <div className="space-y-3">
                                {/* Opción de Revisita */}
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <label htmlFor="isRevisita" className="flex items-start cursor-pointer">
                                        <input 
                                            id="isRevisita" 
                                            name="isRevisita" 
                                            type="checkbox" 
                                            checked={formData.isRevisita} 
                                            onChange={handleChange} 
                                            className="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 mt-0.5" 
                                        />
                                        <div className="ml-3 flex-1">
                                            <span className="text-sm font-medium text-gray-700 flex items-center">
                                                <i className="fas fa-bookmark text-purple-600 mr-2"></i>
                                                Revisita
                                            </span>
                                            {formData.isRevisita && (
                                                <p className="text-xs text-gray-600 mt-1">
                                                    Atendida por: <span className="font-semibold">{formData.revisitaBy}</span>
                                                </p>
                                            )}
                                        </div>
                                    </label>
                                </div>
                                
                                {/* Opción de Estudio */}
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <label htmlFor="isEstudio" className="flex items-start cursor-pointer">
                                        <input 
                                            id="isEstudio" 
                                            name="isEstudio" 
                                            type="checkbox" 
                                            checked={formData.isEstudio} 
                                            onChange={handleChange} 
                                            className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-0.5" 
                                        />
                                        <div className="ml-3 flex-1">
                                            <span className="text-sm font-medium text-gray-700 flex items-center">
                                                <i className="fas fa-book-open text-blue-600 mr-2"></i>
                                                Estudio
                                            </span>
                                            {formData.isEstudio && (
                                                <p className="text-xs text-gray-600 mt-1">
                                                    Dirigido por: <span className="font-semibold">{formData.estudioBy}</span>
                                                </p>
                                            )}
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-6 border-t flex justify-between items-center">
                        <div>
                            {address && (onDelete || currentUser.role !== 'admin') && (
                                <button
                                    type="button"
                                    onClick={() => setIsDeleteConfirmOpen(true)}
                                    disabled={isSubmitting}
                                    className="px-4 py-2 flex items-center gap-2 border border-transparent rounded-md text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                >
                                    <Icon name="trash" size={16} />
                                    Eliminar
                                </button>
                            )}
                        </div>
                        <div className="flex space-x-3">
                            <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                            <button type="submit" disabled={isSubmitting || isGeocoding} className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-indigo-400">
                                {isSubmitting ? 'Guardando...' : 'Guardar'}
                            </button>
                        </div>
                    </div>
                </form>
            </Modal>
            
            <ConfirmationModal
                isOpen={isDeleteConfirmOpen}
                onConfirm={handleDeleteConfirm}
                onCancel={() => setIsDeleteConfirmOpen(false)}
                title={currentUser.role !== 'admin' ? "¿Proponer Eliminación?" : "¿Confirmar Eliminación?"}
                message={
                    currentUser.role !== 'admin'
                    ? `Tu solicitud para eliminar "${address?.address}" será enviada a un administrador para su revisión. ¿Deseas continuar?`
                    : `¿Estás seguro de que deseas eliminar la dirección "${address?.address}"? La acción no se puede deshacer.`
                }
                confirmText={currentUser.role !== 'admin' ? "Sí, Proponer" : "Sí, Eliminar"}
                type="danger"
                isLoading={isSubmitting}
            />
        </>
    );
};
// --- FIN DEL BLOQUE DE CÓDIGO ---












// --- Módulo de Gestión de Direcciones ACTUALIZADO con eliminación en modal ---
const AddressManager = ({ onBack }) => {
    const { addresses, territories, handleDeleteAddress, handleUpdateAddress, handleAddNewAddress } = useContext(AppContext);
    const { showToast } = useToast();
    const { currentUser } = useContext(AppContext);
    
    const [view, setView] = useState('list'); 
    const [selectedTerritory, setSelectedTerritory] = useState(null);

    const [searchTerm, setSearchTerm] = useState('');
    const [isFormModalOpen, setIsFormModalOpen] = useState(false);
    const [editingAddress, setEditingAddress] = useState(null);
    const [isSubmitting, setIsSubmitting] = useState(false);
    
    const debouncedSearchTerm = useDebounce(searchTerm, 150);

    const searchResults = useMemo(() => {
        if (!debouncedSearchTerm.trim()) return [];
        const normalizedSearch = normalizeText(debouncedSearchTerm);
        return addresses
            .filter(addr => 
                normalizeText(addr.address).includes(normalizedSearch) ||
                normalizeText(addr.name || '').includes(normalizedSearch) ||
                normalizeText(addr.notes || '').includes(normalizedSearch)
            )
            .map(addr => ({
                ...addr,
                territoryName: territories.find(t => t.id === addr.territoryId)?.name || 'Desconocido'
            }));
    }, [addresses, territories, debouncedSearchTerm]);

    const territoryAddresses = useMemo(() => {
        if (!selectedTerritory) return [];
        return addresses.filter(a => a.territoryId === selectedTerritory.id);
    }, [addresses, selectedTerritory]);

    const handleSelectTerritory = (territory) => {
        setSelectedTerritory(territory);
        setView('detail');
    };

    const handleBackToList = () => {
        setView('list');
        setSelectedTerritory(null);
    };

    const openEditModal = (address) => {
        setEditingAddress(address);
        setIsFormModalOpen(true);
    };

    const openAddModal = () => {
        setEditingAddress(null);
        setIsFormModalOpen(true);
    };

    const handleSaveAddress = async (formData) => {
        setIsSubmitting(true);
        try {
            if (!formData.isRevisita) formData.revisitaBy = '';
            if (!formData.isEstudio) formData.estudioBy = '';
            if (editingAddress) {
                await handleUpdateAddress(editingAddress.id, formData);
                showToast('Dirección actualizada', 'success');
            } else {
                await handleAddNewAddress({ ...formData, territoryId: selectedTerritory.id });
                showToast('Dirección agregada', 'success');
            }
            setIsFormModalOpen(false);
            setEditingAddress(null);
        } catch (error) {
            showToast('Error al guardar la dirección', 'error');
        } finally {
            setIsSubmitting(false);
        }
    };
    
const handleDeleteAddressAndClose = async (addressId) => {
    setIsProcessing(true);
    try {
        await handleDeleteAddress(addressId);
        showToast('Dirección eliminada correctamente.', 'success');
        setIsFormModalOpen(false);
        setEditingAddress(null);
    } catch (error) {
        showToast('Error al eliminar la dirección.', 'error');
    } finally {
        setIsProcessing(false);
    }
};

    
            
    const SearchResultsView = () => (
        <div className="px-6 pb-6">
            {searchResults.length > 0 ? (
                <div className="space-y-3">
                    <p className="text-sm text-gray-500 mb-2">{searchResults.length} {searchResults.length === 1 ? 'resultado encontrado' : 'resultados encontrados'}</p>
                    {searchResults.map(addr => {
                        const hasRevisita = addr.isRevisita && addr.revisitaBy;
                        const hasEstudio = addr.isEstudio && addr.estudioBy;
                        const hasBanner = hasRevisita || hasEstudio;
                        const cardPadding = hasBanner ? 'pt-12 p-4' : 'p-4';

                        return (
                            <div key={addr.id} className="relative bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                                {hasBanner && (
                                    <div className="absolute top-0 left-0 right-0 flex flex-col">
                                        {hasRevisita && (
                                            <div className="p-1.5 flex items-center justify-center text-xs font-bold bg-purple-600 text-white">
                                                <i className="fas fa-bookmark mr-2"></i>
                                                <span className="pr-2 tracking-wider">REVISITA</span>
                                                <span className="h-4 w-px bg-purple-400"></span>
                                                <span className="pl-2 tracking-wide">{addr.revisitaBy.toUpperCase()}</span>
                                            </div>
                                        )}
                                        {hasEstudio && (
                                            <div className="p-1.5 flex items-center justify-center text-xs font-bold bg-blue-600 text-white">
                                                <i className="fas fa-book-open mr-2"></i>
                                                <span className="pr-2 tracking-wider">ESTUDIO</span>
                                                <span className="h-4 w-px bg-blue-400"></span>
                                                <span className="pl-2 tracking-wide">{addr.estudioBy.toUpperCase()}</span>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <div className={cardPadding}>
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1 space-y-2">
                                            <p className="text-gray-800 font-medium">{addr.address}</p>
                                            {addr.name && <p className="text-sm text-gray-700"><Icon name="user" size={14} className="inline mr-2 opacity-60"/>{addr.name}</p>}
                                            {addr.notes && <p className="text-sm text-gray-600 italic"><Icon name="info" size={14} className="inline mr-2 opacity-60"/>{addr.notes}</p>}
                                            <div className="pt-2">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    <Icon name="mapPin" size={14} className="mr-1.5"/>
                                                    Territorio: {addr.territoryName}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="flex flex-col space-y-1 ml-4 z-20">
                                            <button onClick={() => openEditModal(addr)} className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-gray-100 rounded-full transition-all" title="Editar dirección"><Icon name="edit" size={18} /></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <div className="text-center py-12">
                    <Icon name="mapPin" size={48} className="mx-auto mb-3 text-gray-300" /><p className="text-gray-600 font-medium">No se encontraron direcciones</p><p className="text-sm text-gray-500">Intenta con otros términos de búsqueda.</p>
                </div>
            )}
        </div>
    );

    const TerritoryListView = () => ( <div className="px-6 pb-6"><div className="space-y-2"><p className="text-sm text-gray-500 mb-2">O selecciona un territorio para ver sus direcciones:</p>{territories.map(t => { const addressCount = addresses.filter(a => a.territoryId === t.id).length; return (<button key={t.id} onClick={() => handleSelectTerritory(t)} className="w-full text-left flex justify-between items-center p-4 bg-white rounded-lg border hover:border-indigo-500 hover:bg-indigo-50 transition-all group"><div className="flex items-center"><Icon name="mapPin" size={20} className="mr-3 text-gray-400 group-hover:text-indigo-500" /><div><span className="font-medium text-gray-800">{t.name}</span><span className="text-sm text-gray-500 ml-2">({addressCount} {addressCount === 1 ? 'dirección' : 'direcciones'})</span></div></div><Icon name="chevronRight" size={20} className="text-gray-400 group-hover:text-indigo-500" /></button>);})}</div></div> );
    const AddressDetailView = () => ( <div className="px-6 pb-6"> <div className="flex justify-between items-center mb-4"> <h4 className="text-lg font-bold text-gray-900">{selectedTerritory?.name}</h4> <button onClick={openAddModal} className="px-3 py-1.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 flex items-center"> <Icon name="plus" size={16} className="mr-1" />Agregar </button> </div> {territoryAddresses.length > 0 ? ( <div className="space-y-3"> {territoryAddresses.map(addr => { 
    const hasRevisita = addr.isRevisita && addr.revisitaBy;
    const hasEstudio = addr.isEstudio && addr.estudioBy;
    const hasBanner = hasRevisita || hasEstudio;
    const cardPadding = hasBanner ? 'pt-12 p-4' : 'p-4';
    return ( <div key={addr.id} className={`relative bg-white rounded-lg border overflow-hidden`}> 
        {hasBanner && (
            <div className="absolute top-0 left-0 right-0 flex flex-col">
                {hasRevisita && (
                    <div className="p-1.5 flex items-center justify-center text-xs font-bold bg-purple-600 text-white z-10">
                        <i className="fas fa-bookmark mr-2"></i>
                        <span className="pr-2 tracking-wider">REVISITA</span>
                        <span className="h-4 w-px bg-purple-400"></span>
                        <span className="pl-2 tracking-wide">{addr.revisitaBy.toUpperCase()}</span>
                    </div>
                )}
                {hasEstudio && (
                    <div className="p-1.5 flex items-center justify-center text-xs font-bold bg-blue-600 text-white z-10">
                        <i className="fas fa-book-open mr-2"></i>
                        <span className="pr-2 tracking-wider">ESTUDIO</span>
                        <span className="h-4 w-px bg-blue-400"></span>
                        <span className="pl-2 tracking-wide">{addr.estudioBy.toUpperCase()}</span>
                    </div>
                )}
            </div>
        )}
        <div className={cardPadding}>
            <div className="flex justify-between items-start"> <div className="flex-1 space-y-1"> <p className="font-medium">{addr.address}</p> {addr.name && <p className="text-sm text-gray-600">{addr.name}</p>} {addr.notes && <p className="text-sm text-gray-500 italic">{addr.notes}</p>} </div> <div className="flex space-x-1 z-20"> <button onClick={() => openEditModal(addr)} className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-gray-100 rounded-full"><Icon name="edit" size={18} /></button> </div> </div> </div> </div> ); })} </div> ) : ( <div className="text-center py-10 bg-gray-50 rounded-lg"> <p className="font-medium text-gray-600">Este territorio no tiene direcciones.</p> <p className="text-sm text-gray-500">Usa el botón "Agregar" para empezar.</p> </div> )} </div> );

    if (view === 'detail') {
        return (<><div key="detail-view"><div className="flex items-center mb-6 px-6 pt-6"><button onClick={handleBackToList} className="p-2 rounded-full hover:bg-gray-100"><Icon name="arrowLeft" size={20} /></button><h3 className="text-xl font-bold text-gray-900 ml-2">Direcciones del Territorio</h3></div><AddressDetailView /></div><AddressFormModal key="form-modal" isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSave={handleSaveAddress} onDelete={handleDeleteAddressAndClose} address={editingAddress} isSubmitting={isSubmitting} /></>);
    }
    
    return (
        <>
            <div key="main-view">
                <div className="flex items-center mb-6 px-6 pt-6">
                    <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100"><Icon name="arrowLeft" size={20} /></button>
                    <h3 className="text-xl font-bold text-gray-900 ml-2">Gestionar Direcciones</h3>
                </div>
                <div className="sticky top-0 bg-white/80 backdrop-blur-sm z-10 px-6 pb-4">
                    <div className="relative">
                        <Icon name="search" size={20} className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar cualquier dirección, nombre o nota..." className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg" />
                    </div>
                </div>
                {debouncedSearchTerm.trim() ? <SearchResultsView /> : <TerritoryListView />}
            </div>
            <AddressFormModal 
                key="form-modal-search" 
                isOpen={isFormModalOpen} 
                onClose={() => setIsFormModalOpen(false)} 
                onSave={handleSaveAddress}
                onDelete={handleDeleteAddressAndClose}
                address={editingAddress} 
                isSubmitting={isSubmitting} 
            />
        </>
    );
};




// --- INICIO: Nuevo Módulo de Gestión de Actividad (Estudios y Revisitas) ---
const ActivityManager = ({ onBack, users, addresses }) => {
    const { handleUpdateAddress } = useContext(AppContext);
    const { showToast } = useToast();

    const [searchTerm, setSearchTerm] = useState('');
    const debouncedSearchTerm = useDebounce(searchTerm, 300);
    const [filter, setFilter] = useState('all'); // 'all', 'studies', 'revisits'
    const [isProcessing, setIsProcessing] = useState(false);
    
    // Estados para los modales
    const [reassignState, setReassignState] = useState({ isOpen: false, address: null, type: '' });
    const [unmarkState, setUnmarkState] = useState({ isOpen: false, address: null, type: '' });

    // 1. Procesar y agrupar todas las direcciones activas
    const { groupedData, summary } = useMemo(() => {
        const activeAddresses = addresses.filter(a => a.isRevisita || a.isEstudio);
        const summary = { total: activeAddresses.length, studies: 0, revisits: 0, unassigned: 0 };
        
        const groups = {};

        activeAddresses.forEach(addr => {
            const isStudy = addr.isEstudio;
            const isRevisit = addr.isRevisita;
            
            if (isStudy) summary.studies++;
            if (isRevisit) summary.revisits++;

            const studyOwner = addr.isEstudio ? addr.estudioBy : null;
            const revisitOwner = addr.isRevisita ? addr.revisitaBy : null;

            const assignToGroup = (owner, type) => {
                const ownerName = owner || 'Sin Asignar';
                if (!groups[ownerName]) {
                    groups[ownerName] = { studies: [], revisits: [] };
                }
                if(type === 'study') groups[ownerName].studies.push(addr);
                else groups[ownerName].revisits.push(addr);
            };

            if (isStudy) assignToGroup(studyOwner, 'study');
            if (isRevisit && studyOwner !== revisitOwner) {
                 assignToGroup(revisitOwner, 'revisit');
            }
        });

        if (groups['Sin Asignar']) {
            summary.unassigned = (groups['Sin Asignar'].studies.length + groups['Sin Asignar'].revisits.length);
        }

        return { groupedData: groups, summary };
    }, [addresses]);
    
    // 2. Filtrar los grupos según la UI
    const filteredGroupedData = useMemo(() => {
        let publishers = Object.keys(groupedData);

        // Filtrar por tipo (estudio/revisita)
        if (filter === 'studies') {
            publishers = publishers.filter(p => groupedData[p].studies.length > 0);
        } else if (filter === 'revisits') {
            publishers = publishers.filter(p => groupedData[p].revisits.length > 0);
        }

        // Filtrar por término de búsqueda
        if (debouncedSearchTerm) {
            const normalizedQuery = normalizeText(debouncedSearchTerm);
            publishers = publishers.filter(p => {
                const publisherMatch = normalizeText(p).includes(normalizedQuery);
                if (publisherMatch) return true;
                
                // Buscar también en las direcciones del publicador
                const hasMatchingAddress = 
                    groupedData[p].studies.some(a => normalizeText(a.address).includes(normalizedQuery)) ||
                    groupedData[p].revisits.some(a => normalizeText(a.address).includes(normalizedQuery));
                
                return hasMatchingAddress;
            });
        }
        
        // Ordenar publicadores alfabéticamente, con "Sin Asignar" siempre primero
        publishers.sort((a, b) => {
            if (a === 'Sin Asignar') return -1;
            if (b === 'Sin Asignar') return 1;
            return a.localeCompare(b);
        });

        return publishers.map(p => ({ publisher: p, ...groupedData[p] }));

    }, [groupedData, filter, debouncedSearchTerm]);


    // --- Handlers de acciones ---
    const handleReassign = (address, type) => {
        setReassignState({ isOpen: true, address, type });
    };

    const executeReassign = async (newOwner) => {
        const { address, type } = reassignState;
        if (!address || !type || !newOwner) return;

        setIsProcessing(true);
        const updateData = type === 'study'
            ? { estudioBy: newOwner }
            : { revisitaBy: newOwner };

        try {
            await handleUpdateAddress(address.id, updateData);
            showToast(`Asignación actualizada a ${newOwner}.`, 'success');
        } catch (error) {
            showToast('Error al reasignar.', 'error');
        } finally {
            setIsProcessing(false);
            setReassignState({ isOpen: false, address: null, type: '' });
        }
    };
    
    const handleUnmark = (address, type) => {
        setUnmarkState({ isOpen: true, address, type });
    };

    const executeUnmark = async () => {
        const { address, type } = unmarkState;
        if (!address || !type) return;

        setIsProcessing(true);
        const updateData = type === 'study'
            ? { isEstudio: false, estudioBy: '' }
            : { isRevisita: false, revisitaBy: '' };

        try {
            await handleUpdateAddress(address.id, updateData);
            showToast('La dirección ha sido liberada.', 'success');
        } catch(e){
            showToast('Error al liberar la dirección.', 'error');
        } finally {
            setIsProcessing(false);
            setUnmarkState({ isOpen: false, address: null, type: '' });
        }
    };


    // Componente para una tarjeta de dirección dentro del panel de admin
    const AdminActivityCard = ({ address, type }) => (
        <div className="bg-white p-3 rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
            <p className="font-medium text-gray-800 text-sm">{address.address}</p>
            {address.notes && <p className="text-xs text-gray-500 italic mt-1">"{address.notes}"</p>}
            <div className="flex justify-end items-center gap-2 mt-3">
                <button onClick={() => handleReassign(address, type)} className="px-2.5 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 rounded-md transition-colors">Reasignar</button>
                <button onClick={() => handleUnmark(address, type)} className="px-2.5 py-1.5 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 rounded-md transition-colors">Liberar</button>
            </div>
        </div>
    );
    
    return (
        <>
        <div className="flex-1 overflow-y-auto p-6 bg-gray-50">
            {/* Header */}
            <div className="flex items-center mb-6">
                <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-200"><Icon name="arrowLeft" size={20} /></button>
                <h3 className="text-xl font-bold text-gray-900 ml-2">Gestión de Actividad</h3>
            </div>

            {/* Resumen Rediseñado */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                 <div className="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                    <div className="flex items-center justify-between mb-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center"><Icon name="activity" size={24} className="text-gray-600"/></div>
                        <p className="text-3xl font-bold text-gray-900">{summary.total}</p>
                    </div>
                    <p className="text-sm text-gray-600 font-medium">Total Activas</p>
                 </div>
                 <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                     <div className="flex items-center justify-between mb-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-100 to-indigo-200 rounded-lg flex items-center justify-center"><i className="fas fa-book-open text-2xl text-blue-600"></i></div>
                        <p className="text-3xl font-bold text-blue-700">{summary.studies}</p>
                    </div>
                    <p className="text-sm text-blue-700 font-medium">Estudios</p>
                 </div>
                 <div className="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                     <div className="flex items-center justify-between mb-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-purple-100 to-pink-200 rounded-lg flex items-center justify-center"><i className="fas fa-bookmark text-2xl text-purple-600"></i></div>
                        <p className="text-3xl font-bold text-purple-700">{summary.revisits}</p>
                    </div>
                    <p className="text-sm text-purple-700 font-medium">Revisitas</p>
                 </div>
                 <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow">
                     <div className="flex items-center justify-between mb-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-amber-100 to-orange-200 rounded-lg flex items-center justify-center"><Icon name="alertCircle" size={24} className="text-amber-600"/></div>
                        <p className="text-3xl font-bold text-amber-700">{summary.unassigned}</p>
                    </div>
                    <p className="text-sm text-amber-700 font-medium">Sin Asignar</p>
                 </div>
            </div>

            {/* Controles Rediseñados */}
            <div className="sticky top-0 bg-gray-50/80 backdrop-blur-sm z-10 py-4 mb-4">
                <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative flex-1">
                        <Icon name="search" size={20} className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" />
                        <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Buscar por publicador o dirección..." className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"/>
                    </div>
                    <div className="flex-shrink-0 flex items-center gap-1 bg-gray-200 p-1 rounded-lg">
                        <button onClick={() => setFilter('all')} className={`px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors ${filter === 'all' ? 'bg-white shadow text-gray-800' : 'text-gray-600 hover:bg-gray-300/50'}`}>Todos</button>
                        <button onClick={() => setFilter('studies')} className={`px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors ${filter === 'studies' ? 'bg-white shadow text-gray-800' : 'text-gray-600 hover:bg-gray-300/50'}`}>Estudios</button>
                        <button onClick={() => setFilter('revisits')} className={`px-4 py-2 text-sm font-medium rounded-md flex-1 transition-colors ${filter === 'revisits' ? 'bg-white shadow text-gray-800' : 'text-gray-600 hover:bg-gray-300/50'}`}>Revisitas</button>
                    </div>
                </div>
            </div>
            
            {/* Lista de Grupos Rediseñada */}
            <div className="space-y-4">
                {filteredGroupedData.length > 0 ? (
                    filteredGroupedData.map(({ publisher, studies, revisits }) => (
                        <div key={publisher} className={`bg-white rounded-xl shadow-sm border ${publisher === 'Sin Asignar' ? 'border-amber-300' : 'border-gray-200'}`}>
                             {/* Header de la tarjeta */}
                            <div className="p-4 border-b border-gray-100 flex items-center justify-between">
                                <div className="flex items-center">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center mr-3 ${publisher === 'Sin Asignar' ? 'bg-amber-100' : 'bg-gray-100'}`}>
                                        <Icon name={publisher === 'Sin Asignar' ? 'alertCircle' : 'user'} size={20} className={publisher === 'Sin Asignar' ? 'text-amber-600' : 'text-gray-600'}/>
                                    </div>
                                    <span className="font-bold text-lg text-gray-800">{publisher}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    {studies.length > 0 && <span className="text-sm font-medium text-blue-600 bg-blue-100 px-2.5 py-1 rounded-full">{studies.length} Estudio(s)</span>}
                                    {revisits.length > 0 && <span className="text-sm font-medium text-purple-600 bg-purple-100 px-2.5 py-1 rounded-full">{revisits.length} Revisita(s)</span>}
                                </div>
                            </div>
                            
                            {/* Contenido en dos columnas */}
                            <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Columna de Estudios */}
                                <div className={studies.length === 0 && 'hidden'}>
                                    <h4 className="text-base font-semibold text-blue-700 mb-3 flex items-center"><i className="fas fa-book-open mr-2"></i>Estudios Bíblicos</h4>
                                    <div className="space-y-2">
                                        {studies.map(addr => <AdminActivityCard key={`${addr.id}-study`} address={addr} type="study" />)}
                                    </div>
                                </div>
                                
                                {/* Columna de Revisitas */}
                                <div className={revisits.length === 0 && 'hidden'}>
                                    <h4 className="text-base font-semibold text-purple-700 mb-3 flex items-center"><i className="fas fa-bookmark mr-2"></i>Revisitas</h4>
                                    <div className="space-y-2">
                                        {revisits.map(addr => <AdminActivityCard key={`${addr.id}-revisit`} address={addr} type="revisit" />)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                ) : (
                    <div className="text-center py-16 bg-white rounded-lg border border-dashed">
                        <Icon name="search" size={48} className="mx-auto mb-4 text-gray-300" />
                        <p className="text-gray-600 font-medium">No se encontraron resultados</p>
                        <p className="text-sm text-gray-500 mt-1">Intenta con otros filtros o términos de búsqueda.</p>
                    </div>
                )}
            </div>
        </div>

        {/* Modales de confirmación (sin cambios) */}
        <AssignTerritoryModal 
            isOpen={reassignState.isOpen}
            onClose={() => setReassignState({ isOpen: false, address: null, type: '' })}
            onAssign={executeReassign}
            territoryName={`la ${reassignState.type === 'study' ? 'estudio' : 'revisita'}`}
            isProcessing={isProcessing}
        />
        <ConfirmationModal
            isOpen={unmarkState.isOpen}
            onConfirm={executeUnmark}
            onCancel={() => setUnmarkState({ isOpen: false, address: null, type: '' })}
            title={`¿Liberar ${unmarkState.type === 'study' ? 'Estudio' : 'Revisita'}?`}
            message={`Esta acción desmarcará la dirección como ${unmarkState.type === 'study' ? 'estudio' : 'revisita'} por completo. ¿Estás seguro?`}
            confirmText="Sí, liberar ahora"
            type="danger"
            isLoading={isProcessing}
        />
        </>
    );
};
// --- FIN: Nuevo Módulo de Gestión de Actividad ---


const AdminModal = ({ isOpen, onClose }) => {
    const { 
        currentUser, 
        handleBackupData,
        handleFileSelectedForRestore,
        isRestoreConfirmOpen,
        isProcessingRestore,
        executeRestoreData,
        cancelRestore,
        restoreFullBackupInputRef,
        handleBackupAddresses,
        handleFileSelectedForRestoreAddresses,
        isRestoreAddressesConfirmOpen,
        isProcessingAddressRestore,
        executeRestoreAddresses,
        cancelRestoreAddresses,
        restoreAddressesOnlyInputRef,
        handleResetAllTerritories,
        handleResetSingleTerritory,
        territories,
        showToast, 
        pendingProposalsCount,
        db,
        allUsers, // Añadido para pasarlo al nuevo manager
        addresses // Añadido para pasarlo al nuevo manager
    } = useContext(AppContext);
    
    const [view, setView] = useState('loading');
    const [isConfirmResetOpen, setIsConfirmResetOpen] = useState(false);
    const [isProcessingReset, setIsProcessingReset] = useState(false);
    const [proposals, setProposals] = useState([]);
    const [loadingProposals, setLoadingProposals] = useState(false);
    
    const [resetTarget, setResetTarget] = useState(null);
    const [isConfirmSingleResetOpen, setIsConfirmSingleResetOpen] = useState(false);
    const [isProcessingSingleReset, setIsProcessingSingleReset] = useState(false);
    const [isIndividualResetVisible, setIsIndividualResetVisible] = useState(false);
    
    const [proposalTab, setProposalTab] = useState('pending');
    const [historyProposals, setHistoryProposals] = useState([]);
    const [loadingHistory, setLoadingHistory] = useState(false);
    
    useEffect(() => {
        if (isOpen) {
            setView(currentUser?.role === 'admin' ? 'actions' : 'no_access');
            setIsConfirmResetOpen(false);
            setIsConfirmSingleResetOpen(false);
            setResetTarget(null);
            setIsIndividualResetVisible(false);
        }
    }, [isOpen, currentUser]);

    useEffect(() => {
        if (view === 'proposals' && db) {
            setLoadingProposals(true);
            const unsubscribe = db.collection('addressChangeProposals')
                .where('status', '==', 'pending')
                .onSnapshot(
                    snapshot => {
                        const proposalsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setProposals(proposalsData);
                        setLoadingProposals(false);
                    },
                    error => {
                        console.error('Error al cargar propuestas:', error);
                        setLoadingProposals(false);
                    }
                );
            return () => unsubscribe();
        }
    }, [view, db]);
    
    useEffect(() => {
        if (view === 'proposals' && proposalTab === 'history' && db) {
            setLoadingHistory(true);
            const unsubscribe = db.collection('addressChangeProposals')
                .where('status', 'in', ['approved', 'rejected'])
                .orderBy('reviewedAt', 'desc')
                .limit(100)
                .onSnapshot(
                    snapshot => {
                        const historyData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setHistoryProposals(historyData);
                        setLoadingHistory(false);
                    },
                    error => {
                        console.error('Error al cargar historial:', error);
                        setLoadingHistory(false);
                    }
                );
            return () => unsubscribe();
        }
    }, [view, proposalTab, db]);

    const handleApproveEdit = async (proposal) => {
        try {
            showToast('Aprobando cambios...', 'info');
            
            // Si es una propuesta de nueva dirección
            if (proposal.proposalType === 'new') {
                // Crear la nueva dirección
                const newAddressData = {
                    ...proposal.proposed,
                    territoryId: proposal.territoryId,
                    isVisited: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('addresses').add(newAddressData);
                
                // Actualizar la propuesta como aprobada
                await db.collection('addressChangeProposals').doc(proposal.id).update({
                    status: 'approved',
                    reviewedBy: currentUser.name,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    notificationRead: false
                });
                
                showToast(`✅ Nueva dirección aprobada y creada.`, 'success');
            } else {
                // Si es una edición de dirección existente
                const updateData = {
                    ...proposal.proposed,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('addresses').doc(proposal.addressId).update(updateData);
                
                await db.collection('addressChangeProposals').doc(proposal.id).update({
                    status: 'approved',
                    reviewedBy: currentUser.name,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    notificationRead: false
                });
                
                const changesCount = proposal.changes ? Object.keys(proposal.changes).length : 1;
                showToast(`✅ ${changesCount} cambio(s) aprobado(s) y notificado(s).`, 'success');
            }
        } catch (error) {
            console.error('Error al aprobar:', error);
            showToast('Error al aprobar los cambios.', 'error');
        }
    };

    const handleApproveDeletion = async (proposal) => {
        try {
            showToast('Procesando eliminación...', 'info');
            await db.collection('addresses').doc(proposal.addressId).delete();
            await db.collection('addressChangeProposals').doc(proposal.id).update({
                status: 'approved',
                reviewedBy: currentUser.name,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                notificationRead: false
            });
            showToast('✅ Dirección eliminada y propuesta aprobada.', 'success');
        } catch (error) {
            console.error('Error al aprobar eliminación:', error);
            showToast('Error al procesar la eliminación.', 'error');
        }
    };

    const [rejectModalData, setRejectModalData] = useState({ isOpen: false, proposalId: null, proposalInfo: null });
    const [rejectReason, setRejectReason] = useState('');
    
    const openRejectModal = (proposalId, proposalInfo) => {
        setRejectModalData({ isOpen: true, proposalId, proposalInfo });
        setRejectReason('');
    };
    
    const closeRejectModal = () => {
        setRejectModalData({ isOpen: false, proposalId: null, proposalInfo: null });
        setRejectReason('');
    };
    
    const handleRejectProposal = async () => {
        if (!rejectModalData.proposalId || !rejectReason.trim()) {
            showToast('Por favor, escribe una razón para el rechazo.', 'warning');
            return;
        }
        
        try {
            await db.collection('addressChangeProposals').doc(rejectModalData.proposalId).update({
                status: 'rejected',
                reviewedBy: currentUser.name,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectionReason: rejectReason.trim(),
                notificationRead: false
            });
            showToast('Propuesta rechazada con razón enviada.', 'info');
            closeRejectModal();
        } catch (error) {
            console.error('Error al rechazar:', error);
            showToast('Error al rechazar la propuesta.', 'error');
        }
    };
    
    const handleResetConfirmed = async () => {
        setIsProcessingReset(true);
        try {
            await handleResetAllTerritories();
            showToast('¡Todos los territorios han sido reiniciados!', 'success');
        } catch (error) {
            showToast('Error al reiniciar los territorios.', 'error');
        } finally {
            setIsProcessingReset(false);
            setIsConfirmResetOpen(false);
        }
    };
    
    const handleSingleResetClick = (territory) => {
        setResetTarget(territory);
        setIsConfirmSingleResetOpen(true);
    };

    const handleSingleResetConfirmed = async () => {
        if (!resetTarget) return;
        setIsProcessingSingleReset(true);
        try {
            await handleResetSingleTerritory(resetTarget.id);
        } catch (error) {
            showToast('Error al reiniciar el territorio individual.', 'error');
        } finally {
            setIsProcessingSingleReset(false);
            setIsConfirmSingleResetOpen(false);
            setResetTarget(null);
        }
    };

    const renderContent = () => {
        switch (view) {
            case 'loading':
                return (
                    <div className="flex-1 flex items-center justify-center p-8">
                        <div className="animate-spin w-12 h-12 border-4 border-gray-800 border-t-transparent rounded-full"></div>
                    </div>
                );
            case 'no_access':
                return (
                    <div className="flex-1 flex items-center justify-center p-8">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icon name="shield" size={40} className="text-red-500" />
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 mb-2">Acceso Denegado</h3>
                            <p className="text-gray-600">No tienes los permisos para acceder aquí.</p>
                        </div>
                    </div>
                );
            case 'actions':
                const adminOptions = [
                    { id: 'addresses', title: 'Gestión de Direcciones', description: 'Administrar todas las direcciones', icon: 'fileText', color: 'indigo', action: () => setView('addressManager') },
                    { id: 'activity', title: 'Gestión de Actividad', description: 'Reasignar estudios y revisitas', icon: 'bookmark', color: 'purple', action: () => setView('activityManager') },
                    { id: 'proposals', title: 'Propuestas de Cambios', description: pendingProposalsCount > 0 ? `${pendingProposalsCount} pendientes` : 'Ver cambios propuestos', icon: 'checkSquare', color: 'orange', badge: pendingProposalsCount, action: () => setView('proposals') },
                    { id: 'stats', title: 'Estadísticas', description: 'Ver métricas y análisis detallados', icon: 'barChart', color: 'purple', action: () => setView('stats') },
                    { id: 'reports', title: 'Reportes', description: 'Generar informes y S-13', icon: 'printer', color: 'green', action: () => setView('reports') },
                    { id: 'backup', title: 'Backup y Restauración', description: 'Gestionar copias de seguridad', icon: 'uploadCloud', color: 'blue', action: () => setView('backup') },
                    { id: 'audit', title: 'Auditoría de Datos', description: 'Verificar y corregir inconsistencias', icon: 'activity', color: 'yellow', action: () => setView('audit') },
                    { id: 'danger', title: 'Zona de Peligro', description: 'Acciones irreversibles', icon: 'alertCircle', color: 'red', action: () => setView('danger') }
                ];
                return (
                    <div className="flex-1 overflow-y-auto p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {adminOptions.map(option => (
                                <button key={option.id} onClick={option.action} className={`relative p-6 bg-white border-2 border-gray-200 rounded-lg text-left transition-all hover:border-${option.color}-500 hover:bg-${option.color}-50 group`}>
                                    {option.badge > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold animate-pulse">{option.badge}</span>}
                                    <div className="flex items-start">
                                        <div className={`w-12 h-12 rounded-lg flex items-center justify-center mr-4 transition-all bg-${option.color}-100 text-${option.color}-600 group-hover:bg-${option.color}-200`}>
                                            <Icon name={option.icon} size={24} />
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="text-lg font-semibold text-gray-900 mb-1">{option.title}</h4>
                                            <p className="text-sm text-gray-600">{option.description}</p>
                                        </div>
                                        <Icon name="chevronRight" size={20} className="text-gray-400 mt-1 transition-transform group-hover:translate-x-1" />
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            case 'activityManager':
                return <ActivityManager onBack={() => setView('actions')} users={allUsers} addresses={addresses} />;
            case 'backup':
                return (
                    <div className="flex-1 overflow-y-auto p-6">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-100"><Icon name="arrowLeft" size={20} /></button>
                            <h3 className="text-xl font-bold text-gray-900 ml-2">Backup y Restauración</h3>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-gray-50 border border-gray-200 rounded-lg p-6">
                                <h4 className="font-semibold text-gray-900 mb-4 flex items-center"><Icon name="fileText" size={20} className="mr-2 text-gray-600" />Exclusivamente Direcciones</h4>
                                <div className="space-y-3">
                                    <button onClick={handleBackupAddresses} className="w-full bg-gray-700 text-white font-medium py-3 px-4 rounded-lg hover:bg-gray-800 transition-all flex items-center justify-center"><Icon name="download" size={16} className="mr-2"/>Crear Backup (Solo Direcciones)</button>
                                    <div>
                                        <input ref={restoreAddressesOnlyInputRef} type="file" accept=".json" onChange={handleFileSelectedForRestoreAddresses} className="hidden" />
                                        <button onClick={() => restoreAddressesOnlyInputRef.current?.click()} disabled={isProcessingAddressRestore} className="w-full bg-gray-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-gray-700 disabled:bg-gray-400 transition-all flex items-center justify-center"><Icon name="rotateCcw" size={16} className="mr-2"/>{isProcessingAddressRestore ? 'Procesando...' : 'Restaurar (Solo Direcciones)'}</button>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <h4 className="font-semibold text-blue-900 mb-4 flex items-center"><Icon name="uploadCloud" size={20} className="mr-2 text-blue-600" />Sistema Completo</h4>
                                <div className="space-y-3">
                                    <button onClick={handleBackupData} disabled={isProcessingRestore} className="w-full bg-blue-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 transition-all flex items-center justify-center"><Icon name="download" size={16} className="mr-2"/>Crear Backup Completo</button>
                                    <div>
                                        <input ref={restoreFullBackupInputRef} type="file" accept=".json" onChange={handleFileSelectedForRestore} className="hidden" />
                                        <button onClick={() => restoreFullBackupInputRef.current?.click()} disabled={isProcessingRestore} className="w-full bg-green-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-green-400 transition-all flex items-center justify-center"><Icon name="rotateCcw" size={16} className="mr-2"/>{isProcessingRestore ? 'Procesando...' : 'Restaurar Backup Completo'}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            case 'audit':
                return (
                    <div className="flex-1 overflow-y-auto p-6">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-100"><Icon name="arrowLeft" size={20} /></button>
                            <h3 className="text-xl font-bold text-gray-900 ml-2">Auditoría de Datos</h3>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                <h4 className="font-semibold text-yellow-900 mb-4 flex items-center">
                                    <Icon name="activity" size={20} className="mr-2 text-yellow-600" />
                                    Verificar Territorios Inconsistentes
                                </h4>
                                <p className="text-sm text-yellow-700 mb-4">
                                    Esta función busca territorios que tienen todas sus direcciones visitadas pero siguen marcados como "En uso" y los corrige automáticamente.
                                </p>
                                <button
                                    onClick={async () => {
                                        setIsProcessingReset(true);
                                        showToast('Iniciando auditoría...', 'info');
                                        try {
                                            let corrections = 0;
                                            const territoriosSnapshot = await db.collection('territories')
                                                .where('status', '==', 'En uso')
                                                .get();
                                            
                                            for (const territoryDoc of territoriosSnapshot.docs) {
                                                const territoryData = territoryDoc.data();
                                                const territoryId = territoryDoc.id;
                                                
                                                const addressesSnapshot = await db.collection('addresses')
                                                    .where('territoryId', '==', territoryId)
                                                    .get();
                                                
                                                if (!addressesSnapshot.empty) {
                                                    const allVisited = addressesSnapshot.docs.every(doc => 
                                                        doc.data().isVisited === true
                                                    );
                                                    
                                                    if (allVisited) {
                                                        await db.collection('territories').doc(territoryId).update({
                                                            status: 'Terminado',
                                                            assignedTo: null,
                                                            assignedDate: null,
                                                            lastCompletedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                                            lastCompletedBy: territoryData.assignedTo || 'Corrección automática'
                                                        });
                                                        
                                                        await db.collection('territoryHistory').add({
                                                            territoryId: territoryId,
                                                            territoryName: territoryData.name,
                                                            assignedTo: territoryData.assignedTo || 'Corrección automática',
                                                            status: 'Terminado',
                                                            completedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                                            assignedDate: territoryData.assignedDate || firebase.firestore.FieldValue.serverTimestamp(),
                                                            note: 'Corregido por auditoría'
                                                        });
                                                        
                                                        corrections++;
                                                    }
                                                }
                                            }
                                            
                                            if (corrections > 0) {
                                                showToast(`✅ Se corrigieron ${corrections} territorio(s)`, 'success');
                                            } else {
                                                showToast('No se encontraron territorios inconsistentes', 'info');
                                            }
                                        } catch (error) {
                                            console.error('Error en auditoría:', error);
                                            showToast('Error al ejecutar la auditoría', 'error');
                                        } finally {
                                            setIsProcessingReset(false);
                                        }
                                    }}
                                    disabled={isProcessingReset}
                                    className="w-full bg-yellow-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-yellow-700 disabled:bg-yellow-400 transition-all flex items-center justify-center"
                                >
                                    <Icon name="activity" size={16} className="mr-2"/>
                                    {isProcessingReset ? 'Ejecutando auditoría...' : 'Ejecutar Auditoría'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            case 'danger':
                 return (
                    <div className="flex-1 overflow-y-auto p-6">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-100"><Icon name="arrowLeft" size={20} /></button>
                            <h3 className="text-xl font-bold text-red-700 ml-2">Zona de Peligro</h3>
                        </div>
                        <div className="bg-red-50 border-2 border-red-200 rounded-lg p-6">
                            <div className="border-b border-red-200 pb-6 mb-6">
                                <button onClick={() => setIsIndividualResetVisible(prev => !prev)} className="w-full flex items-center justify-between text-left" aria-expanded={isIndividualResetVisible}>
                                    <div>
                                        <h5 className="font-semibold text-red-900 flex items-center"><Icon name="flag" size={20} className="mr-2 text-red-600" />Reiniciar un territorio individual</h5>
                                        <p className="text-sm text-red-700 mt-1">Pondrá el territorio como "Disponible"</p>
                                    </div>
                                    <Icon name="chevronRight" size={24} className={`text-red-500 transition-transform duration-300 ${isIndividualResetVisible ? 'rotate-90' : ''}`} />
                                </button>
                                {isIndividualResetVisible && (
                                    <div className="mt-4 max-h-60 overflow-y-auto space-y-2 pr-2">
                                        {territories.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true})).map(t => (
                                            <div key={t.id} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-red-100">
                                                <span className="font-medium text-gray-700">{t.name}</span>
                                                <button onClick={() => handleSingleResetClick(t)} disabled={isProcessingSingleReset} className="text-xs bg-red-100 text-red-700 font-semibold px-3 py-1.5 rounded-md hover:bg-red-200 transition-colors disabled:opacity-50">Reiniciar</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div>
                                <h5 className="font-semibold text-red-900 mb-2 flex items-center"><Icon name="alertCircle" size={20} className="mr-2 text-red-600" />Reiniciar todos los territorios</h5>
                                <p className="text-sm text-red-700 mb-4">Esta acción es irreversible y borra todo el progreso</p>
                                <button onClick={() => setIsConfirmResetOpen(true)} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors">Reiniciar Todo</button>
                            </div>
                        </div>
                    </div>
                );
            case 'addressManager':
                return <AddressManager onBack={() => setView('actions')} />;
case 'proposals':
                const ProposalCard = ({ proposal, showActions = true }) => {
                    const territory = territories.find(t => t.id === proposal.territoryId);
                    
                    // Configuración visual mejorada
                    const typeConfig = {
                        delete: {
                            icon: 'trash',
                            title: 'Eliminar Dirección',
                            gradient: 'from-red-500 to-pink-600',
                            lightBg: 'bg-red-50',
                            borderColor: 'border-red-200',
                            iconBg: 'bg-red-100',
                            iconColor: 'text-red-600'
                        },
                        edit: {
                            icon: 'edit',
                            title: 'Modificar Dirección',
                            gradient: 'from-blue-500 to-purple-600',
                            lightBg: 'bg-blue-50',
                            borderColor: 'border-blue-200',
                            iconBg: 'bg-blue-100',
                            iconColor: 'text-blue-600'
                        },
                        new: {
                            icon: 'plus',
                            title: 'Nueva Dirección',
                            gradient: 'from-green-500 to-teal-600',
                            lightBg: 'bg-green-50',
                            borderColor: 'border-green-200',
                            iconBg: 'bg-green-100',
                            iconColor: 'text-green-600'
                        }
                    };
                    
                    const statusBadge = {
                        pending: { text: 'Pendiente', bg: 'bg-yellow-100', color: 'text-yellow-800', icon: 'clock' },
                        approved: { text: 'Aprobada', bg: 'bg-green-100', color: 'text-green-800', icon: 'checkCircle' },
                        rejected: { text: 'Rechazada', bg: 'bg-red-100', color: 'text-red-800', icon: 'x' }
                    };
                    
                    const config = typeConfig[proposal.proposalType] || typeConfig.edit;
                    const status = statusBadge[proposal.status] || statusBadge.pending;
                    
                    // --- INICIO: Renderizado Defensivo de Cambios ---
                    const renderChanges = () => {
                        // Si el objeto 'changes' no existe o está vacío, muestra el original vs propuesto de forma simple
                        if (!proposal.changes || Object.keys(proposal.changes).length === 0) {
                            return (
                                <div className="border-l-4 border-blue-400 pl-3 py-2">
                                     <p className="text-xs font-semibold text-gray-700 mb-2">Dirección</p>
                                    <div className="space-y-2">
                                        {proposal.original && (
                                            <div className="flex items-start space-x-2">
                                                <div className="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                                    <Icon name="x" size={12} className="text-red-600" />
                                                </div>
                                                <div className="flex-1">
                                                    <p className="text-xs text-gray-500">Antes:</p>
                                                    <p className="text-sm text-gray-600 line-through">
                                                        {proposal.original.address || <span className="italic text-gray-400">No disponible</span>}
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                        {proposal.proposed && (
                                             <div className="flex items-start space-x-2">
                                                <div className="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                                    <Icon name="checkCircle" size={12} className="text-green-600" />
                                                </div>
                                                <div className="flex-1">
                                                    <p className="text-xs text-gray-500">Ahora:</p>
                                                    <p className="text-sm font-semibold text-green-700">
                                                        {proposal.proposed.address || <span className="italic text-gray-400">No disponible</span>}
                                                    </p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        }
                        
                        // Si el objeto 'changes' existe, itera sobre él de forma segura
                        return Object.keys(proposal.changes).map(fieldName => {
                            const change = proposal.changes[fieldName];
                            const fieldLabels = {
                                address: 'Dirección', notes: 'Notas', gender: 'Género', isRevisita: 'Revisita',
                                isEstudio: 'Estudio', revisitaBy: 'Revisita por', estudioBy: 'Estudio por',
                                mapUrl: 'Enlace de Maps', latitude: 'Latitud', longitude: 'Longitud'
                            };

                            const formatValue = (value, field) => {
                                if (value === null || typeof value === 'undefined') return <span className="italic text-gray-400">Vacío</span>;
                                if (field === 'isRevisita' || field === 'isEstudio') return value ? 'Sí' : 'No';
                                return String(value);
                            };

                            return (
                                <div key={fieldName} className="border-l-4 border-blue-400 pl-3 py-2">
                                    <p className="text-xs font-semibold text-gray-700 mb-2">{fieldLabels[fieldName] || fieldName}</p>
                                    <div className="space-y-2">
                                        <div className="flex items-start space-x-2">
                                            <div className="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><Icon name="x" size={12} className="text-red-600" /></div>
                                            <div className="flex-1">
                                                <p className="text-xs text-gray-500">Antes:</p>
                                                <p className="text-sm text-gray-600 line-through">{formatValue(change?.original, fieldName)}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-start space-x-2">
                                            <div className="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><Icon name="checkCircle" size={12} className="text-green-600" /></div>
                                            <div className="flex-1">
                                                <p className="text-xs text-gray-500">Ahora:</p>
                                                <p className="text-sm font-semibold text-green-700">{formatValue(change?.proposed, fieldName)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        });
                    };
                    // --- FIN: Renderizado Defensivo de Cambios ---

                    return (
                        <div className={`group relative bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden ${proposal.status === 'pending' ? 'ring-2 ring-yellow-400 ring-opacity-50' : ''}`}>
                            <div className={`bg-gradient-to-r ${config.gradient} p-1`}>
                                <div className="bg-white rounded-t-lg p-4">
                                    <div className="flex items-start justify-between">
                                        <div className="flex items-start space-x-3">
                                            <div className={`p-3 rounded-lg ${config.iconBg} ${config.iconColor}`}><Icon name={config.icon} size={24} /></div>
                                            <div>
                                                <h4 className="font-bold text-gray-900 text-base">{config.title}</h4>
                                                <div className="flex items-center space-x-2 mt-1">
                                                    <Icon name="user" size={14} className="text-gray-400" />
                                                    <span className="text-sm text-gray-600">{proposal.proposedBy}</span>
                                                    <span className="text-gray-300">•</span>
                                                    <span className="text-xs text-gray-500">{formatRelativeTime(proposal.proposedAt?.toDate())}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${status.bg} ${status.color}`}><Icon name={status.icon} size={12} className="mr-1" />{status.text}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-5 space-y-4">
                                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div className="flex items-center space-x-2"><Icon name="mapPin" size={16} className="text-gray-500" /><span className="text-sm font-medium text-gray-700">Territorio</span></div>
                                    <span className="font-bold text-gray-900">{territory?.name || 'Desconocido'}</span>
                                </div>
                                
                                {proposal.proposalType === 'delete' && (
                                    <div className="p-4 bg-red-50 border border-red-100 rounded-lg">
                                        <p className="text-xs font-medium text-red-700 uppercase tracking-wider mb-1">Dirección a eliminar</p>
                                        <p className="font-semibold text-red-900">{proposal.original?.address || 'Dirección no especificada'}</p>
                                    </div>
                                )}
                                
                                {proposal.proposalType === 'edit' && (
                                    <div className="p-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border border-gray-200">
                                        <p className="text-xs font-medium text-gray-600 uppercase tracking-wider mb-3 flex items-center"><Icon name="activity" size={14} className="mr-1" />Cambios Propuestos</p>
                                        <div className="space-y-3">{renderChanges()}</div>
                                    </div>
                                )}

                                {proposal.proposalType === 'new' && (
                                     <div className="p-4 bg-green-50 border border-green-100 rounded-lg">
                                        <p className="text-xs font-medium text-green-700 uppercase tracking-wider mb-1">Nueva dirección propuesta</p>
                                        <p className="font-semibold text-green-900">{proposal.proposed?.address || 'Dirección no especificada'}</p>
                                         {proposal.proposed?.notes && <p className="text-sm text-gray-600 italic mt-1">Nota: "{proposal.proposed.notes}"</p>}
                                    </div>
                                )}
                                
                                {proposal.changeReason && (
                                    <div className="p-4 bg-amber-50 border border-amber-100 rounded-lg">
                                        <p className="text-xs font-medium text-amber-700 mb-1">Motivo</p>
                                        <p className="text-sm text-amber-900 italic">"{proposal.changeReason}"</p>
                                    </div>
                                )}
                                
                                {proposal.status !== 'pending' && proposal.reviewedBy && (
                                    <div className={`p-4 rounded-lg border ${proposal.status === 'approved' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                        <p className="text-sm font-semibold text-gray-900">{proposal.status === 'approved' ? 'Aprobada' : 'Rechazada'} por {proposal.reviewedBy}</p>
                                        <p className="text-xs text-gray-500 mt-0.5">{formatRelativeTime(proposal.reviewedAt?.toDate())}</p>
                                        {proposal.status === 'rejected' && proposal.rejectionReason && (<div className="mt-3 pt-3 border-t border-red-200"><p className="text-xs font-medium text-red-700 mb-1">Razón:</p><p className="text-sm text-red-900 italic">"{proposal.rejectionReason}"</p></div>)}
                                    </div>
                                )}
                            </div>
                            
                            {showActions && proposal.status === 'pending' && (
                                <div className="p-4 bg-gray-50 border-t border-gray-200">
                                    <div className="flex justify-end space-x-3">
                                        <button onClick={() => openRejectModal(proposal.id, {})} className="px-4 py-2 bg-white border-2 border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all flex items-center"><Icon name="x" size={16} className="mr-2" />Rechazar</button>
                                        <button onClick={() => proposal.proposalType === 'delete' ? handleApproveDeletion(proposal) : handleApproveEdit(proposal)} className={`px-4 py-2 text-white font-medium rounded-lg transition-all flex items-center ${proposal.proposalType === 'delete' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}><Icon name="checkCircle" size={16} className="mr-2" />Aprobar</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                };
                
                return (
                    <div className="fixed inset-0 z-[75] bg-white flex flex-col">
                        <div className="bg-gray-50 border-b border-gray-200">
                            <div className="p-6 pb-0">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center">
                                        <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-200 mr-3">
                                            <Icon name="arrowLeft" size={20} />
                                        </button>
                                        <h2 className="text-xl font-semibold text-gray-800">Gestión de Propuestas</h2>
                                    </div>
                                    {proposalTab === 'pending' && (
                                        <span className="px-3 py-1 bg-orange-100 text-orange-700 text-sm font-semibold rounded-full">
                                            {proposals.length} pendientes
                                        </span>
                                    )}
                                </div>
                                
                                <div className="flex space-x-1">
                                    <button onClick={() => setProposalTab('pending')} className={`flex-1 px-4 py-3 font-medium text-sm transition-all border-b-2 ${proposalTab === 'pending' ? 'text-gray-900 border-gray-800 bg-white' : 'text-gray-500 border-transparent hover:text-gray-700'}`}><Icon name="clock" size={16} className="inline mr-2" />Pendientes ({proposals.length})</button>
                                    <button onClick={() => setProposalTab('history')} className={`flex-1 px-4 py-3 font-medium text-sm transition-all border-b-2 ${proposalTab === 'history' ? 'text-gray-900 border-gray-800 bg-white' : 'text-gray-500 border-transparent hover:text-gray-700'}`}><Icon name="clock" size={16} className="inline mr-2" />Historial</button>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto bg-gray-50">
                            {proposalTab === 'pending' ? (
                                loadingProposals ? (
                                    <div className="flex items-center justify-center h-full"><div className="animate-spin w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full mx-auto"></div></div>
                                ) : proposals.length === 0 ? (
                                    <div className="flex items-center justify-center h-full px-8">
                                        <div className="text-center">
                                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="checkCircle" size={40} className="text-green-500" /></div>
                                            <h3 className="text-lg font-semibold text-gray-700">¡Todo revisado!</h3>
                                            <p className="text-sm text-gray-500">No hay propuestas pendientes.</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {proposals.map(proposal => (<ProposalCard key={proposal.id} proposal={proposal} showActions={true} />))}
                                    </div>
                                )
                            ) : (
                                loadingHistory ? (
                                    <div className="flex items-center justify-center h-full"><div className="animate-spin w-12 h-12 border-4 border-gray-500 border-t-transparent rounded-full mx-auto"></div></div>
                                ) : historyProposals.length === 0 ? (
                                    <div className="flex items-center justify-center h-full px-8"><div className="text-center"><div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="clock" size={40} className="text-gray-400" /></div><h3 className="text-lg font-semibold text-gray-700">Sin historial</h3><p className="text-sm text-gray-500">No hay propuestas procesadas aún.</p></div></div>
                                ) : (
                                    <div className="p-6">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                            <div className="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow"><div className="flex items-center justify-between mb-3"><div className="w-12 h-12 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center"><Icon name="fileText" size={24} className="text-gray-600" /></div><p className="text-3xl font-bold text-gray-900">{historyProposals.length}</p></div><p className="text-sm text-gray-600 font-medium">Total procesadas</p></div>
                                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow"><div className="flex items-center justify-between mb-3"><div className="w-12 h-12 bg-gradient-to-br from-green-100 to-emerald-200 rounded-lg flex items-center justify-center"><Icon name="checkCircle" size={24} className="text-green-600" /></div><p className="text-3xl font-bold text-green-700">{historyProposals.filter(p => p.status === 'approved').length}</p></div><p className="text-sm text-green-700 font-medium">Aprobadas</p></div>
                                            <div className="bg-gradient-to-br from-red-50 to-pink-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow"><div className="flex items-center justify-between mb-3"><div className="w-12 h-12 bg-gradient-to-br from-red-100 to-pink-200 rounded-lg flex items-center justify-center"><Icon name="x" size={24} className="text-red-600" /></div><p className="text-3xl font-bold text-red-700">{historyProposals.filter(p => p.status === 'rejected').length}</p></div><p className="text-sm text-red-700 font-medium">Rechazadas</p></div>
                                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow"><div className="flex items-center justify-between mb-3"><div className="w-12 h-12 bg-gradient-to-br from-blue-100 to-indigo-200 rounded-lg flex items-center justify-center"><Icon name="barChart" size={24} className="text-blue-600" /></div><p className="text-3xl font-bold text-blue-700">{Math.round((historyProposals.filter(p => p.status === 'approved').length / historyProposals.length) * 100) || 0}%</p></div><p className="text-sm text-blue-700 font-medium">Tasa aprobación</p></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{historyProposals.map(proposal => (<ProposalCard key={proposal.id} proposal={proposal} showActions={false} />))}</div>
                                    </div>
                                )
                            )}
                        </div>
                    </div>
                );

case 'stats':
                return (
                    <div className="flex-1 overflow-y-auto">
                        <div className="flex items-center mb-6 p-6">
                            <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-100">
                                <Icon name="arrowLeft" size={20} />
                            </button>
                            <h3 className="text-xl font-bold text-gray-900 ml-2">Estadísticas Generales</h3>
                        </div>
                        <div className="px-6 pb-6">
                            <StatisticsModal 
                                isOpen={true} 
                                onClose={() => setView('actions')} 
                            />
                        </div>
                    </div>
                );
                
            case 'reports':
                return (
                    <div className="flex-1 overflow-y-auto">
                        <div className="flex items-center mb-6 p-6">
                            <button onClick={() => setView('actions')} className="p-2 rounded-full hover:bg-gray-100">
                                <Icon name="arrowLeft" size={20} />
                            </button>
                            <h3 className="text-xl font-bold text-gray-900 ml-2">Generar Reportes</h3>
                        </div>
                        <div className="px-6 pb-6">
                            <ReportsModal 
                                isOpen={true} 
                                onClose={() => setView('actions')} 
                            />
                        </div>
                    </div>
                );

            default:
                return <div className="p-6 text-center">Vista no reconocida</div>;
        }
    };
    
    return (
        <>
            <Modal isOpen={isOpen} onClose={onClose} title="" size="lg">
                <div className="flex flex-col h-full">
                    <div className="bg-gray-50 border-b border-gray-200 p-6">
                        <div className="flex items-center justify-between">
                            <h2 className="text-xl font-semibold text-gray-800">Panel de Administrador</h2>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-lg transition-colors"><Icon name="x" size={20} className="text-gray-600" /></button>
                        </div>
                    </div>
                    {renderContent()}
                </div>
            </Modal>
            
            <ConfirmationModal isOpen={isRestoreConfirmOpen} onCancel={cancelRestore} onConfirm={executeRestoreData} title="¿Restaurar Backup Completo?" message="Esto reemplazará TODOS los datos actuales con los del archivo. Esta acción no se puede deshacer. ¿Seguro?" confirmText="Sí, restaurar ahora" type="danger" isLoading={isProcessingRestore} />
            <ConfirmationModal isOpen={isRestoreAddressesConfirmOpen} onCancel={cancelRestoreAddresses} onConfirm={executeRestoreAddresses} title="¿Restaurar Solo Direcciones?" message="Esto borrará TODAS las direcciones actuales y las reemplazará con las del archivo. Los territorios y el historial no se verán afectados. Esta acción no se puede deshacer. ¿Seguro?" confirmText="Sí, restaurar direcciones" type="warning" isLoading={isProcessingAddressRestore} />
            <ConfirmationModal isOpen={isConfirmResetOpen} onCancel={() => setIsConfirmResetOpen(false)} onConfirm={handleResetConfirmed} title="¿Estás absolutamente seguro?" message="Esta acción reiniciará TODOS los territorios y borrará TODO el historial. No se puede deshacer." confirmText="Sí, reiniciar todo" type="danger"isLoading={isProcessingReset} />
            <ConfirmationModal isOpen={isConfirmSingleResetOpen} onCancel={() => setIsConfirmSingleResetOpen(false)} onConfirm={handleSingleResetConfirmed} title={`¿Reiniciar ${resetTarget?.name}?`} message="El territorio volverá a estar disponible y se reiniciará su progreso. Esta acción no se puede deshacer." confirmText="Sí, reiniciar" type="danger" isLoading={isProcessingSingleReset} />
        {/* Modal para escribir razón de rechazo */}
            <Modal isOpen={rejectModalData.isOpen} onClose={closeRejectModal} title="Razón del Rechazo" size="sm">
                <div className="p-6">
                    <div className="mb-4">
                        <p className="text-sm text-gray-600 mb-2">Propuesta a rechazar:</p>
                        <div className="bg-gray-50 p-3 rounded-lg">
                            {rejectModalData.proposalInfo?.type === 'delete' ? (
                                <>
                                    <p className="text-sm font-medium text-gray-700">Eliminación de dirección</p>
                                    <p className="text-sm text-gray-600 mt-1">{rejectModalData.proposalInfo?.address}</p>
                                </>
                            ) : (
                                <>
                                    <p className="text-sm font-medium text-gray-700">Cambio de dirección</p>
                                    <p className="text-sm text-gray-600 mt-1">
                                        <span className="line-through">{rejectModalData.proposalInfo?.original}</span>
                                        <Icon name="arrowRight" size={14} className="inline mx-1" />
                                        <span className="text-gray-900">{rejectModalData.proposalInfo?.proposed}</span>
                                    </p>
                                </>
                            )}
                            <p className="text-xs text-gray-500 mt-2">Territorio: {rejectModalData.proposalInfo?.territory}</p>
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <label htmlFor="rejectReason" className="block text-sm font-medium text-gray-700 mb-2">
                            Escribe la razón del rechazo <span className="text-red-500">*</span>
                        </label>
                        <textarea
                            id="rejectReason"
                            value={rejectReason}
                            onChange={(e) => setRejectReason(e.target.value)}
                            rows="4"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"
                            placeholder="Explica por qué se rechaza esta propuesta..."
                            autoFocus
                        />
                        <p className="mt-2 text-xs text-gray-500">
                            El publicador recibirá esta explicación para entender la decisión.
                        </p>
                    </div>
                    
                    <div className="flex justify-end space-x-3">
                        <button
                            onClick={closeRejectModal}
                            className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                        >
                            Cancelar
                        </button>
                        <button
                            onClick={handleRejectProposal}
                            disabled={!rejectReason.trim()}
                            className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed transition-colors"
                        >
                            Rechazar con Razón
                        </button>
                    </div>
                </div>
            </Modal>
        </>
    );
};
// --- FIN: Bloque AdminModal Actualizado ---

// --- FIN: Bloque AdminModal Actualizado ---




// --- Modal de Búsqueda Inteligente Mejorado (Pantalla Completa y Minimalista) ---
const SmartSearchModal = ({ isOpen, onClose, onNavigate }) => {
    const { addresses, territories } = useContext(AppContext);
    const [query, setQuery] = useState('');
    const [searchType, setSearchType] = useState('all');
    const debouncedQuery = useDebounce(query, 300);
    const inputRef = useRef(null);
    const [selectedIndex, setSelectedIndex] = useState(-1);
    
    useEffect(() => {
        if (isOpen) {
            setQuery('');
            setSearchType('all');
            setSelectedIndex(-1);
            setTimeout(() => inputRef.current?.focus(), 100);
        }
    }, [isOpen]);
    
    const results = useMemo(() => {
        if (debouncedQuery.length < 1) return [];
        const normalizedQuery = normalizeText(debouncedQuery);
        
        return addresses
            .filter(addr => {
                const addressText = normalizeText(addr.address);
                const nameText = normalizeText(addr.name || '');
                const notesText = normalizeText(addr.notes || '');
                
                switch (searchType) {
                    case 'addresses': return addressText.includes(normalizedQuery);
                    case 'names': return nameText.includes(normalizedQuery);
                    case 'notes': return notesText.includes(normalizedQuery);
                    default:
                        return addressText.includes(normalizedQuery) || 
                               nameText.includes(normalizedQuery) || 
                               notesText.includes(normalizedQuery);
                }
            })
            .map(addr => ({
                ...addr,
                territoryName: territories.find(t => t.id === addr.territoryId)?.name || 'Desconocido'
            }));
    }, [debouncedQuery, addresses, territories, searchType]);

    const handleResultClick = (address) => {
        const territory = territories.find(t => t.id === address.territoryId);
        if (territory) {
            onNavigate(territory, address.id);
        }
    };
    
    const highlightMatch = (text, query) => {
        if (!query || !text) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.split(regex).map((part, index) => 
            regex.test(part) ? 
                <mark key={index} className="bg-yellow-300 text-gray-900 px-0.5 rounded font-semibold">{part}</mark> : 
                part
        );
    };

    // Navegación con teclado
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (!isOpen || results.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                setSelectedIndex(prev => prev < results.length - 1 ? prev + 1 : 0);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setSelectedIndex(prev => prev > 0 ? prev - 1 : results.length - 1);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                handleResultClick(results[selectedIndex]);
            }
        };
        
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [isOpen, results, selectedIndex]);

    if (!isOpen) return null;

    const filterTabs = [
        { id: 'all', label: 'Todo', icon: 'apps' },
        { id: 'addresses', label: 'Direcciones', icon: 'home' },
        { id: 'names', label: 'Nombres', icon: 'user' },
        { id: 'notes', label: 'Notas', icon: 'fileText' }
    ];

    return (
<div className="fixed inset-0 z-[70] bg-white flex flex-col">            {/* Header minimalista */}
            <div className="bg-gray-50 border-b border-gray-200">
                <div className="p-4 pb-0">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold text-gray-800">Buscar Dirección</h2>
                        <button 
                            onClick={onClose}
                            className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                        >
                            <Icon name="x" size={24} className="text-gray-600" />
                        </button>
                    </div>
                    
                    {/* Barra de búsqueda */}
                    <div className="relative pb-4">
                        <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <Icon name="search" size={20} className="text-gray-400" />
                        </div>
                        <input
                            ref={inputRef}
                            type="text"
                            value={query}
                            onChange={(e) => {
                                setQuery(e.target.value);
                                setSelectedIndex(-1);
                            }}
                            placeholder="Escribe para buscar direcciones, nombres o notas..."
                            className="w-full pl-12 pr-12 py-3 bg-white border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                        />
                        {query && (
                            <button
                                onClick={() => setQuery('')}
                                className="absolute right-4 top-1/2 -translate-y-1/2 p-1.5 hover:bg-gray-100 rounded-lg transition-colors"
                            >
                                <Icon name="x" size={18} className="text-gray-400" />
                            </button>
                        )}
                    </div>
                </div>
                
                {/* Tabs de filtro minimalistas */}
                <div className="px-4 pb-3">
                    <div className="flex gap-2">
                        {filterTabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => {
                                    setSearchType(tab.id);
                                    setSelectedIndex(-1);
                                }}
                                className={`
                                    flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all
                                    ${searchType === tab.id 
                                        ? 'bg-gray-800 text-white' 
                                        : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50'
                                    }
                                `}
                            >
                                <Icon name={tab.icon} size={16} />
                                {tab.label}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
            
            {/* Resultados - ocupa el resto de la pantalla */}
            <div className="flex-1 overflow-y-auto bg-gray-50">
                {debouncedQuery ? (
                    results.length > 0 ? (
                        <div>
                            <p className="text-sm text-gray-500 px-4 py-3 bg-white border-b border-gray-200">
                                {results.length} {results.length === 1 ? 'resultado' : 'resultados'}
                            </p>
                            <div className="p-4 space-y-3">
                                {results.map((addr, index) => {
                                    const isSelected = index === selectedIndex;
                                    const genderIcon = {
                                        'Hombre': { icon: 'fa-person', color: 'text-blue-500' },
                                        'Mujer': { icon: 'fa-person-dress', color: 'text-pink-500' },
                                        'Pareja': { icon: 'fa-user-group', color: 'text-purple-500' },
                                        'Desconocido': { icon: 'fa-ban', color: 'text-gray-400' }
                                    }[addr.gender] || { icon: 'fa-ban', color: 'text-gray-400' };

                                    return (
                                        <div
                                            key={addr.id}
                                            onClick={() => handleResultClick(addr)}
                                            className={`
                                                p-4 rounded-lg cursor-pointer transition-all bg-white
                                                ${isSelected 
                                                    ? 'ring-2 ring-indigo-500 shadow-md' 
                                                    : 'border border-gray-200 hover:border-gray-300 hover:shadow-sm'
                                                }
                                            `}
                                        >
                                            <div className="flex items-start gap-3">
                                                {/* Icono de género */}
                                                <div className={`flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center ${genderIcon.color}`}>
                                                    <i className={`fas ${genderIcon.icon} text-lg`}></i>
                                                </div>
                                                
                                                <div className="flex-1 min-w-0">
                                                    {/* Dirección principal */}
                                                    <h4 className="font-semibold text-gray-900 text-base mb-1">
                                                        {highlightMatch(addr.address, debouncedQuery)}
                                                    </h4>
                                                    
                                                    {/* Nombre si existe */}
                                                    {addr.name && (
                                                        <p className="text-gray-600 text-sm mb-1">
                                                            <Icon name="user" size={14} className="inline mr-1 text-gray-400" />
                                                            {highlightMatch(addr.name, debouncedQuery)}
                                                        </p>
                                                    )}
                                                    
                                                    {/* Notas si existen */}
                                                    {addr.notes && (
                                                        <p className="text-gray-500 text-sm italic">
                                                            <Icon name="info" size={14} className="inline mr-1 text-gray-400" />
                                                            {highlightMatch(addr.notes, debouncedQuery)}
                                                        </p>
                                                    )}
                                                    
                                                    {/* Badges */}
                                                    <div className="flex items-center gap-2 mt-2">
                                                        <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                                                            <Icon name="mapPin" size={12} className="mr-1" />
                                                            {addr.territoryName}
                                                        </span>
                                                        
                                                        {addr.isRevisita && (
                                                            <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                                                                <i className="fas fa-bookmark mr-1"></i>
                                                                Revisita
                                                            </span>
                                                        )}
                                                        
                                                        {addr.isEstudio && (
                                                            <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                                                <i className="fas fa-book-open mr-1"></i>
                                                                Estudio
                                                            </span>
                                                        )}
                                                        
                                                        {addr.isVisited && (
                                                            <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                                                <Icon name="checkCircle" size={12} className="mr-1" />
                                                                Visitada
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {/* Flecha indicadora */}
                                                <Icon name="chevronRight" size={20} className={`flex-shrink-0 ${isSelected ? 'text-indigo-600' : 'text-gray-300'}`} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center h-full px-8">
                            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                <Icon name="search" size={40} className="text-gray-300" />
                            </div>
                            <h3 className="text-lg font-semibold text-gray-700 mb-2">Sin resultados</h3>
                            <p className="text-gray-500 text-center">
                                No se encontraron direcciones que coincidan con "{debouncedQuery}"
                            </p>
                            <p className="text-sm text-gray-400 mt-2">
                                Intenta con otros términos o filtros
                            </p>
                        </div>
                    )
                ) : (
                    <div className="flex flex-col items-center justify-center h-full px-8">
                        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <Icon name="search" size={40} className="text-gray-400" />
                        </div>
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">Comienza a buscar</h3>
                        <p className="text-gray-500 text-center">
                            Escribe algo para buscar en todas las direcciones
                        </p>
                        <div className="flex gap-2 mt-4">
                            <span className="text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600">Direcciones</span>
                            <span className="text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600">Nombres</span>
                            <span className="text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-600">Notas</span>
                        </div>
                    </div>
                )}
            </div>
            
            {/* Footer con tips (opcional) */}
            {debouncedQuery && results.length > 0 && (
                <div className="bg-white border-t border-gray-200 px-4 py-3">
                    <p className="text-xs text-gray-500 text-center">
                        💡 Usa las flechas ↑↓ para navegar y Enter para seleccionar
                    </p>
                </div>
            )}
        </div>
    );
};


// --- Componente Final: Tarjeta de Dirección con Icono Temático ---
// Reemplaza tu componente AddressCard existente con este código.

const AddressCard = memo(({ 
    address, 
    isAssigned, 
    index, 
    isHighlighted, 
    isNavigating, 
    onNavigate, 
    onStopHighlight, 
    viewMode, 
    isAdmin, 
    onEdit,
    // --- Nuevas propiedades para controlar la funcionalidad ---
    onUnmark, // Función para desmarcar (liberar)
    isToggleVisitedEnabled = true, // Activado por defecto
    isEditEnabled = true // Activado por defecto
}) => {
    const { handleToggleAddressStatus } = useContext(AppContext);
    const { showToast } = useToast();
    const [isUpdating, setIsUpdating] = useState(false);
    
    const drivingUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address.address)}&travelmode=driving`;
    const walkingUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address.address)}&travelmode=walking`;
    const transitUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address.address)}&travelmode=transit`;

    const GenderTag = ({ gender, colorClass = '' }) => {
        const styleConfig = {
            'Hombre':      { icon: 'fa-person', color: 'text-blue-600' },
            'Mujer':       { icon: 'fa-person-dress', color: 'text-pink-600' },
            'Pareja':      { icon: 'fa-user-group', color: 'text-purple-600' },
            'Desconocido': { icon: 'fa-ban', color: 'text-gray-500' }
        };
        const config = styleConfig[gender] || styleConfig['Desconocido'];
        return <i className={`fas ${config.icon} ${colorClass || config.color} text-lg`}></i>;
    };

    const DistanceTag = ({ distance }) => {
        if (distance == null || distance === Infinity) { return null; }
        const formattedDistance = distance < 1 ? `${Math.round(distance * 1000)} m` : `${distance.toFixed(1)} km`;
        return (
            <span className="ml-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                {formattedDistance}
            </span>
        );
    };
    
    const handleClick = async (e) => {
        // Detener si el clic fue en un botón
        if (e.target.closest('button, a')) return;
        
        // Solo ejecutar si la función está habilitada
        if (isAssigned && !isUpdating && isToggleVisitedEnabled) {
            if (isNavigating) {
                onStopHighlight();
            }
            setIsUpdating(true);
            try {
                await handleToggleAddressStatus(address.id, address.isVisited);
                if (navigator.vibrate) navigator.vibrate(50);
            } catch (error) { showToast('Error al actualizar dirección', 'error'); } 
            finally { setIsUpdating(false); }
        }
    };

    const handleEditClick = (e) => {
        e.stopPropagation();
        onEdit(address);
    };

    const handleNavClick = (e) => {
        e.stopPropagation();
        onNavigate();
    };

    const handleUnmarkClick = (e) => {
        e.stopPropagation();
        if (onUnmark) {
            onUnmark(address);
        }
    };
    
    const highlightClass = isHighlighted ? 'highlight-ripple' : '';
    const navigatingClass = isNavigating ? 'highlight-navigating' : '';

    const NavigationButtons = ({ a_styles, div_styles, button_styles }) => (
        <div className={`flex items-center rounded-full p-0.5 ${a_styles}`}>
            <a href={drivingUrl} target="_blank" rel="noopener noreferrer" onClick={handleNavClick} className={`px-3 py-2 rounded-full ${button_styles}`} title="Navegar en coche"><i className="fas fa-car text-base"></i></a>
            <div className={`w-px h-4 mx-1 ${div_styles}`}></div>
            <a href={walkingUrl} target="_blank" rel="noopener noreferrer" onClick={handleNavClick} className={`px-3 py-2 rounded-full ${button_styles}`} title="Navegar a pie"><i className="fas fa-person-walking text-base"></i></a>
            <div className={`w-px h-4 mx-1 ${div_styles}`}></div>
            <a href={transitUrl} target="_blank" rel="noopener noreferrer" onClick={handleNavClick} className={`px-3 py-2 rounded-full ${button_styles}`} title="Navegar en transporte público"><i className="fas fa-bus text-base"></i></a>
        </div>
    );

    if (viewMode === 'list') {
        const listNavStyles = address.isVisited 
            ? { a_styles: "bg-red-100", div_styles: "bg-red-300", button_styles: "text-red-800 hover:bg-red-200" }
            : { a_styles: "bg-green-100", div_styles: "bg-green-300", button_styles: "text-green-800 hover:bg-green-200" };
        return (
            <div id={`address-card-${address.id}`} className={`relative bg-white rounded-lg shadow-md flex items-center p-3 border-l-4 transition-all duration-300 ${address.isVisited ? 'border-red-700' : 'border-green-600'} ${highlightClass} ${navigatingClass}`} onClick={handleClick}>
                <div className="flex-1 min-w-0">
                    <p className={`font-semibold truncate ${address.isVisited ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{address.address}</p>
                    <div className="flex gap-2 mt-1">
                        {address.isRevisita && (<span className="text-xs font-bold text-purple-600"><i className="fas fa-bookmark mr-1"></i>Revisita: {address.revisitaBy}</span>)}
                        {address.isEstudio && (<span className="text-xs font-bold text-blue-600"><i className="fas fa-book-open mr-1"></i>Estudio: {address.estudioBy}</span>)}
                    </div>
                </div>
                <div className="flex items-center flex-shrink-0 ml-4 space-x-3"><DistanceTag distance={address.distance} /><NavigationButtons {...listNavStyles} /></div>
            </div>
        );
    }
    
    if (address.isVisited) {
        return (
            <div id={`address-card-${address.id}`} className={`relative rounded-xl bg-red-700 p-1 shadow-lg ${highlightClass} ${navigatingClass}`} onClick={handleClick}>
                <div className="bg-white rounded-lg p-4 border-2 border-red-200"><div className="flex flex-col h-full"><div className="flex items-start justify-between mb-2"><p className="text-red-900 font-semibold leading-tight flex-1 pr-2">{address.address}</p><div className="ml-4 flex-shrink-0"><GenderTag gender={address.gender} /></div></div>
                    <div className="space-y-2 mb-2">
                        {address.isRevisita && (<span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-purple-100 text-purple-800"><i className="fas fa-bookmark mr-1.5"></i>Revisita: {address.revisitaBy}</span>)}
                        {address.isEstudio && (<span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800"><i className="fas fa-book-open mr-1.5"></i>Estudio: {address.estudioBy}</span>)}
                        {address.territoryName && (
                            <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-800">
                                <Icon name="map" size={12} className="mr-1.5"/>
                                {address.territoryName}
                            </span>
                        )}
                    </div>
                    {address.notes && (<div className="flex items-start p-3 bg-red-50 rounded-lg text-sm italic"><i className="fas fa-info-circle text-red-400 mr-2 mt-0.5"></i><p className="text-red-800">{address.notes}</p></div>)}<div className="mt-4 pt-3 flex items-center justify-between border-t border-slate-200"><div className="flex items-center"><NavigationButtons a_styles="bg-red-100" div_styles="bg-red-300" button_styles="text-red-800 hover:bg-red-200" /><DistanceTag distance={address.distance} /></div><div className="flex items-center space-x-2">
                    <div className="w-8 h-8 rounded-full bg-red-700 flex items-center justify-center text-white">
                        <i className="fas fa-house-circle-check text-lg"></i>
                    </div>
                    {isEditEnabled && <button onClick={handleEditClick} className="p-2 rounded-full text-red-600 hover:bg-red-100" title={isAdmin ? "Editar dirección" : "Proponer cambio"}><i className="fas fa-pen-to-square text-sm"></i></button>}
                    {onUnmark && <button onClick={handleUnmarkClick} className="p-2 rounded-full text-red-600 hover:bg-red-100" title="Liberar dirección"><i className="fas fa-xmark text-lg"></i></button>}
                </div></div></div></div>
            </div>
        );
    }

    return (
        <div id={`address-card-${address.id}`} className={`relative rounded-xl bg-green-600 p-1 shadow-lg ${highlightClass} ${navigatingClass}`} onClick={handleClick}>
            <div className="bg-white rounded-lg p-4 border-2 border-green-200"><div className="flex flex-col h-full"><div className="flex items-start justify-between mb-2"><p className="text-green-900 font-semibold leading-tight flex-1 pr-2">{address.address}</p><div className="ml-4 flex-shrink-0"><GenderTag gender={address.gender} /></div></div>
                <div className="space-y-2 mb-2">
                    {address.isRevisita && (<span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-purple-100 text-purple-800"><i className="fas fa-bookmark mr-1.5"></i>Revisita: {address.revisitaBy}</span>)}
                    {address.isEstudio && (<span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800"><i className="fas fa-book-open mr-1.5"></i>Estudio: {address.estudioBy}</span>)}
                    {address.territoryName && (
                        <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-800">
                            <Icon name="map" size={12} className="mr-1.5"/>
                            {address.territoryName}
                        </span>
                    )}
                </div>
                {address.notes && (<div className="flex items-start p-3 bg-green-50 rounded-lg text-sm italic"><i className="fas fa-info-circle text-green-400 mr-2 mt-0.5"></i><p className="text-green-800">{address.notes}</p></div>)}<div className="mt-4 pt-3 flex items-center justify-between border-t border-slate-200"><div className="flex items-center"><NavigationButtons a_styles="bg-green-100" div_styles="bg-green-300" button_styles="text-green-800 hover:bg-green-200" /><DistanceTag distance={address.distance} /></div><div className="flex items-center space-x-2">
                {isEditEnabled && <button onClick={handleEditClick} className="p-2 rounded-full text-green-600 hover:bg-green-100" title={isAdmin ? "Editar dirección" : "Proponer cambio"}><i className="fas fa-pen-to-square text-sm"></i></button>}
                {onUnmark && <button onClick={handleUnmarkClick} className="p-2 rounded-full text-green-600 hover:bg-green-100" title="Liberar dirección"><i className="fas fa-xmark text-lg"></i></button>}
</div></div></div></div>
        </div>
    );
});















        // --- Skeleton Loader Mejorado ---
        const SkeletonCard = () => (
            <div className="p-6 border-2 border-gray-200 rounded-xl animate-pulse">
                <div className="flex items-start">
                    <div className="skeleton w-12 h-12 rounded-full mr-4"></div>
                    <div className="flex-1">
                        <div className="skeleton h-6 w-3/4 rounded mb-3"></div>
                        <div className="skeleton h-4 w-1/2 rounded mb-2"></div>
                        <div className="skeleton h-4 w-2/3 rounded"></div>
                    </div>
                </div>
            </div>
        );

// --- Componente de Tarjeta de Territorio Mejorado ---
// Reemplaza tu componente TerritoryCard existente con este código.

const TerritoryCard = memo(({ territory, onSelect }) => {
    const { addresses, currentUser } = useContext(AppContext); // Modificación: Añadir currentUser
    const [isHovered, setIsHovered] = useState(false);
    
    // --- INICIO MODIFICACIÓN 1: Lógica para saber si está asignado al usuario actual ---
    const isAssignedToMe = useMemo(() => {
        if (!currentUser || !territory.assignedTo) return false;
        return territory.status === 'En uso' && territory.assignedTo === currentUser.name;
    }, [currentUser, territory]);
    // --- FIN MODIFICACIÓN 1 ---

    const stats = useMemo(() => {
        const territoryAddresses = addresses.filter(a => a.territoryId === territory.id);
        const visitedCount = territoryAddresses.filter(a => a.isVisited).length;
        
        return {
            total: territoryAddresses.length,
            visited: visitedCount,
            pending: territoryAddresses.length - visitedCount,
            progress: territoryAddresses.length > 0 
                ? Math.round((visitedCount / territoryAddresses.length) * 100) 
                : 0
        };
    }, [addresses, territory.id]);
    
    const statusConfig = useMemo(() => {
        const configs = {
            'En uso': {
                displayText: 'Asignado',
                borderColor: 'border-yellow-400',
                bgColor: 'bg-yellow-50',
                badgeBg: 'bg-yellow-500',
                badgeBorder: 'border-yellow-50',
                icon: 'user',
                iconBg: 'bg-yellow-500',
                textColor: 'text-yellow-800',
                badgeTextColor: 'text-yellow-800',
                badgeBgLight: 'bg-yellow-100',
                progressColor: 'bg-yellow-500'
            },
            'Terminado': {
                displayText: 'Terminado',
                borderColor: 'border-red-400',
                bgColor: 'bg-red-50',
                badgeBg: 'bg-red-500',
                badgeBorder: 'border-red-50',
                icon: 'flag',
                iconBg: 'bg-red-500',
                textColor: 'text-red-700',
                badgeTextColor: 'text-red-800',
                badgeBgLight: 'bg-red-100',
                opacity: 'opacity-90',
                progressColor: 'bg-red-500'
            },
            'Disponible': {
                displayText: 'Disponible',
                borderColor: 'border-green-500',
                bgColor: 'bg-green-50',
                badgeBg: 'bg-green-500',
                badgeBorder: 'border-green-50',
                icon: 'mapPin',
                iconBg: 'bg-green-500',
                textColor: 'text-green-800',
                badgeTextColor: 'text-green-800',
                badgeBgLight: 'bg-green-100',
                progressColor: 'bg-green-500'
            }
        };
        
        return configs[territory.status] || configs['Disponible'];
    }, [territory.status]);
    
    const timeInfo = useMemo(() => {
        if (territory.status === 'Disponible') {
            return 'Territorio disponible';
        }

        if (territory.status === 'En uso' && territory.assignedDate) {
            const now = new Date();
            const assignedDate = territory.assignedDate.toDate();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfAssignedDay = new Date(assignedDate.getFullYear(), assignedDate.getMonth(), assignedDate.getDate());
            const diffTime = startOfToday.getTime() - startOfAssignedDay.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Asignado hoy';
            if (diffDays === 1) return 'Asignado ayer';
            return `Asignado hace ${diffDays} días`;
        }
        
        if (territory.status === 'Terminado' && territory.lastCompletedDate) {
            const relativeTime = formatRelativeTime(territory.lastCompletedDate);
            if (relativeTime) {
                const formattedTime = relativeTime.charAt(0).toLowerCase() + relativeTime.slice(1);
                return `Terminado ${formattedTime}`;
            }
        }
        
        return null;
    }, [territory]);
    
    return (
        <div 
            onClick={() => onSelect(territory)}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            // --- INICIO MODIFICACIÓN 2: Aplicar estilo condicional ---
            className={`relative p-6 border-2 rounded-2xl shadow-sm flex flex-col h-full cursor-pointer transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl ${statusConfig.borderColor} ${statusConfig.bgColor} ${statusConfig.opacity || ''} ${isAssignedToMe ? 'ring-4 ring-offset-2 ring-blue-500' : ''}`}
            // --- FIN MODIFICACIÓN 2 ---
        >
            <div className={`absolute -top-5 right-5 w-12 h-12 rounded-full flex items-center justify-center border-4 shadow-lg transition-transform duration-300 ${statusConfig.iconBg} ${statusConfig.badgeBorder} ${isHovered ? 'scale-110' : ''}`}>
                <Icon name={statusConfig.icon} size={24} className="text-white" />
            </div>
            
            <div className="flex-grow">
                <h3 className="text-2xl font-bold text-gray-800 mb-2">{territory.name}</h3>
                
                {territory.status === 'En uso' && territory.assignedTo && (
                    <div className={`flex items-center text-sm font-semibold ${statusConfig.textColor} mb-2`}>
                        <Icon name="user" size={16} className="mr-2" />
                        <span>{territory.assignedTo}</span>
                    </div>
                )}
                
                {territory.status === 'Terminado' && territory.lastCompletedBy && (
                    <div className={`flex items-center text-sm font-semibold ${statusConfig.textColor} mb-2`}>
                        <Icon name="user" size={16} className="mr-2" />
                        <span>{territory.lastCompletedBy}</span>
                    </div>
                )}
                
                {territory.status === 'En uso' && stats.total > 0 && (
                    <div className="mt-3">
                        <div className="flex justify-between text-xs text-gray-600 mb-1">
                            <span className="font-semibold">Progreso</span>
                            <span className="font-bold">{stats.visited}/{stats.total}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className={`h-2 rounded-full transition-all duration-500 ${statusConfig.progressColor}`}
                                style={{ width: `${stats.progress}%` }}
                            />
                        </div>
                    </div>
                )}
            </div>
            
            <div className={`flex justify-between items-center mt-4 pt-4 border-t ${statusConfig.borderColor}`}>
                <div className="flex items-center space-x-4">
                    {timeInfo && (
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${statusConfig.badgeBgLight} ${statusConfig.badgeTextColor}`}>
                            <Icon name={territory.status === 'Disponible' ? 'checkSquare' : 'clock'} size={12} className="inline mr-1" />
                            {timeInfo}
                        </span>
                    )}
                </div>
                
                <div className="flex items-center space-x-3">
                    <div className={`flex items-center font-semibold ${statusConfig.textColor}`}>
                        <Icon name="mapPin" size={16} className="mr-1" />
                        <span>{stats.total}</span>
                    </div>
                </div>
            </div>
        </div>
    );
});








        // --- Componente de Estadísticas Mejorado (Diseño Minimalista) ---
const StatisticsModal = ({ isOpen, onClose }) => {
    const { territories, addresses, territoryHistory } = useContext(AppContext);
    const [selectedStat, setSelectedStat] = useState('overview');
    
    const stats = useMemo(() => {
        if (!territories || !addresses) return null;
        
        const now = new Date();
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        
        // Estadísticas básicas
        const basic = {
            totalTerritories: territories.length,
            availableTerritories: territories.filter(t => t.status === 'Disponible').length,
            inUseTerritories: territories.filter(t => t.status === 'En uso').length,
            completedTerritories: territories.filter(t => t.status === 'Terminado').length,
            totalAddresses: addresses.length,
            visitedAddresses: addresses.filter(a => a.isVisited).length,
            pendingAddresses: addresses.filter(a => !a.isVisited).length
        };
        
        // Progreso y tasas
        basic.completionRate = basic.totalAddresses > 0 
            ? (basic.visitedAddresses / basic.totalAddresses * 100).toFixed(1) 
            : 0;
        
        basic.territoryUtilization = basic.totalTerritories > 0
            ? ((basic.inUseTerritories / basic.totalTerritories) * 100).toFixed(1)
            : 0;
        
        // Estadísticas de tiempo
        const timeStats = {
            averageCompletionDays: 0,
            fastestCompletion: null,
            slowestCompletion: null,
            completionsLastMonth: 0
        };
        
        if (territoryHistory && territoryHistory.length > 0) {
            const completedWithTime = territoryHistory
                .filter(h => h.completedDate && h.assignedDate)
                .map(h => ({
                    ...h,
                    days: Math.floor((h.completedDate.toDate() - h.assignedDate.toDate()) / (1000 * 60 * 60 * 24))
                }));
            
            if (completedWithTime.length > 0) {
                const totalDays = completedWithTime.reduce((sum, h) => sum + h.days, 0);
                timeStats.averageCompletionDays = Math.round(totalDays / completedWithTime.length);
                
                completedWithTime.sort((a, b) => a.days - b.days);
                timeStats.fastestCompletion = completedWithTime[0];
                timeStats.slowestCompletion = completedWithTime[completedWithTime.length - 1];
            }
            
            timeStats.completionsLastMonth = territoryHistory.filter(h => 
                h.completedDate && h.completedDate.toDate() > lastMonth
            ).length;
        }
        
        // Publicadores activos
        const activePublishers = [...new Set(territories
            .filter(t => t.status === 'En uso')
            .map(t => t.assignedTo)
            .filter(Boolean))];
        
        // Territorios por publicador
        const publisherStats = {};
        territories.forEach(t => {
            if (t.status === 'En uso' && t.assignedTo) {
                publisherStats[t.assignedTo] = (publisherStats[t.assignedTo] || 0) + 1;
            }
        });
        
        return {
            ...basic,
            ...timeStats,
            activePublishers: activePublishers.length,
            publisherStats: Object.entries(publisherStats).sort((a, b) => b[1] - a[1])
        };
    }, [territories, addresses, territoryHistory]);
    
    if (!isOpen || !stats) return null;
    
    const StatCard = ({ title, value, subtitle, icon, trend }) => (
        <div className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-sm transition-shadow">
            <div className="flex items-start justify-between">
                <div className="flex-1">
                    <p className="text-sm font-medium text-gray-600 mb-1">{title}</p>
                    <p className="text-2xl font-bold text-gray-900">{value}</p>
                    {subtitle && <p className="text-xs text-gray-500 mt-1">{subtitle}</p>}
                    {trend !== undefined && (
                        <div className={`flex items-center mt-2 text-xs ${trend > 0 ? 'text-green-600' : 'text-red-600'}`}>
                            <Icon name={trend > 0 ? 'trendingUp' : 'trendingDown'} size={14} className="mr-1" />
                            <span>{Math.abs(trend)}% vs mes anterior</span>
                        </div>
                    )}
                </div>
                <div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center ml-4">
                    <Icon name={icon} size={20} className="text-gray-600" />
                </div>
            </div>
        </div>
    );
    
    return (
        <Modal isOpen={isOpen} onClose={onClose} title="" size="2xl">
            <div className="flex flex-col h-full">
                {/* Header personalizado */}
                <div className="bg-gray-50 border-b border-gray-200 p-6 pb-0">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-semibold text-gray-800">Estadísticas Generales</h2>
                        <button 
                            onClick={onClose}
                            className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
                        >
                            <Icon name="x" size={20} className="text-gray-600" />
                        </button>
                    </div>
                    
                    {/* Tabs minimalistas */}
                    <div className="flex space-x-1">
                        {[
                            { id: 'overview', label: 'Vista General', icon: 'activity' },
                            { id: 'progress', label: 'Progreso', icon: 'barChart' },
                            { id: 'performance', label: 'Rendimiento', icon: 'clock' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setSelectedStat(tab.id)}
                                className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 font-medium text-sm transition-all border-b-2 ${
                                    selectedStat === tab.id 
                                        ? 'text-gray-900 border-gray-800 bg-white' 
                                        : 'text-gray-500 border-transparent hover:text-gray-700'
                                }`}
                            >
                                <Icon name={tab.icon} size={16} />
                                {tab.label}
                            </button>
                        ))}
                    </div>
                </div>
                
                {/* Contenido scrolleable */}
                <div className="flex-1 overflow-y-auto p-6">
                    {selectedStat === 'overview' && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <StatCard
                                    title="Total de Territorios"
                                    value={stats.totalTerritories}
                                    icon="mapPin"
                                />
                                <StatCard
                                    title="Total de Direcciones"
                                    value={stats.totalAddresses}
                                    icon="home"
                                />
                                <StatCard
                                    title="Publicadores Activos"
                                    value={stats.activePublishers}
                                    subtitle={`${stats.inUseTerritories} territorios asignados`}
                                    icon="users"
                                />
                                <StatCard
                                    title="Tasa de Utilización"
                                    value={`${stats.territoryUtilization}%`}
                                    subtitle="Territorios en uso"
                                    icon="activity"
                                />
                            </div>
                            
                            {/* Distribución de territorios */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                <h4 className="text-base font-semibold text-gray-900 mb-4">Distribución de Territorios</h4>
                                <div className="space-y-3">
                                    <div className="flex items-center">
                                        <div className="w-32 text-sm text-gray-600">Disponibles</div>
                                        <div className="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                                            <div 
                                                className="absolute left-0 top-0 h-full bg-green-500 flex items-center justify-end pr-2"
                                                style={{ width: `${(stats.availableTerritories / stats.totalTerritories * 100)}%` }}
                                            >
                                                <span className="text-xs font-medium text-white">{stats.availableTerritories}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-32 text-sm text-gray-600">En uso</div>
                                        <div className="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                                            <div 
                                                className="absolute left-0 top-0 h-full bg-yellow-500 flex items-center justify-end pr-2"
                                                style={{ width: `${(stats.inUseTerritories / stats.totalTerritories * 100)}%` }}
                                            >
                                                <span className="text-xs font-medium text-white">{stats.inUseTerritories}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-32 text-sm text-gray-600">Terminados</div>
                                        <div className="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                                            <div 
                                                className="absolute left-0 top-0 h-full bg-gray-600 flex items-center justify-end pr-2"
                                                style={{ width: `${(stats.completedTerritories / stats.totalTerritories * 100)}%` }}
                                            >
                                                <span className="text-xs font-medium text-white">{stats.completedTerritories}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {selectedStat === 'progress' && (
                        <div className="space-y-6">
                            {/* Progreso general */}
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                <h4 className="text-base font-semibold text-gray-900 mb-4">Progreso General del Trabajo</h4>
                                <div className="relative w-full bg-gray-200 rounded-full h-8 overflow-hidden mb-4">
                                    <div
                                        className="absolute left-0 top-0 h-full bg-gray-800 transition-all duration-1000 flex items-center justify-end pr-3"
                                        style={{ width: `${stats.completionRate}%` }}
                                    >
                                        <span className="text-white text-sm font-bold">{stats.completionRate}%</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p className="text-2xl font-bold text-green-600">{stats.visitedAddresses}</p>
                                        <p className="text-xs text-gray-600">Visitadas</p>
                                    </div>
                                    <div>
                                        <p className="text-2xl font-bold text-orange-600">{stats.pendingAddresses}</p>
                                        <p className="text-xs text-gray-600">Pendientes</p>
                                    </div>
                                    <div>
                                        <p className="text-2xl font-bold text-gray-700">{stats.totalAddresses}</p>
                                        <p className="text-xs text-gray-600">Total</p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Publicadores con más territorios */}
                            {stats.publisherStats.length > 0 && (
                                <div className="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 className="text-base font-semibold text-gray-900 mb-4">Territorios por Publicador</h4>
                                    <div className="space-y-2">
                                        {stats.publisherStats.slice(0, 5).map(([name, count]) => (
                                            <div key={name} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex items-center">
                                                    <Icon name="user" size={16} className="mr-2 text-gray-500" />
                                                    <span className="font-medium text-gray-800">{name}</span>
                                                </div>
                                                <span className="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm font-semibold">
                                                    {count} {count === 1 ? 'territorio' : 'territorios'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {selectedStat === 'performance' && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <StatCard
                                    title="Tiempo Promedio"
                                    value={stats.averageCompletionDays ? `${stats.averageCompletionDays} días` : 'N/A'}
                                    subtitle="Para completar un territorio"
                                    icon="clock"
                                />
                                <StatCard
                                    title="Completados Último Mes"
                                    value={stats.completionsLastMonth}
                                    subtitle="Territorios terminados"
                                    icon="checkCircle"
                                />
                            </div>
                            
                            {/* Récords */}
                            {(stats.fastestCompletion || stats.slowestCompletion) && (
                                <div className="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 className="text-base font-semibold text-gray-900 mb-4">Récords de Completación</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {stats.fastestCompletion && (
                                            <div className="bg-green-50 border border-green-200 p-4 rounded-lg">
                                                <div className="flex items-center mb-2">
                                                    <Icon name="zap" size={20} className="text-green-600 mr-2" />
                                                    <h5 className="font-semibold text-green-900">Más Rápido</h5>
                                                </div>
                                                <p className="text-2xl font-bold text-green-700">{stats.fastestCompletion.days} días</p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    {stats.fastestCompletion.territoryName} - {stats.fastestCompletion.assignedTo}
                                                </p>
                                            </div>
                                        )}
                                        {stats.slowestCompletion && (
                                            <div className="bg-orange-50 border border-orange-200 p-4 rounded-lg">
                                                <div className="flex items-center mb-2">
                                                    <Icon name="clock" size={20} className="text-orange-600 mr-2" />
                                                    <h5 className="font-semibold text-orange-900">Más Tiempo</h5>
                                                </div>
                                                <p className="text-2xl font-bold text-orange-700">{stats.slowestCompletion.days} días</p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    {stats.slowestCompletion.territoryName} - {stats.slowestCompletion.assignedTo}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </Modal>
    );
};

        // --- Indicador de estado de conexión mejorado ---
                // --- Indicador de estado de conexión mejorado (Más Pequeño) ---
        const ConnectionStatusBadge = () => {
            const { isOnline, isSyncing, pendingWritesCount } = useContext(AppContext);
            const { connectionQuality } = useOnlineStatus();
            
            const getStatusConfig = () => {
                if (!isOnline) {
                    return {
                        text: pendingWritesCount > 0 
                            ? `${pendingWritesCount} cambio${pendingWritesCount > 1 ? 's' : ''} pendiente${pendingWritesCount > 1 ? 's' : ''}`
                            : 'Sin conexión',
                        icon: 'cloudOff',
                        color: 'text-gray-600',
                        bgColor: 'bg-gray-200',
                        pulseColor: ''
                    };
                }
                
                if (isSyncing || (pendingWritesCount > 0 && isOnline)) {
                    return {
                        text: `Sincronizando${pendingWritesCount > 0 ? ` ${pendingWritesCount}...` : '...'}`,
                        icon: 'uploadCloud',
                        color: 'text-blue-600',
                        bgColor: 'bg-blue-100',
                        pulseColor: 'animate-pulse'
                    };
                }
                
                const qualityConfig = {
                    excellent: { text: 'Excelente', color: 'text-green-600', bgColor: 'bg-green-100' },
                    good: { text: 'En línea', color: 'text-green-600', bgColor: 'bg-green-100' },
                    fair: { text: 'Lenta', color: 'text-yellow-600', bgColor: 'bg-yellow-100' },
                    poor: { text: 'Inestable', color: 'text-orange-600', bgColor: 'bg-orange-100' }
                };
                
                return {
                    ...qualityConfig[connectionQuality] || qualityConfig.good,
                    icon: 'wifi',
                    pulseColor: ''
                };
            };
            
            const status = getStatusConfig();
            
            return (
                <div className={`inline-flex px-2 py-1 text-xs font-medium rounded-full items-center space-x-1.5 transition-all duration-300 ${status.color} ${status.bgColor}`}>
                    <Icon name={status.icon} size={12} className={status.pulseColor} />
                    <span>{status.text}</span>
                </div>
            );
        };

// --- Vista de Grid de Territorios Mejorada (con Instalación en Menú y Modal de Instrucciones) ---

// ++ INICIO: Componente Modal para Instrucciones de Instalación ++
//    Este modal se mostrará si el navegador no ofrece una instalación directa (ej. en iOS).
const InstallInstructionsModal = ({ isOpen, onClose }) => {
    // Detectamos si el dispositivo es iOS para mostrar las instrucciones correctas.
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    return (
        // Usamos el componente Modal que ya existe en la aplicación.
        <Modal isOpen={isOpen} onClose={onClose} title="Cómo Instalar la Aplicación" size="md">
            <div className="p-6">
                <div className="text-center mb-6">
                    <div className="w-16 h-16 mx-auto bg-indigo-100 rounded-full flex items-center justify-center">
                        <Icon name="download" size={32} className="text-indigo-600" />
                    </div>
                    <h3 className="text-xl font-bold text-gray-900 mt-4">Acceso Rápido y Offline</h3>
                    <p className="mt-2 text-gray-600">
                        Instala la aplicación en tu dispositivo para un acceso más fácil y rápido, ¡incluso sin conexión!
                    </p>
                </div>

                {isIOS ? (
                    // Instrucciones específicas para Safari en iOS
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="font-bold text-lg text-gray-800 mb-3">En iPhone o iPad:</h4>
                        <ol className="space-y-3 text-gray-700">
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">1.</span><span>Toca el botón de **Compartir** (un cuadrado con una flecha) en la barra de tu navegador Safari.</span></li>
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">2.</span><span>En el menú, desliza hacia arriba y busca la opción **"Agregar a inicio"**.</span></li>
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">3.</span><span>Confirma el nombre y toca **"Agregar"** en la esquina superior derecha.</span></li>
                        </ol>
                    </div>
                ) : (
                    // Instrucciones generales para Android/Chrome
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="font-bold text-lg text-gray-800 mb-3">En Android:</h4>
                         <ol className="space-y-3 text-gray-700">
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">1.</span><span>Toca el menú de los **tres puntos** en la esquina superior derecha de Chrome.</span></li>
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">2.</span><span>Busca y selecciona la opción **"Instalar aplicación"**.</span></li>
                            <li className="flex items-start"><span className="font-bold text-indigo-600 mr-2">3.</span><span>Sigue las instrucciones para confirmar y agregarla a tu pantalla de inicio.</span></li>
                        </ol>
                    </div>
                )}

                 <div className="mt-6">
                    <button
                        onClick={onClose}
                        className="w-full bg-indigo-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors"
                    >
                        Entendido
                    </button>
                </div>
            </div>
        </Modal>
    );
};

// ++ INICIO: Componente Modal para Asignar Territorio ++
const AssignTerritoryModal = ({ isOpen, onClose, onAssign, territoryName, isProcessing }) => {
    // Se usa el contexto para obtener la lista de todos los publicadores
    const { allUsers } = useContext(AppContext); 
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedPublisher, setSelectedPublisher] = useState(null);

    // Limpiar estados cuando el modal se cierra o abre
    useEffect(() => {
        if (isOpen) {
            setSearchTerm('');
            setSelectedPublisher(null);
        }
    }, [isOpen]);

    // Lógica para filtrar y agrupar los publicadores
    const groupedPublishers = useMemo(() => {
        const filtered = allUsers.filter(user => 
            user.name.toLowerCase().includes(searchTerm.toLowerCase())
        );

        return filtered.reduce((acc, p) => {
            const char = p.name[0].toUpperCase();
            if (!acc[char]) acc[char] = [];
            acc[char].push(p);
            return acc;
        }, {});
    }, [allUsers, searchTerm]);
    
    const handleAssignClick = () => {
        if (selectedPublisher) {
            onAssign(selectedPublisher.name);
        }
    };
    
    const handleSelectPublisher = (publisher) => {
        // Permite seleccionar y deseleccionar
        if (selectedPublisher && selectedPublisher.id === publisher.id) {
            setSelectedPublisher(null);
        } else {
            setSelectedPublisher(publisher);
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Asignar Territorio: ${territoryName}`} size="sm">
            <div className="flex flex-col h-[60vh] sm:h-[70vh]">
                 {/* Barra de Búsqueda */}
                <div className="p-4 border-b border-gray-200">
                     <div className="relative">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </span>
                        <input
                            type="text"
                            placeholder="Buscar publicador..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>
                </div>

                {/* Lista de Publicadores */}
                <div className="flex-1 overflow-y-auto">
                    {Object.keys(groupedPublishers).length > 0 ? (
                        <ul>
                            {Object.keys(groupedPublishers).sort().map(char => (
                                <li key={char}>
                                    <div className="py-1 px-4 bg-gray-100 text-sm font-bold text-indigo-600 sticky top-0">
                                        {char}
                                    </div>
                                    <ul>
                                        {groupedPublishers[char].map(p => (
                                            <li
                                                key={p.id}
                                                onClick={() => handleSelectPublisher(p)}
                                                className={`flex items-center p-4 cursor-pointer transition-colors ${selectedPublisher && selectedPublisher.id === p.id ? 'bg-indigo-100' : 'hover:bg-gray-50'}`}
                                            >
                                                <div className="flex-1">
                                                    <p className={`font-medium ${selectedPublisher && selectedPublisher.id === p.id ? 'text-indigo-700' : 'text-gray-800'}`}>{p.name}</p>
                                                    {p.role === 'admin' && <p className="text-xs text-gray-500">Administrador</p>}
                                                </div>
                                                {selectedPublisher && selectedPublisher.id === p.id && (
                                                    <div className="w-5 h-5 text-indigo-600">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                                    </div>
                                                )}
                                            </li>
                                        ))}
                                    </ul>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-center text-gray-500 py-10">No se encontraron publicadores.</p>
                    )}
                </div>

                {/* Botones de Acción */}
                <div className="p-4 border-t border-gray-200">
                    <button 
                        type="button" 
                        onClick={handleAssignClick} 
                        disabled={!selectedPublisher || isProcessing} 
                        className="w-full px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed transition-colors"
                    >
                        {isProcessing ? 'Asignando...' : `Asignar a ${selectedPublisher ? selectedPublisher.name.split(' ')[0] : ''}`}
                    </button>
                </div>
            </div>
        </Modal>
    );
};
// ++ FIN: Componente Modal para Asignar Territorio ++

const TerritoryGridView = ({ onSelectTerritory, onOpenModal }) => {
    const { territories, isLoading, handleLogout, currentUser, pendingProposalsCount, userNotificationsCount, updateAvailable, checkForUpdates } = useContext(AppContext);
    const { showToast } = useToast();
    
    const [filterStatus, setFilterStatus] = useState('all');
    const [sortBy, setSortBy] = useState('name');
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const [activeItem, setActiveItem] = useState('explore');

    useEffect(() => {
        if (isMenuOpen) {
            const scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
        } else {
            const scrollY = document.body.style.top;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
        }
        return () => {
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
        };
    }, [isMenuOpen]);

    const [installPrompt, setInstallPrompt] = useState(null);
    const [isInstallModalOpen, setIsInstallModalOpen] = useState(false);
    const [isAppInstalled, setIsAppInstalled] = useState(
        () => window.matchMedia('(display-mode: standalone)').matches
    );

    useEffect(() => {
        const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
        const hasModal = urlParams.get('modal');
        if (hasModal && !isMenuOpen) {
            setIsMenuOpen(true);
        }
    }, [window.location.hash]);

    useEffect(() => {
        const mediaQuery = window.matchMedia('(display-mode: standalone)');
        const handleChange = () => setIsAppInstalled(mediaQuery.matches);
        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
    }, []);

    useEffect(() => {
        const handler = (e) => {
            e.preventDefault();
            if (!isAppInstalled) {
                setInstallPrompt(e);
            }
        };
        window.addEventListener('beforeinstallprompt', handler);
        return () => window.removeEventListener('beforeinstallprompt', handler);
    }, [isAppInstalled]);

    const handleInstallClick = async () => {
        if (installPrompt) {
            const result = await installPrompt.prompt();
            if (result.outcome === 'accepted') {
                showToast('¡App instalada correctamente!', 'success');
            } else {
                showToast('Instalación cancelada', 'info');
            }
            setInstallPrompt(null);
        } else {
            setIsInstallModalOpen(true);
        }
    };

    useEffect(() => {
        const handleBackButton = (event) => {
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
            const hasModal = urlParams.get('modal');
            if (hasModal) {
                return; 
            }
            if (isMenuOpen) {
                event.preventDefault();
                setIsMenuOpen(false);
            }
        };
        if (isMenuOpen) {
            const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
            const hasModal = urlParams.get('modal');
            if (!hasModal) {
                window.history.pushState({ menuOpen: true }, '');
            }
            window.addEventListener('popstate', handleBackButton);
        }
        return () => window.removeEventListener('popstate', handleBackButton);
    }, [isMenuOpen]);

    const menuItems = useMemo(() => {
        const baseItems = [
            { id: 'search', text: 'Buscar', icon: 'search', modal: 'search' },
            { id: 'myActivity', text: 'Mis Revisitas y Estudios', icon: 'bookmark', modal: 'myActivity' },
            { id: 'myProposals', text: 'Mis Propuestas', icon: 'checkSquare', modal: 'myProposals', showForNonAdmin: true, hasBadge: userNotificationsCount > 0, badgeCount: userNotificationsCount },
            { id: 'admin', text: 'Administrador', icon: 'shield', modal: 'admin', hasBadge: currentUser?.role === 'admin' && pendingProposalsCount > 0, badgeCount: pendingProposalsCount },
            { id: 'password', text: 'Cambiar Contraseña', icon: 'lock', modal: 'changePassword' },
            { id: 'updates', text: 'Actualizaciones', icon: 'rotateCcw', action: () => checkForUpdates(false), hasBadge: updateAvailable, badgeText: '¡Nueva!', highlight: updateAvailable },
        ];
        if (!isAppInstalled) {
            baseItems.push({ id: 'install', text: 'Instalar Aplicación', icon: 'download', action: handleInstallClick });
        }
        baseItems.push({ id: 'logout', text: 'Cerrar Sesión', icon: 'logOut', isLogout: true });
        return baseItems;
     }, [isAppInstalled, installPrompt, currentUser, pendingProposalsCount, userNotificationsCount, updateAvailable]);
    
    const filteredAndSortedTerritories = useMemo(() => {
        const filtered = territories.filter(t => {
            return filterStatus === 'all' || normalizeText(t.status).toLowerCase() === filterStatus;
        });
        
        filtered.sort((a, b) => {
            if (filterStatus === 'en uso') {
                const isAMine = a.assignedTo === currentUser.name;
                const isBMine = b.assignedTo === currentUser.name;
                if (isAMine && !isBMine) return -1;
                if (!isAMine && isBMine) return 1;
            }
            if (sortBy === 'name') return a.name.localeCompare(b.name, undefined, { numeric: true });
            if (sortBy === 'status') {
                const statusOrder = { 'En uso': 1, 'Disponible': 2, 'Terminado': 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            }
            return 0;
        });
        
        return filtered;
    }, [territories, filterStatus, sortBy, currentUser.name]);
    
    const stats = useMemo(() => ({
        total: territories.length,
        available: territories.filter(t => t.status === 'Disponible').length,
        inUse: territories.filter(t => t.status === 'En uso').length,
        completed: territories.filter(t => t.status === 'Terminado').length,
    }), [territories]);

    const userHasAssignedTerritories = useMemo(() => {
        return territories.some(t => t.status === 'En uso' && t.assignedTo === currentUser.name);
    }, [territories, currentUser.name]);

    const MobileMenu = () => {
        const { CURRENT_VERSION } = useContext(AppContext);
        const [hoveredItem, setHoveredItem] = useState(null);
        
        // Colores vibrantes para cada item del menú
        const menuColors = {
            search: { bg: 'from-blue-500 to-indigo-600', icon: 'text-white', hover: 'from-blue-600 to-indigo-700' },
            stats: { bg: 'from-emerald-500 to-teal-600', icon: 'text-white', hover: 'from-emerald-600 to-teal-700' },
            reports: { bg: 'from-purple-500 to-pink-600', icon: 'text-white', hover: 'from-purple-600 to-pink-700' },
            myProposals: { bg: 'from-amber-500 to-orange-600', icon: 'text-white', hover: 'from-amber-600 to-orange-700' },
            admin: { bg: 'from-rose-500 to-pink-600', icon: 'text-white', hover: 'from-rose-600 to-pink-700' },
            password: { bg: 'from-gray-600 to-gray-800', icon: 'text-white', hover: 'from-gray-700 to-gray-900' },
            install: { bg: 'from-violet-500 to-purple-600', icon: 'text-white', hover: 'from-violet-600 to-purple-700' },
            updates: { bg: 'from-cyan-500 to-blue-600', icon: 'text-white', hover: 'from-cyan-600 to-blue-700' },
            logout: { bg: 'from-red-500 to-rose-600', icon: 'text-white', hover: 'from-red-600 to-rose-700' }
        };
        
        return (
            <>
                <div 
                    className={`fixed inset-0 bg-gradient-to-br from-black/70 via-black/60 to-purple-900/40 backdrop-blur-md z-40 transition-all duration-500 ${isMenuOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} 
                    onClick={() => {
                        const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
                        const hasModal = urlParams.get('modal');
                        if (!hasModal) {
                            setIsMenuOpen(false);
                        }
                    }}
                    style={{ touchAction: 'none' }}
                />
                <div 
                    data-menu-panel="true"
                    className={`fixed inset-y-0 right-0 w-full max-w-sm bg-gradient-to-br from-gray-50 via-white to-purple-50 shadow-2xl z-50 transition-all duration-500 ease-out transform ${isMenuOpen ? 'translate-x-0 scale-100' : 'translate-x-full scale-95'}`}
                    style={{
                        boxShadow: isMenuOpen ? '0 0 50px rgba(139, 92, 246, 0.3)' : 'none'
                    }}
                >
                    <div className="h-full flex flex-col relative overflow-hidden" style={{ touchAction: 'pan-y' }}>
                        {/* Efectos de fondo decorativos */}
                        <div className="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-3xl transform translate-x-32 -translate-y-32"></div>
                        <div className="absolute bottom-0 left-0 w-96 h-96 bg-gradient-to-tr from-blue-400/20 to-cyan-400/20 rounded-full blur-3xl transform -translate-x-48 translate-y-48"></div>
                        
                        {/* Header con gradiente */}
                        <div className="relative bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 p-6 flex-shrink-0">
                            <div className="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
                            <button 
                                onClick={() => setIsMenuOpen(false)} 
                                className="absolute top-4 right-4 p-2.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full transition-all duration-300 hover:scale-110 hover:rotate-90"
                            >
                                <Icon name="x" size={20} className="text-white" />
                            </button>
                            <div className="relative flex items-center space-x-4">
                                <div className="w-20 h-20 bg-gradient-to-br from-white/30 to-white/10 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform">
                                    <Icon name="user" size={36} className="text-white" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-white mb-1">{currentUser ? currentUser.name : 'Usuario'}</h3>
                                    <span className="inline-flex items-center text-sm text-white/90 bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                                        <Icon name={currentUser?.role === 'admin' ? 'shield' : 'users'} size={14} className="mr-1.5" />
                                        {currentUser?.role === 'admin' ? 'Administrador' : 'Publicador'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Contenido del menú */}
                        <div className="flex-1 overflow-y-auto relative z-10" style={{ overscrollBehavior: 'contain', WebkitOverflowScrolling: 'touch' }}>
                            <div className="px-4 pt-6 pb-6">
                                <nav>
                                    <ul className="space-y-3">
                                        {menuItems.filter(item => !(item.id === 'myProposals' && currentUser?.role === 'admin')).map((item, index) => {
                                            const isActive = activeItem === item.id;
                                            const isHovered = hoveredItem === item.id;
                                            const colors = menuColors[item.id] || menuColors.search;
                                            
                                            return (
                                                <li 
                                                    key={item.id}
                                                    style={{
                                                        animation: isMenuOpen ? `slideInRight ${0.3 + index * 0.05}s ease-out` : 'none'
                                                    }}
                                                >
                                                    <a 
                                                        href="#" 
                                                        onClick={(e) => { 
                                                            e.preventDefault(); 
                                                            setActiveItem(item.id); 
                                                            if (item.modal) { 
                                                                onOpenModal(item.modal, true); 
                                                            } else if (item.action) { 
                                                                item.action(); 
                                                                setIsMenuOpen(false); 
                                                            } else if (item.isLogout) { 
                                                                handleLogout(); 
                                                                setIsMenuOpen(false); 
                                                            } 
                                                        }} 
                                                        onMouseEnter={() => setHoveredItem(item.id)}
                                                        onMouseLeave={() => setHoveredItem(null)}
                                                        className={`group flex items-center p-4 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] ${
                                                            isActive 
                                                                ? 'shadow-xl' 
                                                                : 'shadow-lg hover:shadow-xl'
                                                        }`}
                                                        style={{
                                                            background: isActive || isHovered 
                                                                ? `linear-gradient(135deg, ${colors.hover || colors.bg})` 
                                                                : 'white',
                                                            border: isActive || isHovered ? 'none' : '2px solid #e5e7eb'
                                                        }}
                                                    >
                                                        <div className={`relative w-14 h-14 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 transition-all duration-300 ${
                                                            isActive || isHovered
                                                                ? 'bg-white/20 backdrop-blur-sm transform rotate-3 scale-110' 
                                                                : `bg-gradient-to-br ${colors.bg}`
                                                        }`}>
                                                            <Icon 
                                                                name={item.icon} 
                                                                size={24} 
                                                                className={`transition-all duration-300 ${
                                                                    isActive || isHovered 
                                                                        ? 'text-white transform scale-110' 
                                                                        : colors.icon
                                                                }`}
                                                            />
                                                            {item.hasBadge && (item.badgeCount > 0 || item.badgeText) && (
                                                                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold min-w-[24px] h-6 px-1.5 shadow-lg animate-bounce">
                                                                    {item.badgeCount || item.badgeText}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <p className={`font-semibold text-base transition-colors duration-300 ${
                                                                isActive || isHovered ? 'text-white' : 'text-gray-800'
                                                            }`}>
                                                                {item.text}
                                                            </p>
                                                            {item.id === 'search' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Buscar en todos los territorios</p>
                                                            )}
                                                            {item.id === 'stats' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Ver progreso y métricas</p>
                                                            )}
                                                            {item.id === 'reports' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Generar informes detallados</p>
                                                            )}
                                                            {item.id === 'myProposals' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Ver tus cambios propuestos</p>
                                                            )}
                                                            {item.id === 'admin' && currentUser?.role === 'admin' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Panel de control completo</p>
                                                            )}
                                                            {item.id === 'password' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Actualizar credenciales</p>
                                                            )}
                                                            {item.id === 'install' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>Acceso directo en tu dispositivo</p>
                                                            )}
                                                            {item.id === 'updates' && (
                                                                <p className={`text-xs mt-1 transition-colors duration-300 ${
                                                                    isActive || isHovered ? 'text-white/80' : 'text-gray-500'
                                                                }`}>{updateAvailable ? '¡Nueva versión disponible!' : 'Verificar nuevas versiones'}</p>
                                                            )}
                                                        </div>
                                                        <Icon 
                                                            name="chevronRight" 
                                                            size={20} 
                                                            className={`flex-shrink-0 transition-all duration-300 ${
                                                                isActive || isHovered 
                                                                    ? 'text-white transform translate-x-1 scale-125' 
                                                                    : 'text-gray-400'
                                                            }`} 
                                                        />
                                                    </a>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                </nav>
                                
                                {/* Separador con gradiente */}
                                <div className="my-8 h-px bg-gradient-to-r from-transparent via-purple-300 to-transparent"></div>
                                
                                {/* Footer del menú */}
                                <div className="text-center">
                                    <div className="bg-gradient-to-br from-purple-100 to-pink-100 border border-purple-200 rounded-2xl p-5 shadow-lg transform hover:scale-105 transition-transform">
                                        <Icon name="mapPin" size={32} className="text-purple-600 mx-auto mb-2" />
                                        <p className="text-sm font-medium text-gray-700">Gestor de Territorios</p>
                                        <p className="text-xs font-bold text-purple-600 mt-1">Versión {CURRENT_VERSION}</p>
                                    </div>
                                </div>
                                <div className="h-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Estilos de animación */}
                <style dangerouslySetInnerHTML={{__html: `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    @keyframes pulse-glow {
                        0%, 100% {
                            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
                        }
                        50% {
                            box-shadow: 0 0 40px rgba(139, 92, 246, 0.8);
                        }
                    }
                `}} />
            </>
        );
    };

    return (
        <div className="min-h-screen bg-gray-50 pb-24 sm:pb-8">
            <InstallInstructionsModal isOpen={isInstallModalOpen} onClose={() => setIsInstallModalOpen(false)} />
            {isMenuOpen && <MobileMenu />}
            <header className="bg-gradient-to-br from-white via-purple-50 to-indigo-50 text-gray-800 shadow-xl sticky top-0 z-30 border-b border-purple-100">
                <div className="px-4 pt-4 pb-3 flex justify-between items-center">
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Territorios</h1>
                    <button 
                        onClick={() => setIsMenuOpen(true)} 
                        className="relative group p-3 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300" 
                        aria-label="Abrir menú"
                    >
                        <div className="relative">
                            <div className="absolute inset-0 bg-white/20 rounded-xl blur group-hover:blur-md transition-all duration-300"></div>
                            <svg className="w-6 h-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </div>
                        {((currentUser?.role === 'admin' && pendingProposalsCount > 0) || (currentUser?.role !== 'admin' && userNotificationsCount > 0) || updateAvailable) && (
                            <span className="absolute -top-2 -right-2 min-w-[24px] h-6 px-1.5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold shadow-lg animate-bounce">
                                {updateAvailable && !((currentUser?.role === 'admin' && pendingProposalsCount > 0) || (currentUser?.role !== 'admin' && userNotificationsCount > 0)) ? '!' : currentUser?.role === 'admin' ? pendingProposalsCount : userNotificationsCount}
                            </span>
                        )}
                        <div className="absolute inset-0 bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl opacity-0 group-hover:opacity-100 blur-xl transition-all duration-300 -z-10 scale-110"></div>
                    </button>
                </div>
                
                {/* --- INICIO DE LA CORRECCIÓN --- */}
                <div className="px-4 pb-4">
                    <div className="flex items-stretch gap-3">
                        <button
                             onClick={() => setFilterStatus('all')}
                             title={`Todos (${stats.total})`}
                             className={`flex-shrink-0 w-14 h-20 flex flex-col items-center justify-center rounded-2xl transition-all duration-300 transform hover:scale-105 ${
                                 filterStatus === 'all' 
                                     ? 'bg-gradient-to-br from-gray-700 to-gray-900 text-white shadow-lg scale-105' 
                                     : 'bg-white text-gray-600 shadow-md hover:shadow-lg'
                             }`}
                        >
                            <svg className="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>
                            <span className="text-xs font-bold">{stats.total}</span>
                        </button>
                        <div className="flex-1 grid grid-cols-3 gap-3">
                             <button
                                onClick={() => setFilterStatus('disponible')}
                                className={`relative p-3 text-center rounded-2xl transition-all duration-300 transform hover:scale-105 overflow-hidden ${
                                    filterStatus === 'disponible' 
                                        ? 'bg-gradient-to-br from-emerald-500 to-green-600 text-white shadow-lg scale-105' 
                                        : 'bg-white hover:bg-green-50 shadow-md hover:shadow-lg'
                                }`}
                             >
                                 {filterStatus === 'disponible' && (
                                     <div className="absolute inset-0 bg-white/20 blur-xl"></div>
                                 )}
                                 <div className="relative">
                                     <svg className={`w-6 h-6 mx-auto ${filterStatus === 'disponible' ? 'text-white' : 'text-emerald-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                     </svg>
                                     <p className={`font-bold text-lg mt-1 ${filterStatus === 'disponible' ? 'text-white' : 'text-gray-900'}`}>{stats.available}</p>
                                 </div>
                             </button>
                             <button
                                onClick={() => setFilterStatus('en uso')}
                                className={`relative p-3 text-center rounded-2xl transition-all duration-300 transform hover:scale-105 overflow-hidden ${
                                    filterStatus === 'en uso' 
                                        ? 'bg-gradient-to-br from-amber-500 to-orange-600 text-white shadow-lg scale-105' 
                                        : 'bg-white hover:bg-amber-50 shadow-md hover:shadow-lg'
                                }`}
                             >
                                 {userHasAssignedTerritories && (
                                     <span className="absolute top-2 right-2 w-3 h-3 bg-blue-500 rounded-full ring-2 ring-white shadow-lg animate-pulse"></span>
                                 )}
                                 {filterStatus === 'en uso' && (
                                     <div className="absolute inset-0 bg-white/20 blur-xl"></div>
                                 )}
                                 <div className="relative">
                                     <svg className={`w-6 h-6 mx-auto ${filterStatus === 'en uso' ? 'text-white' : 'text-amber-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                     </svg>
                                     <p className={`font-bold text-lg mt-1 ${filterStatus === 'en uso' ? 'text-white' : 'text-gray-900'}`}>{stats.inUse}</p>
                                 </div>
                             </button>
                             <button
                                onClick={() => setFilterStatus('terminado')}
                                className={`relative p-3 text-center rounded-2xl transition-all duration-300 transform hover:scale-105 overflow-hidden ${
                                    filterStatus === 'terminado' 
                                        ? 'bg-gradient-to-br from-rose-500 to-red-600 text-white shadow-lg scale-105' 
                                        : 'bg-white hover:bg-red-50 shadow-md hover:shadow-lg'
                                }`}
                             >
                                 {filterStatus === 'terminado' && (
                                     <div className="absolute inset-0 bg-white/20 blur-xl"></div>
                                 )}
                                 <div className="relative">
                                     <svg className={`w-6 h-6 mx-auto ${filterStatus === 'terminado' ? 'text-white' : 'text-rose-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                     </svg>
                                     <p className={`font-bold text-lg mt-1 ${filterStatus === 'terminado' ? 'text-white' : 'text-gray-900'}`}>{stats.completed}</p>
                                 </div>
                             </button>
                        </div>
                    </div>
                </div>
                {/* --- FIN DE LA CORRECCIÓN --- */}
            </header>
            <main className="px-4 sm:px-6 lg:px-8 mt-6">
                {isLoading ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        {[...Array(10)].map((_, i) => <SkeletonCard key={i} />)}
                    </div>
                ) : filteredAndSortedTerritories.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        {filteredAndSortedTerritories.map(t => <TerritoryCard key={t.id} territory={t} onSelect={onSelectTerritory} />)}
                    </div>
                ) : (
                    <div className="text-center py-16">
                        <Icon name="mapPin" size={48} className="mx-auto mb-4 text-gray-300" />
                        <p className="text-gray-500 font-medium text-lg">
                            {filterStatus !== 'all' ? 'No se encontraron territorios con los filtros aplicados' : 'No hay territorios registrados'}
                        </p>
                        {filterStatus !== 'all' && <button onClick={() => { setFilterStatus('all'); }} className="mt-4 text-indigo-600 hover:text-indigo-700 font-medium">Limpiar filtros</button>}
                    </div>
                )}
            </main>
        </div>
    );
};


// --- Componente Actualizado: Panel de control con lógica corregida ---
// --- Componente Actualizado: Panel de control con lógica corregida ---
// Reemplaza tu componente TerritoryDetailHeader existente con este código.

const TerritoryDetailHeader = ({
    territory,
    stats,
    onBack,
    isAdmin,
    isProcessing,
    onAssign,
    onReturn,
    onAddAddress,
    isAssignedToMe,
    sortControls, // Recibe todo el objeto de control
    viewControls,
    onOpenMapModal
}) => {
    return (
        <header className="bg-slate-100 sticky top-0 z-20 border-b border-slate-200">
            {/* Barra superior con botón de volver y acciones principales */}
            <div className="px-4 pt-4 pb-3">
                <div className="flex items-center justify-between">
                    <button 
                        onClick={onBack} 
                        className="w-10 h-10 flex items-center justify-center rounded-full bg-white hover:bg-gray-100 transition-all shadow-sm border border-gray-200 hover:shadow-md"
                        aria-label="Volver a territorios"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="text-gray-700"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    
                    <div className="flex items-center space-x-2">
                        {/* --- INICIO DE LA MODIFICACIÓN: Botón siempre visible --- */}
                        <button 
                            onClick={onAddAddress}
                            disabled={isProcessing}
                            className="px-3 py-1.5 text-xs font-bold text-white bg-green-600 rounded-full hover:bg-green-700 disabled:bg-green-400 transition-all flex items-center shadow-sm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                            </svg>
                            Agregar dirección
                        </button>
                        {/* --- FIN DE LA MODIFICACIÓN --- */}
                        
                        {/* Botones solo para administradores */}
                        {isAdmin && (
                            <>
                                {territory.status !== 'Terminado' && (
                                    <button 
                                        onClick={onAssign}
                                        disabled={isProcessing}
                                        className="px-3 py-1.5 text-xs font-bold text-white bg-blue-600 rounded-full hover:bg-blue-700 disabled:bg-blue-400 transition-all flex items-center shadow-sm"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                        {territory.status === 'En uso' ? 'Reasignar' : 'Asignar'}
                                    </button>
                                )}
                                
                                {territory.status === 'En uso' && (
                                    <button 
                                        onClick={onReturn}
                                        disabled={isProcessing}
                                        className="p-2 text-slate-500 bg-slate-200 rounded-full hover:bg-slate-300 disabled:opacity-50 transition-colors"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                    </button>
                                )}
                            </>
                        )}
                    </div>
                </div>
            </div>

            <div className="px-4 pb-4 flex items-center justify-between gap-4">
                <div className="flex-1 min-w-0">
                    <h2 
                        className="text-xl font-bold text-slate-800 truncate cursor-pointer hover:text-indigo-600 transition-colors flex items-center group"
                        onClick={() => onOpenMapModal()}
                        title="Ver mapa del territorio"
                    >
                        <Icon name="map" size={20} className="mr-2 text-slate-500 group-hover:text-indigo-500" />
                        {territory.name}
                    </h2>
                    <p className="text-sm text-slate-500">{stats.visited} de {stats.total} trabajadas</p>
                </div>

                <div className="flex items-center flex-shrink-0 space-x-2">
                    {sortControls.sortOrder !== 'alpha' ? (
                         <button 
                            onClick={sortControls.onResetSort} 
                            className="p-2.5 text-red-500 bg-white rounded-lg shadow-sm border border-red-200 hover:bg-red-50 transition-all"
                            title="Restaurar orden original"
                         >
                            <Icon name="x" size={18} />
                        </button>
                    ) : (
                        <button 
                            onClick={sortControls.onSortByDistance} 
                            disabled={sortControls.isLocating}
                            className="p-2.5 text-slate-500 bg-white rounded-lg shadow-sm border border-slate-200 hover:border-blue-300 disabled:opacity-50 transition-all"
                            title="Ordenar por proximidad"
                        >
                            {sortControls.isLocating 
                                ? <div className="animate-spin w-[18px] h-[18px] border-2 border-slate-400 border-t-transparent rounded-full"></div>
                                : <Icon name="navigation" size={18} />
                            }
                        </button>
                    )}
                    
                    <button 
                        onClick={sortControls.onOptimizedRoute} 
                        disabled={sortControls.isCalculatingRoute}
                        className={`p-2.5 rounded-lg shadow-sm border transition-all ${
                            sortControls.sortOrder === 'optimized' 
                            ? 'bg-green-600 text-white border-green-700 shadow-lg' 
                            : 'bg-red-600 text-white hover:bg-red-700 border-red-700'
                        }`}
                        title="Activar/Desactivar ruta optimizada"
                     >
                         {sortControls.isCalculatingRoute 
                            ? <div className="animate-spin w-[18px] h-[18px] border-2 border-current border-t-transparent rounded-full"></div>
                            : <Icon name="activity" size={18} />
                         }
                    </button>
                    
                    <div className="flex items-center space-x-1 p-1 rounded-lg bg-slate-200">
                         <button onClick={() => viewControls.setViewMode('grid-full')} className={`p-1.5 rounded-md ${viewControls.viewMode === 'grid-full' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'} transition-colors`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect></svg>
                        </button>
                        <button onClick={() => viewControls.setViewMode('list')} className={`p-1.5 rounded-md ${viewControls.viewMode === 'list' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-800'} transition-colors`}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>
    );
};

// --- Componente TerritoryDetailView ACTUALIZADO ---
// Reemplaza tu componente TerritoryDetailView existente con este código.
// --- Componente TerritoryDetailView ACTUALIZADO ---
// Reemplaza tu componente TerritoryDetailView existente con este código.

const TerritoryDetailView = ({ view, territory, onBack, onOpenModal, highlightedAddressId, sortState, onSortByDistance, onOptimizedRoute, onResetSort }) => {
    const { addresses, handleReturnTerritory, isLoading, handleAssignTerritory, currentUser, handleUpdateAddress, handleDeleteAddress, handleProposeAddressChange, handleProposeNewAddress, handleAddNewAddress } = useContext(AppContext);
    const { showToast } = useToast();
    
    const [navigatingAddressId, setNavigatingAddressId] = useState(null);
    const [isNavigatingHighlightActive, setIsNavigatingHighlightActive] = useState(false);
    const highlightTimerRef = useRef(null);

    const [showConfirmReturn, setShowConfirmReturn] = useState(false);
    const [viewMode, setViewMode] = useState('grid-full');
    const [isProcessing, setIsProcessing] = useState(false);
    const [isFormModalOpen, setIsFormModalOpen] = useState(false);
    const [editingAddress, setEditingAddress] = useState(null);
    const [isAssignModalOpen, setIsAssignModalOpen] = useState(false);
    
    const handleNavigationStart = (addressId) => {
        if (highlightTimerRef.current) clearTimeout(highlightTimerRef.current);
        setNavigatingAddressId(addressId);
    };

    const stopNavigatingHighlight = () => {
        if (highlightTimerRef.current) clearTimeout(highlightTimerRef.current);
        setIsNavigatingHighlightActive(false);
        setNavigatingAddressId(null); 
    };

    useEffect(() => {
        const handleVisibilityChange = () => {
            if (document.visibilityState === 'visible' && navigatingAddressId) {
                setIsNavigatingHighlightActive(true);
                highlightTimerRef.current = setTimeout(() => {
                    setIsNavigatingHighlightActive(false);
                    setNavigatingAddressId(null); 
                }, 20000); // 20 segundos
            } else {
                if (highlightTimerRef.current) clearTimeout(highlightTimerRef.current);
            }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            if (highlightTimerRef.current) clearTimeout(highlightTimerRef.current);
        };
    }, [navigatingAddressId]);

    const extractCoordinatesFromMapUrl = (mapUrl) => { if (!mapUrl) return null; const patterns = [/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/, /[@!](-?\d+\.?\d*),(-?\d+\.?\d*)/, /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/, /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/, /@(-?\d+\.\d+),(-?\d+\.\d+)/]; for (const pattern of patterns) { const match = mapUrl.match(pattern); if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) }; } return null; };
    const getDistance = (lat1, lon1, lat2, lon2) => { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; };
    
    useEffect(() => { const handleResize = () => { if (window.innerWidth < 640 && viewMode === 'grid-two') setViewMode('grid-full'); }; handleResize(); window.addEventListener('resize', handleResize); return () => window.removeEventListener('resize', handleResize); }, [viewMode]);
    useEffect(() => { if (highlightedAddressId) { setTimeout(() => { const element = document.getElementById(`address-card-${highlightedAddressId}`); if (element) element.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); } }, [highlightedAddressId]);
    
    const isAssignedToMe = territory.status === 'En uso' && territory.assignedTo === currentUser.name;
    const isAdmin = currentUser.role === 'admin';
    
    // --- INICIO DE LA CORRECCIÓN ---
    const territoryAddresses = useMemo(() => {
        const allTerritoryAddresses = addresses.filter(a => a.territoryId === territory.id);

        if (sortState.sortOrder === 'optimized' && sortState.optimizedRoute) {
            // Crear un mapa con los datos "en vivo" para una búsqueda eficiente.
            const liveAddressesMap = new Map(
                allTerritoryAddresses.map(addr => [addr.id, addr])
            );

            // Usar la ruta optimizada SOLO para obtener el ORDEN.
            const orderedAddresses = sortState.optimizedRoute.map((staleRouteAddress, index) => {
                // Para cada dirección en la ruta, obtener sus datos más recientes del mapa.
                const liveAddress = liveAddressesMap.get(staleRouteAddress.id);
                
                if (liveAddress) {
                    // Si la encontramos, la usamos y la eliminamos del mapa
                    // para no duplicarla al final.
                    liveAddressesMap.delete(staleRouteAddress.id);
                    return { ...liveAddress, routeOrder: index + 1 };
                }
                return null; // En caso de que la dirección haya sido eliminada.
            }).filter(Boolean); // Limpiar nulos.

            // Añadir al final cualquier dirección que no estuviera en la ruta original (ej. nuevas).
            const remainingAddresses = Array.from(liveAddressesMap.values());
            
            return [...orderedAddresses, ...remainingAddresses];
        }
        
        if (sortState.sortOrder === 'distance' && sortState.userLocation) {
            return allTerritoryAddresses.map(address => { 
                let coords = (address.latitude && address.longitude) ? { lat: address.latitude, lng: address.longitude } : extractCoordinatesFromMapUrl(address.mapUrl); 
                let distance = coords ? getDistance(sortState.userLocation.lat, sortState.userLocation.lng, coords.lat, coords.lng) : Infinity; 
                return { ...address, distance, hasCoordinates: !!coords }; 
            }).sort((a, b) => { 
                if(a.hasCoordinates && !b.hasCoordinates) return -1; 
                if(!a.hasCoordinates && b.hasCoordinates) return 1; 
                return a.distance - b.distance; 
            }); 
        }
        
        // Orden por defecto: alfabético.
        return [...allTerritoryAddresses].sort((a, b) => a.address.localeCompare(b.address, undefined, { numeric: true }));
    }, [addresses, territory.id, sortState]);
    // --- FIN DE LA CORRECCIÓN ---

    const stats = useMemo(() => { const allAddresses = addresses.filter(a => a.territoryId === territory.id); const visitedCount = allAddresses.filter(a => a.isVisited).length; const totalCount = allAddresses.length; return { visited: visitedCount, total: totalCount, pending: totalCount - visitedCount }; }, [addresses, territory.id]);
    
    const handleReturn = async () => { setIsProcessing(true); try { await handleReturnTerritory(territory.id); onBack(); } catch (error) { showToast('Error al devolver territorio', 'error'); } finally { setIsProcessing(false); setShowConfirmReturn(false); } };
    const handleAssignToPublisher = async (publisherName) => { setIsProcessing(true); try { await handleAssignTerritory(territory.id, publisherName); setIsAssignModalOpen(false); onBack(); } catch (error) { showToast('Error al asignar territorio', 'error'); } finally { setIsProcessing(false); } };
    
    const openEditModal = (address) => { setEditingAddress(address); setIsFormModalOpen(true); };
    const openAddModal = () => { setEditingAddress(null); setIsFormModalOpen(true); };

    const handleSaveAddress = async (formData, changeReason = '') => {
        setIsProcessing(true);
        try {
            if (!formData.isRevisita) formData.revisitaBy = '';
            if (!formData.isEstudio) formData.estudioBy = '';
            if (editingAddress) {
                if (currentUser.role === 'admin') {
                    await handleUpdateAddress(editingAddress.id, formData);
                    showToast('Dirección actualizada.', 'success');
                } else {
                    await handleProposeAddressChange(editingAddress.id, formData, changeReason);
                    showToast('Propuesta enviada para revisión.', 'info');
                }
            } else {
                await handleProposeNewAddress(territory.id, formData, changeReason);
            }
            setIsFormModalOpen(false); 
            setEditingAddress(null);
        } catch (error) { 
            showToast('Error al guardar', 'error'); 
        } 
        finally { setIsProcessing(false); }
    };

    const handleDeleteAddressAndClose = async (addressId) => {
        setIsProcessing(true);
        try {
            await handleDeleteAddress(addressId);
            showToast('Dirección eliminada correctamente.', 'success');
            setIsFormModalOpen(false);
            setEditingAddress(null);
        } catch (error) {
            showToast('Error al eliminar la dirección.', 'error');
        } finally { setIsProcessing(false); }
    };

    const handleToggleOptimizedRoute = () => {
        if (sortState.sortOrder === 'optimized') {
            onResetSort();
        } else {
            onOptimizedRoute();
        }
    };
    
    return (
        <React.Fragment>
            <div className="min-h-screen bg-slate-100 pb-4">
                <TerritoryDetailHeader
                    territory={territory}
                    stats={stats}
                    onBack={onBack}
                    isAdmin={isAdmin}
                    isAssignedToMe={isAssignedToMe}
                    isProcessing={isProcessing}
                    onAssign={() => setIsAssignModalOpen(true)}
                    onReturn={() => setShowConfirmReturn(true)}
                    onAddAddress={openAddModal}
                    onOpenMapModal={() => onOpenModal('map')}
                    sortControls={{
                        sortOrder: sortState.sortOrder,
                        isLocating: sortState.isLocating,
                        isCalculatingRoute: sortState.isCalculatingRoute,
                        onSortByDistance: onSortByDistance,
                        onOptimizedRoute: handleToggleOptimizedRoute,
                        onResetSort: onResetSort
                    }}
                    viewControls={{ viewMode, setViewMode }}
                />
                
                <main className="px-4 sm:px-6 mt-4">
                    {sortState.sortOrder === 'optimized' && (
                        <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center">
                           <Icon name="activity" size={20} className="text-green-600 mr-3" />
                            <div className="flex-1">
                                <p className="text-sm font-medium text-green-800">Ruta optimizada activa</p>
                                <p className="text-xs text-green-600">Las direcciones están ordenadas para minimizar el recorrido</p>
                            </div>
                        </div>
                    )}
                    <div className={`address-grid grid gap-4 ${viewMode === 'list' ? 'grid-cols-1' : 'grid-cols-1'}`}>
                        {territoryAddresses.map((address, index) => (
                            <AddressCard
                                key={address.id}
                                address={address}
                                isAssigned={isAssignedToMe}
                                index={index}
                                isHighlighted={address.id === highlightedAddressId}
                                isNavigating={isNavigatingHighlightActive && address.id === navigatingAddressId}
                                onNavigate={() => handleNavigationStart(address.id)}
                                onStopHighlight={stopNavigatingHighlight}
                                isAdmin={isAdmin}
                                onEdit={openEditModal}
                                viewMode={viewMode}
                            />
                        ))}
                    </div>
                </main>
            </div>
            
            <ConfirmationModal isOpen={showConfirmReturn} onConfirm={handleReturn} onCancel={() => setShowConfirmReturn(false)} title="¿Devolver territorio?" message={`¿Estás seguro de que deseas devolver el territorio ${territory.name}?`} confirmText="Devolver" type="warning" isLoading={isProcessing} />
            <AddressFormModal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSave={handleSaveAddress} onDelete={handleDeleteAddressAndClose} address={editingAddress} isSubmitting={isProcessing} />
            <AssignTerritoryModal isOpen={isAssignModalOpen} onClose={() => setIsAssignModalOpen(false)} onAssign={handleAssignToPublisher} territoryName={territory.name} isProcessing={isProcessing} />
            <TerritoryMapModal 
                isOpen={view.modal === 'map'} 
                onClose={() => onOpenModal(null)} 
                territory={territory} 
                addresses={territoryAddresses}
                isAssignedToMe={isAssignedToMe}
                isAdmin={isAdmin}
                onEditAddress={openEditModal}
                sortState={sortState}
                onSortByDistance={onSortByDistance}
                onOptimizedRoute={onOptimizedRoute}
                onResetSort={onResetSort}
            />
        </React.Fragment>
    );
};







// --- Componente de Instalación PWA Mejorado ---
        const InstallPwaPrompt = () => {
            const [installPrompt, setInstallPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);
            const [isDismissed, setIsDismissed] = useState(false);
            const { showToast } = useToast();
            
            useEffect(() => {
                const dismissed = localStorage.getItem('pwaPromptDismissed');
                if (dismissed) {
                    setIsDismissed(true);
                    return;
                }
                
                const isIOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches;
                
                setIsIOS(isIOSDevice);
                
                if (isInStandaloneMode) {
                    return;
                }
                
                const handler = (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                };
                
                window.addEventListener('beforeinstallprompt', handler);
                
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            
            const handleInstallClick = async () => {
                if (!installPrompt) return;
                
                const result = await installPrompt.prompt();
                
                if (result.outcome === 'accepted') {
                    showToast('¡App instalada correctamente!', 'success');
                } else {
                    showToast('Instalación cancelada', 'info');
                }
                
                setInstallPrompt(null);
            };
            
            const handleDismiss = () => {
                setIsDismissed(true);
                localStorage.setItem('pwaPromptDismissed', 'true');
            };
            
            if (isDismissed || (!installPrompt && !isIOS)) return null;
            
            return (
                <div className="fixed bottom-20 sm:bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:max-w-md bg-indigo-700 text-white p-4 rounded-xl shadow-lg z-40 safe-bottom">
                    <button
                        onClick={handleDismiss}
                        className="absolute top-2 right-2 text-indigo-200 hover:text-white"
                        aria-label="Cerrar"
                    >
                        <Icon name="x" size={20} />
                    </button>
                    
                    <div className="flex items-start">
                        <Icon name="download" size={24} className="mr-3 flex-shrink-0 mt-0.5" />
                        <div className="flex-1">
                            {isIOS ? (
                                <>
                                    <p className="font-medium text-sm mb-1">Instalar app en iOS</p>
                                    <p className="text-xs opacity-90">
                                        Toca <i className="fas fa-share"></i> y luego "Añadir a pantalla de inicio"
                                    </p>
                                </>
                            ) : (
                                <>
                                    <p className="font-medium text-sm mb-1">Instalar aplicación</p>
                                    <p className="text-xs opacity-90 mb-3">
                                        Accede más rápido y usa la app sin conexión
                                    </p>
                                    <button
                                        onClick={handleInstallClick}
                                        className="bg-white text-indigo-700 font-bold py-1.5 px-4 rounded-lg text-sm hover:bg-indigo-50 transition-colors"
                                    >
                                        Instalar ahora
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

// --- Pantalla de Login Mejorada ---
const LoginScreen = ({ onLogin }) => {
    const [accessCode, setAccessCode] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [db, setDb] = useState(null);
    const accessCodeRef = useRef(null);
    const passwordRef = useRef(null);
    
    useEffect(() => {
        const firebaseConfig = {
            apiKey: "AIzaSyAyD4lW7uKHw-rcnOqr4YrBLp3oskklO8A",
            authDomain: "gestor-territorios-ls.firebaseapp.com",
            projectId: "gestor-territorios-ls",
            storageBucket: "gestor-territorios-ls.appspot.com",
            messagingSenderId: "930008027118",
            appId: "1:930008027118:web:236a36e1ded5e1555c08ff"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        setDb(firebase.firestore());
        accessCodeRef.current?.focus();
    }, []);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!accessCode.trim() || !password.trim()) {
            setError('Por favor ingresa tu código de acceso y contraseña');
            return;
        }
        
        if (!db) {
            setError('Error de conexión. Por favor recarga la página.');
            return;
        }
        
        setIsLoading(true);
        setError('');
        
        try {
            const usersRef = db.collection('users');
            const query = await usersRef.where('accessCode', '==', accessCode.trim().toLowerCase()).get();
            
            if (query.empty) {
                setError('Código de acceso incorrecto');
                setAccessCode('');
                setPassword('');
                accessCodeRef.current?.focus();
            } else {
                const userDoc = query.docs[0];
                const userData = userDoc.data();
                
                if (userData.password === password) {
                    onLogin({
                        id: userDoc.id,
                        name: userData.name,
                        accessCode: userData.accessCode,
                        role: userData.role || 'user'
                    });
                } else {
                    setError('Contraseña incorrecta');
                    setPassword('');
                    passwordRef.current?.focus();
                }
            }
            
            if (navigator.vibrate && error) {
                navigator.vibrate(200);
            }
        } catch (error) {
            console.error('Error al iniciar sesión:', error);
            setError('Error al conectar con el servidor. Intenta de nuevo.');
        } finally {
            setIsLoading(false);
        }
    };
    
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-50 via-white to-purple-50">
            <InstallPwaPrompt />
            
            <div className="w-full max-w-sm mx-4">
                <div className="text-center mb-8">
                    <div className="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg transform hover:scale-105 transition-transform">
                        <Icon name="mapPin" size={48} className="text-white" />
                    </div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">
                        Gestor de Territorios
                    </h1>
                    <p className="text-gray-600">
                        Ingresa con tu código y contraseña
                    </p>
                </div>
                
                <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                    <form onSubmit={handleSubmit} autoComplete="off" className="space-y-6">
                        <div>
                            <label htmlFor="accessCode" className="block text-sm font-medium text-gray-700 mb-2">
                                Código de Acceso
                            </label>
                            <input
                                ref={accessCodeRef}
                                id="accessCode"
                                type="text"
                                value={accessCode}
                                onChange={(e) => {
                                    setAccessCode(e.target.value);
                                    setError('');
                                }}
                                className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors ${
                                    error ? 'border-red-300' : 'border-gray-300'
                                }`}
                                placeholder="Ej: juan1"
                                autoComplete="username"
                                autoCapitalize="off"
                                autoCorrect="off"
                                spellCheck="false"
                                disabled={isLoading}
                            />
                        </div>
                        
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2">
                                Contraseña
                            </label>
                            <div className="relative">
                                <input
                                    ref={passwordRef}
                                    id="password"
                                    type={showPassword ? "text" : "password"}
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setError('');
                                    }}
                                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors ${
                                        error ? 'border-red-300' : 'border-gray-300'
                                    }`}
                                    placeholder="Ingresa tu contraseña..."
                                    autoComplete="current-password"
                                    disabled={isLoading}
                                />
                                <button
                                    type="button"
                                    onClick={() => setShowPassword(!showPassword)}
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                    tabIndex={-1}
                                >
                                    <Icon name={showPassword ? "eyeOff" : "eye"} size={20} />
                                </button>
                            </div>
                        </div>
                        
                        {error && (
                            <div className="flex items-center text-red-600 text-sm bg-red-50 p-3 rounded-lg">
                                <Icon name="alertCircle" size={16} className="mr-2 flex-shrink-0" />
                                <span>{error}</span>
                            </div>
                        )}
                        
                        <button
                            type="submit"
                            disabled={isLoading || !accessCode.trim() || !password.trim()}
                            className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                        >
                            {isLoading ? (
                                <span className="flex items-center justify-center">
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                    </svg>
                                    Verificando...
                                </span>
                            ) : 'Entrar'}
                        </button>
                    </form>
                    
                    <div className="mt-6 text-center">
                        <p className="text-xs text-gray-500">
                            Si olvidaste tu contraseña o no puedes acceder, contacta al administrador
                        </p>
                    </div>
                </div>
                
                <div className="mt-8 text-center text-sm text-gray-500">
                    <p>© 2025 Gestor de Territorios LS</p>
                </div>
            </div>
        </div>
    );
};

// --- INICIO: Bloque de Código para Reemplazar ---
// Reemplaza tu componente AppProvider existente con todo este código.
const AppProvider = ({ children }) => {
    const { showToast } = useToast();
    
    // Referencias a los inputs de archivo
    const restoreFullBackupInputRef = useRef(null);
    const restoreAddressesOnlyInputRef = useRef(null);

    const [state, dispatch] = useReducer(appReducer, initialAppState);
    const [db, setDb] = useState(null);
    const [currentUser, setCurrentUser] = useState(() => {
        const savedUser = localStorage.getItem('currentUser');
        try {
            return savedUser ? JSON.parse(savedUser) : null;
        } catch {
            return null;
        }
    });
    const [allUsers, setAllUsers] = useState([]);
    const { isOnline: networkStatus } = useOnlineStatus();
    const [pendingProposalsCount, setPendingProposalsCount] = useState(0);
    const [userNotificationsCount, setUserNotificationsCount] = useState(0);
    
// Sistema de versiones y actualizaciones
    const CURRENT_VERSION = '2.5.0'; // Versión actual de la app
    const [updateAvailable, setUpdateAvailable] = useState(false);
    const [updateInfo, setUpdateInfo] = useState(null);
    const [showUpdateModal, setShowUpdateModal] = useState(false);
    const [isUpdating, setIsUpdating] = useState(false);
    const [lastVersionCheck, setLastVersionCheck] = useState(() => {
        return localStorage.getItem('lastVersionCheck') || null;
    });

    // Estados para restauración completa
    const [restoreFile, setRestoreFile] = useState(null);
    const [isRestoreConfirmOpen, setIsRestoreConfirmOpen] = useState(false);
    const [isProcessingRestore, setIsProcessingRestore] = useState(false);

    // Estados para restauración de solo direcciones
    const [restoreAddressesFile, setRestoreAddressesFile] = useState(null);
    const [isRestoreAddressesConfirmOpen, setIsRestoreAddressesConfirmOpen] = useState(false);
    const [isProcessingAddressRestore, setIsProcessingAddressRestore] = useState(false);

    // --- LÓGICA DE BACKUP Y RESTAURACIÓN ---
    const handleBackupData = async () => {
        if (!db) return showToast('La base de datos no está lista.', 'error');
        showToast('Iniciando la creación del backup completo...', 'info');
        try {
            const collectionsToBackup = ['users', 'territories', 'addresses', 'territoryHistory'];
            const backupData = {
                version: '2.3.0',
                type: 'full_backup',
                createdAt: new Date().toISOString(),
                data: {}
            };
            for(const collectionName of collectionsToBackup) {
                const snapshot = await db.collection(collectionName).get();
                backupData.data[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            const jsonString = JSON.stringify(backupData, (key, value) => {
                if (value && value.toDate) return value.toDate().toISOString();
                return value;
            }, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `backup-completo-territorios-LS-${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup completo creado y descargado.', 'success');
        } catch (error) {
            console.error("Error al crear el backup completo:", error);
            showToast('Error al crear el backup completo.', 'error');
        }
    };
    const handleBackupAddresses = async () => {
        if (!db) return showToast('La base de datos no está lista.', 'error');
        showToast('Creando backup de direcciones...', 'info');
        try {
            const backupData = {
                version: '2.3.0',
                type: 'addresses_only',
                createdAt: new Date().toISOString(),
                data: {}
            };
            
            const addressesSnapshot = await db.collection('addresses').get();
            backupData.data['addresses'] = addressesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const jsonString = JSON.stringify(backupData, (key, value) => {
                if (value && value.toDate) return value.toDate().toISOString();
                return value;
            }, 2);
            
            const blob = new Blob([jsonString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `backup-direcciones-LS-${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup de direcciones creado exitosamente.', 'success');
        } catch (error) {
            console.error("Error al crear el backup de direcciones:", error);
            showToast('Error al crear el backup de direcciones.', 'error');
        }
    };
    const handleFileSelectedForRestore = (event) => {
        const file = event.target.files[0];
        if (file && file.type === 'application/json') {
            setRestoreFile(file);
            setIsRestoreConfirmOpen(true);
        } else if (file) {
            showToast('Por favor, selecciona un archivo de backup válido (.json).', 'error');
        }
        if (event.target) event.target.value = null;
    };
    const handleFileSelectedForRestoreAddresses = (event) => {
        const file = event.target.files[0];
        if (file && file.type === 'application/json') {
            setRestoreAddressesFile(file);
            setIsRestoreAddressesConfirmOpen(true);
        } else if (file) {
            showToast('Por favor, selecciona un archivo de backup de direcciones válido (.json).', 'error');
        }
        if (event.target) event.target.value = null;
    };
    const executeRestoreData = () => { /* Implementación completa de restauración */ };
    const executeRestoreAddresses = () => {
        if (!restoreAddressesFile || !db) return;
        setIsProcessingAddressRestore(true);
        showToast('Iniciando restauración de direcciones...', 'info', 10000);
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                if (backup.type !== 'addresses_only') {
                    throw new Error('El archivo no es un backup de solo direcciones.');
                }
                const addressesCollection = db.collection('addresses');
                const existingAddresses = await addressesCollection.get();
                if (!existingAddresses.empty) {
                    const deleteBatch = db.batch();
                    existingAddresses.docs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    showToast('Direcciones existentes eliminadas.', 'info');
                }
                const newAddresses = backup.data.addresses;
                if (!newAddresses || newAddresses.length === 0) {
                     showToast('El archivo de backup no contiene direcciones.', 'warning');
                     return;
                }
                const BATCH_SIZE = 499;
                for (let i = 0; i < newAddresses.length; i += BATCH_SIZE) {
                    const batch = db.batch();
                    const chunk = newAddresses.slice(i, i + BATCH_SIZE);
                    chunk.forEach(item => {
                        const { id, ...itemData } = item;
                        Object.keys(itemData).forEach(key => {
                            if (typeof itemData[key] === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(itemData[key])) {
                                itemData[key] = firebase.firestore.Timestamp.fromDate(new Date(itemData[key]));
                            }
                        });
                        const docRef = addressesCollection.doc(id);
                        batch.set(docRef, itemData);
                    });
                    await batch.commit();
                }
                showToast('¡Restauración de direcciones completada!', 'success');
            } catch (error) {
                console.error("Error al restaurar direcciones:", error);
                showToast(`Error: ${error.message}`, 'error', 5000);
            } finally {
                setIsProcessingAddressRestore(false);
                setRestoreAddressesFile(null);
                setIsRestoreAddressesConfirmOpen(false);
            }
        };
        reader.readAsText(restoreAddressesFile);
    };
    const cancelRestore = () => {
        setRestoreFile(null);
        setIsRestoreConfirmOpen(false);
    };
    const cancelRestoreAddresses = () => {
        setRestoreAddressesFile(null);
        setIsRestoreAddressesConfirmOpen(false);
    };
const handleLogout = () => {
    // Limpiar el usuario
    localStorage.removeItem('currentUser');
    setCurrentUser(null);
    
    // Resetear el estado de la app
    dispatch({ type: APP_ACTIONS.SET_TERRITORIES, payload: [] });
    dispatch({ type: APP_ACTIONS.SET_ADDRESSES, payload: [] });
    dispatch({ type: APP_ACTIONS.SET_HISTORY, payload: [] });
    dispatch({ type: APP_ACTIONS.SET_LOADING, payload: false });
    
    // Limpiar el hash
    window.location.hash = '';
    
    // Forzar recarga completa para limpiar listeners de Firebase
    setTimeout(() => {
        window.location.reload();
    }, 100);
};

    useEffect(() => {
        dispatch({ type: APP_ACTIONS.SET_ONLINE, payload: networkStatus });
    }, [networkStatus]);
    
    // Función para verificar actualizaciones
    const checkForUpdates = async (silent = false) => {
        try {
            // Agregar timestamp para evitar caché
            const response = await fetch(`/version.json?t=${Date.now()}`, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });
            
            if (!response.ok) throw new Error('No se pudo verificar actualizaciones');
            
            const versionData = await response.json();
            
            // Función para comparar versiones semánticas
            const compareVersions = (v1, v2) => {
                const parts1 = v1.split('.').map(Number);
                const parts2 = v2.split('.').map(Number);
                
                for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                    const part1 = parts1[i] || 0;
                    const part2 = parts2[i] || 0;
                    
                    if (part1 > part2) return 1;
                    if (part1 < part2) return -1;
                }
                return 0;
            };
            
            // Comparar versiones - solo mostrar si hay una versión MAYOR disponible
            const comparison = compareVersions(versionData.version, CURRENT_VERSION);
            
            if (comparison > 0) { // La versión del servidor es mayor
                // Determinar qué cambios mostrar según el rol del usuario
                let relevantChanges = [...(versionData.changes.all || [])];
                
                if (currentUser?.role === 'admin') {
                    relevantChanges = [...relevantChanges, ...(versionData.changes.admin || [])];
                } else {
                    relevantChanges = [...relevantChanges, ...(versionData.changes.publisher || [])];
                }
                
                // Si hay cambios relevantes para este usuario
                if (relevantChanges.length > 0) {
                    console.log('Versión actual:', CURRENT_VERSION, 'Versión disponible:', versionData.version);
                    setUpdateInfo({
                        ...versionData,
                        relevantChanges,
                        currentVersion: CURRENT_VERSION
                    });
                    setUpdateAvailable(true);
                    
                    // Mostrar notificación si no es verificación silenciosa
                    if (!silent) {
                        showToast('¡Nueva actualización disponible!', 'info');
                        setShowUpdateModal(true);
                    }
                    
                    // Si es una actualización forzosa
                    if (versionData.forceUpdate) {
                        setShowUpdateModal(true);
                    }
                }
            } else if (!silent) {
                if (comparison < 0) {
                    showToast('Tienes una versión más reciente que la del servidor', 'info');
                } else {
                    showToast('Ya tienes la última versión', 'success');
                }
            }
            
            // Guardar última verificación
            const now = new Date().toISOString();
            setLastVersionCheck(now);
            localStorage.setItem('lastVersionCheck', now);
            
        } catch (error) {
            console.error('Error al verificar actualizaciones:', error);
            if (!silent) {
                showToast('No se pudo verificar actualizaciones', 'error');
            }
        }
    };
    
    // Función para actualizar la aplicación
    const performUpdate = async () => {
        setIsUpdating(true);
        showToast('Actualizando aplicación...', 'info', 10000); // Toast más largo
        
        try {
            // Guardar el estado del usuario antes de recargar
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            // Si hay service worker, actualizarlo
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    showToast('Descargando actualización...', 'info', 10000);
                    
                    // Forzar actualización del service worker
                    await registration.update();
                    
                    // Esperar a que el nuevo service worker esté listo
                    const newWorker = registration.installing || registration.waiting;
                    
                    if (newWorker) {
                        // Crear una promesa para esperar el estado activated
                        await new Promise((resolve) => {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    resolve();
                                }
                            });
                            
                            // Enviar mensaje para skipWaiting
                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                        });
                        
                        // Limpiar caché
                        showToast('Limpiando caché...', 'info', 5000);
                        if ('caches' in window) {
                            const names = await caches.keys();
                            await Promise.all(names.map(name => caches.delete(name)));
                        }
                        
                        showToast('¡Actualización completa! Recargando...', 'success', 3000);
                        
                        // Esperar un poco para que el usuario vea el mensaje
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        // Recargar con un flag especial
                        localStorage.setItem('justUpdated', 'true');
                        window.location.reload(true);
                    } else {
                        // Si no hay nuevo worker, solo recargar
                        showToast('Aplicando cambios...', 'info', 3000);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        localStorage.setItem('justUpdated', 'true');
                        window.location.reload(true);
                    }
                } else {
                    // Sin service worker
                    showToast('Aplicando actualización...', 'info', 3000);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    localStorage.setItem('justUpdated', 'true');
                    window.location.reload(true);
                }
            } else {
                // Si no hay service worker, solo recargar
                showToast('Recargando aplicación...', 'info', 3000);
                await new Promise(resolve => setTimeout(resolve, 1000));
                localStorage.setItem('justUpdated', 'true');
                window.location.reload(true);
            }
        } catch (error) {
            console.error('Error al actualizar:', error);
            showToast('Error al actualizar. Intenta recargar manualmente.', 'error', 5000);
            setIsUpdating(false);
        }
    };
    
    // Verificar actualizaciones al iniciar si es admin
    useEffect(() => {
        if (currentUser && db) {
            // Verificar si venimos de una actualización
            const justUpdated = localStorage.getItem('justUpdated');
            if (justUpdated === 'true') {
                localStorage.removeItem('justUpdated');
                localStorage.removeItem('lastVersionCheck'); // Limpiar última verificación
                setUpdateAvailable(false); // Asegurar que no muestre actualización disponible
                setUpdateInfo(null); // Limpiar info de actualización
                showToast(`¡Aplicación actualizada exitosamente a la versión ${CURRENT_VERSION}!`, 'success', 5000);
                // Dar tiempo para que Firebase se inicialice completamente
                setTimeout(() => {
                    if (state.addresses.length === 0) {
                        // Forzar recarga de datos si no hay direcciones
                        window.location.reload();
                    }
                }, 3000);
            }
            
            // Verificar inmediatamente al iniciar
            checkForUpdates(true);
            
            // Verificar cada 5 minutos
            const interval = setInterval(() => {
                checkForUpdates(true);
            }, 5 * 60 * 1000);
            
            return () => clearInterval(interval);
        }
    }, [currentUser, db, state.addresses.length]);
    
    useEffect(() => {
        const initFirebase = async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyAyD4lW7uKHw-rcnOqr4YrBLp3oskklO8A",
                authDomain: "gestor-territorios-ls.firebaseapp.com",
                projectId: "gestor-territorios-ls",
                storageBucket: "gestor-territorios-ls.appspot.com",
                messagingSenderId: "930008027118",
                appId: "1:930008027118:web:236a36e1ded5e1555c08ff"
            };
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const firestore = firebase.firestore();
                
                // Intentar habilitar persistencia, pero continuar si falla
                try {
                    await firestore.enablePersistence({ synchronizeTabs: true });
                } catch (persistError) {
                    console.warn('Persistencia ya habilitada o no disponible:', persistError);
                }
                
                setDb(firestore);
                
                // Si no hay conexión, intentar obtener desde caché
                if (!navigator.onLine) {
                    showToast('Modo sin conexión: mostrando datos guardados', 'info');
                }
            } catch (error) {
                console.error('Error al inicializar Firebase:', error);
                dispatch({ type: APP_ACTIONS.SET_ERROR, payload: 'Error al conectar con la base de datos' });
                // Reintentar después de 2 segundos
                setTimeout(initFirebase, 2000);
            }
        };
        initFirebase();
    }, []);

    // Effect for data listeners
    useEffect(() => {
        if (!db || !currentUser) return;
        
        dispatch({ type: APP_ACTIONS.SET_LOADING, payload: true });

        const unsubscribers = [];
        
        unsubscribers.push(db.collection('territories').onSnapshot(
            snapshot => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dispatch({ type: APP_ACTIONS.SET_TERRITORIES, payload: data });
                if(state.isLoading) dispatch({ type: APP_ACTIONS.SET_LOADING, payload: false });
            }, error => {
                console.error('Error al cargar territorios:', error);
                dispatch({ type: APP_ACTIONS.SET_ERROR, payload: 'No se pudieron cargar los territorios.' });
            }
        ));

        unsubscribers.push(db.collection('addresses').onSnapshot(
            snapshot => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dispatch({ type: APP_ACTIONS.SET_ADDRESSES, payload: data });
            }, error => console.error('Error al cargar direcciones:', error)
        ));
        
        unsubscribers.push(db.collection('territoryHistory').orderBy('assignedDate', 'desc').limit(100).onSnapshot(
            snapshot => dispatch({ type: APP_ACTIONS.SET_HISTORY, payload: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) }),
            error => console.error('Error al cargar historial:', error)
        ));

        unsubscribers.push(db.collection('users').onSnapshot(
            snapshot => {
                const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAllUsers(usersData.sort((a,b) => a.name.localeCompare(b.name)));
            }, error => console.error("Error al cargar la lista de publicadores:", error)
        ));

        // Admin listener for pending proposals
        if (currentUser.role === 'admin') {
            unsubscribers.push(db.collection('addressChangeProposals')
                .where('status', '==', 'pending')
                .onSnapshot(
                    snapshot => {
                        setPendingProposalsCount(snapshot.size);
                    }, error => console.error('Error al cargar propuestas pendientes (admin):', error)
                )
            );
        }

        // User listener for their own notifications
        if (currentUser.role !== 'admin') {
            unsubscribers.push(db.collection('addressChangeProposals')
                .where('proposedByUserId', '==', currentUser.id)
                .where('status', 'in', ['approved', 'rejected'])
                .where('notificationRead', '==', false)
                .onSnapshot(
                    snapshot => {
                        setUserNotificationsCount(snapshot.size);
                    }, error => console.error('Error al cargar notificaciones de usuario:', error)
                )
            );
        }
        
        return () => unsubscribers.forEach(unsubscribe => unsubscribe());
    }, [db, currentUser]);

    useEffect(() => {
        const forceRefreshOnVisibility = async () => {
            if (document.visibilityState === 'visible' && db && currentUser) {
                try {
                    if (currentUser.role !== 'admin') {
                       const unreadSnapshot = await db.collection('addressChangeProposals')
                           .where('proposedByUserId', '==', currentUser.id)
                           .where('status', 'in', ['approved', 'rejected'])
                           .where('notificationRead', '==', false)
                           .get({ source: 'server' });
                       setUserNotificationsCount(unreadSnapshot.size);
                    }
                    if (currentUser.role === 'admin') {
                        const pendingSnapshot = await db.collection('addressChangeProposals')
                            .where('status', '==', 'pending')
                            .get({ source: 'server' });
                        setPendingProposalsCount(pendingSnapshot.size);
                    }
                } catch (error) {
                    console.error("Error forzando la actualización de notificaciones:", error);
                }
            }
        };
        document.addEventListener('visibilitychange', forceRefreshOnVisibility);
        return () => {
            document.removeEventListener('visibilitychange', forceRefreshOnVisibility);
        };
    }, [db, currentUser]);

    const handleAssignTerritory = async (territoryId, publisherNameToAssign) => {
        const territoryRef = db.collection('territories').doc(territoryId);
        const historyRef = db.collection('territoryHistory');
        const territoryDoc = await territoryRef.get();
        const territoryData = territoryDoc.data();

        await db.runTransaction(async (transaction) => {
            transaction.update(territoryRef, {
                status: 'En uso',
                assignedTo: publisherNameToAssign,
                assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                lastCompletedBy: null
            });

            transaction.set(historyRef.doc(), {
                territoryId: territoryId,
                territoryName: territoryData.name,
                assignedTo: publisherNameToAssign,
                status: 'Asignado',
                assignedDate: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        showToast(`Territorio ${territoryData.name} asignado a ${publisherNameToAssign}`, 'success');
    };
    
    const handleToggleAddressStatus = async (addressId, currentStatus) => {
        const newVisitedStatus = !currentStatus;
        if (!db) return;
    
        const addressRef = db.collection('addresses').doc(addressId);
        await addressRef.update({
            isVisited: newVisitedStatus,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
    
        if (!newVisitedStatus) {
            return;
        }
    
        try {
            // Obtener el territoryId desde el estado local o desde Firebase
            let territoryId;
            const addressDoc = state.addresses.find(a => a.id === addressId);
            
            if (addressDoc && addressDoc.territoryId) {
                territoryId = addressDoc.territoryId;
            } else {
                // Si no está en el estado local, consultarlo desde Firebase
                const addressSnapshot = await addressRef.get();
                if (!addressSnapshot.exists) {
                    console.error("No se pudo encontrar la dirección en Firebase.");
                    return;
                }
                territoryId = addressSnapshot.data().territoryId;
            }
            
            if (!territoryId) {
                console.error("No se pudo determinar el territoryId.");
                return;
            }
    
            // Consultar DIRECTAMENTE desde Firebase todas las direcciones del territorio
            const territoryAddressesSnapshot = await db.collection('addresses')
                .where('territoryId', '==', territoryId)
                .get();
            
            // Verificar si TODAS las direcciones están visitadas
            const allAddresses = territoryAddressesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            const allVisited = allAddresses.length > 0 && 
                              allAddresses.every(addr => addr.isVisited === true);
    
            if (allVisited) {
                const territoryRef = db.collection('territories').doc(territoryId);
                const territoryDoc = await territoryRef.get();
    
                if (territoryDoc.exists && territoryDoc.data().status === 'En uso') {
                    const territoryData = territoryDoc.data();
                    const completedBy = territoryData.assignedTo || currentUser.name;
    
                    await territoryRef.update({
                        status: 'Terminado',
                        assignedTo: null,
                        assignedDate: null,
                        lastCompletedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        lastCompletedBy: completedBy
                    });
                    
                    // Agregar registro al historial
                    await db.collection('territoryHistory').add({
                        territoryId: territoryId,
                        territoryName: territoryData.name,
                        assignedTo: completedBy,
                        status: 'Terminado',
                        completedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        assignedDate: territoryData.assignedDate || firebase.firestore.FieldValue.serverTimestamp()
                    });
    
                    showToast(`¡${territoryData.name} terminado!`, 'success', 5000);
                }
            }
        } catch (error) {
            console.error("Error en la lógica de auto-completado:", error);
            showToast('Error al verificar el estado del territorio.', 'error');
        }
    };

    const handleReturnTerritory = async (territoryId) => {
        if (!db) return showToast('La base de datos no está lista.', 'error');
        
        const territoryDoc = await db.collection('territories').doc(territoryId).get();
        if (!territoryDoc.exists) {
            showToast('Error: No se encontró el territorio.', 'error');
            return;
        }
        const territoryName = territoryDoc.data().name;
        
        showToast(`Devolviendo territorio ${territoryName}...`, 'info');

        try {
            const territoryRef = db.collection('territories').doc(territoryId);
            const addressesRef = db.collection('addresses');
            
            const addressesSnapshot = await addressesRef.where('territoryId', '==', territoryId).get();

            const batch = db.batch();

            batch.update(territoryRef, {
                status: 'Disponible',
                assignedTo: null,
                assignedDate: null
            });

            addressesSnapshot.docs.forEach(doc => {
                batch.update(doc.ref, { isVisited: false });
            });
            
            await batch.commit();
            
            await db.collection('territoryHistory').add({
                territoryId: territoryId,
                territoryName: territoryName,
                status: 'Devuelto',
                assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                assignedTo: currentUser.name 
            });

            showToast(`Territorio ${territoryName} ahora está disponible.`, 'success');

        } catch (error) {
            console.error("Error al devolver el territorio:", error);
            showToast('Ocurrió un error al devolver el territorio.', 'error');
        }
    };
    
    const handleResetSingleTerritory = async (territoryId) => {
        if (!db) return showToast('La base de datos no está lista.', 'error');
        
        const territoryDoc = await db.collection('territories').doc(territoryId).get();
        if (!territoryDoc.exists) {
            showToast('Error: No se encontró el territorio.', 'error');
            return;
        }
        const territoryName = territoryDoc.data().name;
        
        showToast(`Reiniciando territorio ${territoryName}...`, 'info');

        try {
            const territoryRef = db.collection('territories').doc(territoryId);
            const addressesRef = db.collection('addresses');
            
            const addressesSnapshot = await addressesRef.where('territoryId', '==', territoryId).get();

            const batch = db.batch();

            batch.update(territoryRef, {
                status: 'Disponible',
                assignedTo: null,
                assignedDate: null
            });

            addressesSnapshot.docs.forEach(doc => {
                batch.update(doc.ref, { isVisited: false });
            });

            const historyRef = db.collection('territoryHistory').doc();
            batch.set(historyRef, {
                territoryId: territoryId,
                territoryName: territoryName,
                status: 'Reiniciado (Admin)',
                assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                assignedTo: currentUser.name
            });
            
            await batch.commit();

            showToast(`Territorio ${territoryName} ha sido reiniciado.`, 'success');

        } catch (error) {
            console.error("Error al reiniciar el territorio:", error);
            showToast('Ocurrió un error al reiniciar el territorio.', 'error');
        }
    };
    
    const handleUpdateAddress = async (addressId, addressData) => {
        await db.collection('addresses').doc(addressId).update({
            ...addressData,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
    };
    
    // --- LÓGICA DE PROPUESTAS DE CAMBIOS (INCLUYE ELIMINACIÓN) ---
    const handleProposeAddressChange = async (addressId, proposedData, changeReason = '') => {
        if (!db) return;
        
        try {
            const addressDoc = await db.collection('addresses').doc(addressId).get();
            if (!addressDoc.exists) throw new Error('Dirección no encontrada');
            const originalData = addressDoc.data();
            
            // Guardar TODOS los campos originales para comparación
            const completeOriginal = {
                address: originalData.address || '',
                notes: originalData.notes || '',
                gender: originalData.gender || 'Desconocido',
                isRevisita: originalData.isRevisita || false,
                isEstudio: originalData.isEstudio || false,
                revisitaBy: originalData.revisitaBy || '',
                estudioBy: originalData.estudioBy || '',
                mapUrl: originalData.mapUrl || '',
                latitude: originalData.latitude || null,
                longitude: originalData.longitude || null
            };
            
            // Detectar qué campos cambiaron
            const changes = {};
            Object.keys(proposedData).forEach(key => {
                if (proposedData[key] !== completeOriginal[key]) {
                    changes[key] = {
                        original: completeOriginal[key],
                        proposed: proposedData[key]
                    };
                }
            });
            
            await db.collection('addressChangeProposals').add({
                proposalType: 'edit',
                addressId: addressId,
                territoryId: originalData.territoryId,
                proposedBy: currentUser.name,
                proposedByUserId: currentUser.id,
                proposedAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                original: completeOriginal,
                proposed: proposedData,
                changes: changes, // Solo los campos que cambiaron
                changeReason: changeReason
            });
            
            showToast('✅ Propuesta de cambio enviada.', 'success');
        } catch (error) {
            console.error('Error al proponer cambio:', error);
            showToast('Error al enviar la propuesta.', 'error');
        }
    };
    
    const handleProposeNewAddress = async (territoryId, addressData, changeReason = '') => {
        if (!db) return;
        
        try {
            // Obtener información del territorio
            const territoryDoc = await db.collection('territories').doc(territoryId).get();
            if (!territoryDoc.exists) throw new Error('Territorio no encontrado');
            const territoryData = territoryDoc.data();
            
            await db.collection('addressChangeProposals').add({
                proposalType: 'new', // Tipo de propuesta: nueva dirección
                territoryId: territoryId,
                territoryName: territoryData.name,
                proposedBy: currentUser.name,
                proposedByUserId: currentUser.id,
                proposedAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                proposed: addressData,
                changeReason: changeReason || 'Nueva dirección encontrada en el territorio'
            });
            
            showToast('✅ Propuesta de nueva dirección enviada.', 'success');
        } catch (error) {
            console.error('Error al proponer nueva dirección:', error);
            showToast('Error al enviar la propuesta.', 'error');
        }
    };
    
    const handleProposeDeletion = async (addressId) => {
        if (!db) return;
        try {
            const addressDoc = await db.collection('addresses').doc(addressId).get();
            if (!addressDoc.exists) throw new Error('Dirección no encontrada para proponer eliminación');
            const originalData = addressDoc.data();

            await db.collection('addressChangeProposals').add({
                proposalType: 'delete', // Tipo de propuesta: eliminación
                addressId: addressId,
                territoryId: originalData.territoryId,
                proposedBy: currentUser.name,
                proposedByUserId: currentUser.id,
                proposedAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                original: { address: originalData.address, notes: originalData.notes || '', gender: originalData.gender || 'Desconocido' }
            });

            showToast('✅ Propuesta de eliminación enviada.', 'success');
        } catch(error) {
            console.error("Error al proponer eliminación:", error);
            showToast('Error al enviar la propuesta de eliminación.', 'error');
        }
    };

    const handleDeleteAddress = async (addressId) => {
        // Esta función ahora es solo para administradores
        if (currentUser.role !== 'admin') {
            showToast('No tienes permiso para eliminar direcciones directamente.', 'error');
            return;
        }
        await db.collection('addresses').doc(addressId).delete();
    };
    
    const handleAddNewAddress = async (addressData) => {
        await db.collection('addresses').add({
            ...addressData,
            isVisited: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
    };
    
    const handleResetAllTerritories = async () => {
        if (!db) return showToast('La base de datos no está lista.', 'error');
        showToast('Iniciando reinicio completo...', 'info', 10000);
    
        try {
            const territoriesRef = db.collection('territories');
            const territoriesSnapshot = await territoriesRef.get();
    
            const addressesRef = db.collection('addresses');
            const addressesSnapshot = await addressesRef.get();
    
            const batchPromises = [];
            let currentBatch = db.batch();
            let operationCount = 0;
            const BATCH_LIMIT = 499;
    
            territoriesSnapshot.docs.forEach(doc => {
                currentBatch.update(doc.ref, {
                    status: 'Disponible',
                    assignedTo: null,
                    assignedDate: null,
                    lastCompletedDate: null,
                    lastCompletedBy: null
                });
                operationCount++;
                if (operationCount >= BATCH_LIMIT) {
                    batchPromises.push(currentBatch.commit());
                    currentBatch = db.batch();
                    operationCount = 0;
                }
            });
    
            addressesSnapshot.docs.forEach(doc => {
                currentBatch.update(doc.ref, {
                    isVisited: false
                });
                operationCount++;
                if (operationCount >= BATCH_LIMIT) {
                    batchPromises.push(currentBatch.commit());
                    currentBatch = db.batch();
                    operationCount = 0;
                }
            });
    
            if (operationCount > 0) {
                batchPromises.push(currentBatch.commit());
            }
    
            await Promise.all(batchPromises);
    
            await db.collection('territoryHistory').add({
                status: 'Reinicio General',
                assignedDate: firebase.firestore.FieldValue.serverTimestamp(),
                assignedTo: currentUser.name
            });
    
            showToast('¡Reinicio completado! Todos los territorios y direcciones han sido restaurados.', 'success');
        } catch (error) {
            console.error("Error durante el reinicio total:", error);
            showToast('Ocurrió un error durante el reinicio. Por favor, revisa la consola.', 'error');
        }
    };

    const contextValue = { 
        ...state, 
        db, 
        currentUser, 
        setCurrentUser, 
        allUsers, 
        handleAssignTerritory, 
        pendingProposalsCount, 
        handleReturnTerritory, 
        handleToggleAddressStatus,
        handleProposeAddressChange,
        handleProposeDeletion, // <-- Nueva función añadida al contexto
        handleProposeNewAddress, // <-- Nueva función para proponer direcciones
        handleUpdateAddress, 
        handleDeleteAddress,
        handleAddNewAddress,
        handleResetAllTerritories,
        handleResetSingleTerritory,
        showToast, 
        handleLogout,
        handleBackupData,
        handleFileSelectedForRestore,
        isRestoreConfirmOpen,
        isProcessingRestore,
        executeRestoreData,
        cancelRestore,
        restoreFullBackupInputRef,
        handleBackupAddresses,
        handleFileSelectedForRestoreAddresses,
        isRestoreAddressesConfirmOpen,
        isProcessingAddressRestore,
        executeRestoreAddresses,
        cancelRestoreAddresses,
        restoreAddressesOnlyInputRef, 
        userNotificationsCount,
        updateAvailable,
        updateInfo,
        checkForUpdates,
        performUpdate,
        isUpdating,
        showUpdateModal,
        setShowUpdateModal,
        CURRENT_VERSION, // Agregamos la versión al contexto
    };
    
    return (
        <AppContext.Provider value={contextValue}>
            {children}
            
            {/* Modal de Actualización */}
            <Modal 
                isOpen={showUpdateModal} 
                onClose={() => !updateInfo?.forceUpdate && setShowUpdateModal(false)} 
                title=""
                size="md"
                showCloseButton={!updateInfo?.forceUpdate}
            >
                <div className="p-6">
                    <div className="text-center mb-6">
                        <div className="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Icon name="rotateCcw" size={40} className="text-blue-600" />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900 mb-2">
                            ¡Nueva Actualización Disponible!
                        </h2>
                        <div className="flex items-center justify-center space-x-2 text-sm text-gray-600">
                            <span>Versión actual: {updateInfo?.currentVersion}</span>
                            <Icon name="arrowRight" size={16} />
                            <span className="font-bold text-blue-600">Versión {updateInfo?.version}</span>
                        </div>
                    </div>
                    
                    {/* Lista de cambios */}
                    <div className="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 className="font-semibold text-gray-900 mb-3 flex items-center">
                            <Icon name="activity" size={18} className="mr-2 text-gray-600" />
                            Novedades de esta actualización:
                        </h3>
                        <div className="space-y-2">
                            {updateInfo?.relevantChanges?.map((change, idx) => (
                                <div key={idx} className="flex items-start space-x-3">
                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 ${
                                        change.type === 'feature' ? 'bg-green-100' :
                                        change.type === 'fix' ? 'bg-yellow-100' :
                                        change.type === 'improvement' ? 'bg-blue-100' :
                                        'bg-gray-100'
                                    }`}>
                                        <Icon 
                                            name={
                                                change.type === 'feature' ? 'plus' :
                                                change.type === 'fix' ? 'wrench' :
                                                change.type === 'improvement' ? 'zap' :
                                                'info'
                                            } 
                                            size={12} 
                                            className={
                                                change.type === 'feature' ? 'text-green-600' :
                                                change.type === 'fix' ? 'text-yellow-600' :
                                                change.type === 'improvement' ? 'text-blue-600' :
                                                'text-gray-600'
                                            }
                                        />
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm text-gray-700">{change.description}</p>
                                        <span className={`text-xs inline-block mt-1 px-2 py-0.5 rounded-full ${
                                            change.type === 'feature' ? 'bg-green-100 text-green-700' :
                                            change.type === 'fix' ? 'bg-yellow-100 text-yellow-700' :
                                            change.type === 'improvement' ? 'bg-blue-100 text-blue-700' :
                                            'bg-gray-100 text-gray-700'
                                        }`}>
                                            {change.type === 'feature' ? 'Nueva función' :
                                             change.type === 'fix' ? 'Corrección' :
                                             change.type === 'improvement' ? 'Mejora' :
                                             'Información'}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {updateInfo?.forceUpdate && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div className="flex items-start space-x-3">
                                <Icon name="alertCircle" size={20} className="text-red-600 flex-shrink-0 mt-0.5" />
                                <div>
                                    <p className="text-sm font-medium text-red-900">
                                        Esta actualización es obligatoria
                                    </p>
                                    <p className="text-xs text-red-700 mt-1">
                                        Incluye cambios importantes que requieren actualización inmediata.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Botones de acción */}
                    <div className="flex justify-end space-x-3">
                        {!updateInfo?.forceUpdate && (
                            <button
                                onClick={() => setShowUpdateModal(false)}
                                disabled={isUpdating}
                                className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                            >
                                Más tarde
                            </button>
                        )}
                        <button
                            onClick={performUpdate}
                            disabled={isUpdating}
                            className="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all flex items-center disabled:opacity-50"
                        >
                            {isUpdating ? (
                                <>
                                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                    </svg>
                                    Actualizando...
                                </>
                            ) : (
                                <>
                                    <Icon name="download" size={18} className="mr-2" />
                                    Actualizar ahora
                                </>
                            )}
                        </button>
                    </div>
                </div>
            </Modal>
        </AppContext.Provider>
    );
};
// --- FIN: Bloque de Código para Reemplazar ---


// --- FIN: Bloque Corregido AppProvider ---







// --- COMPONENTE PRINCIPAL DE LA APLICACIÓN ---
        function App() {
            const { 
                currentUser, 
                setCurrentUser, 
                territories,
                addresses,
                showToast
            } = useContext(AppContext);

            const [view, setView] = useState({ name: 'grid', territoryId: null, modal: null });
            const [viewHistory, setViewHistory] = useState([{ name: 'grid', territoryId: null, modal: null }]);
            const [activeSortStates, setActiveSortStates] = useState({});

            const handleLogin = (user) => {
                localStorage.setItem('currentUser', JSON.stringify(user));
                setCurrentUser(user);
                
                if (window.gtag) {
                    window.gtag('event', 'login', { method: 'access_code' });
                }
            };
            
const handleLogout = () => {
    // Limpiar localStorage
    localStorage.removeItem('currentUser');
    setCurrentUser(null);
    
    // Resetear el hash
    window.location.hash = '';
    
    // Limpiar solo las claves específicas (mantener algunas)
    const keysToKeep = ['territoryDeviceId', 'pwaPromptDismissed'];
    Object.keys(localStorage).forEach(key => {
        if (!keysToKeep.includes(key)) localStorage.removeItem(key);
    });
    
    // IMPORTANTE: Recargar la página para limpiar todos los listeners
    // y el estado de Firebase completamente
    setTimeout(() => {
        window.location.reload();
    }, 100);
};
            
            useEffect(() => {
                let deviceId = localStorage.getItem('territoryDeviceId');
                if (!deviceId) {
                    deviceId = `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('territoryDeviceId', deviceId);
                }
            }, []);
            
useEffect(() => {
    const handlePopState = (event) => {
        const state = event.state || { name: 'grid', territoryId: null, modal: null };
        setView(state);
    };

    window.addEventListener('popstate', handlePopState);
    
    const hash = window.location.hash;
    let initialState = { name: 'grid', territoryId: null, modal: null };
    
    if (hash.startsWith('#/territorio/')) {
        const pathParts = hash.split('?')[0].split('/');
        initialState.name = 'detail';
        initialState.territoryId = pathParts[2];
    }
    
    const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
    const modal = urlParams.get('modal');
    if (modal) {
        initialState.modal = modal;
    }
    
    setView(initialState);
    window.history.replaceState(initialState, '');
    
    return () => window.removeEventListener('popstate', handlePopState);
}, []);

// Marcar que la app está completamente lista
useEffect(() => {
    // La inicialización ya maneja el splash, solo asegurar que el body esté listo
    document.body.classList.add('app-ready');
    
    // Por si acaso el splash no se removió
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => splash.remove(), 300);
    }
}, []);

            const getDistance = (lat1, lon1, lat2, lon2) => { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; };
            const extractCoordinatesFromMapUrl = (mapUrl) => { if (!mapUrl) return null; const patterns = [/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/, /[@!](-?\d+\.?\d*),(-?\d+\.?\d*)/, /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/, /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/, /@(-?\d+\.\d+),(-?\d+\.\d+)/]; for (const pattern of patterns) { const match = mapUrl.match(pattern); if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) }; } return null; };

            const updateSortState = (territoryId, newSortState) => {
                setActiveSortStates(prev => ({
                    ...prev,
                    [territoryId]: {
                        ...prev[territoryId],
                        ...newSortState
                    }
                }));
            };

            const handleSortByDistance = (territoryId) => {
                if (!navigator.geolocation) return showToast("La geolocalización no es compatible.", "error");
                updateSortState(territoryId, { isLocating: true });
                showToast("Obteniendo tu ubicación...", "info");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                        updateSortState(territoryId, { isLocating: false, sortOrder: 'distance', userLocation: userLoc });
                        showToast("Direcciones ordenadas por proximidad.", "success");
                    },
                    (error) => {
                        updateSortState(territoryId, { isLocating: false });
                        showToast("No se pudo obtener tu ubicación.", "error");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            };

            const handleOptimizedRoute = (territoryId) => {
                if (!navigator.geolocation) return showToast("La geolocalización no es compatible.", "error");
                updateSortState(territoryId, { isCalculatingRoute: true });
                showToast("Calculando ruta optimizada...", "info");

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const currentLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                        const territoryAddresses = addresses.filter(a => a.territoryId === territoryId);
                        const addressesWithCoords = territoryAddresses.map(address => ({ ...address, coords: (address.latitude && address.longitude) ? { lat: address.latitude, lng: address.longitude } : extractCoordinatesFromMapUrl(address.mapUrl) })).filter(a => a.coords);
                        
                        if (addressesWithCoords.length === 0) {
                            showToast("No hay direcciones con ubicación para crear la ruta.", "warning");
                            updateSortState(territoryId, { isCalculatingRoute: false });
                            return;
                        }

                        const route = [];
                        let unvisited = [...addressesWithCoords];
                        let currentPosition = currentLoc;
                        while (unvisited.length > 0) {
                            let nearestIndex = 0;
                            let nearestDistance = Infinity;
                            unvisited.forEach((address, index) => {
                                const distance = getDistance(currentPosition.lat, currentPosition.lng, address.coords.lat, address.coords.lng);
                                if (distance < nearestDistance) {
                                    nearestDistance = distance;
                                    nearestIndex = index;
                                }
                            });
                            const nearest = unvisited.splice(nearestIndex, 1)[0];
                            route.push({ ...nearest, routeOrder: route.length + 1 });
                            currentPosition = nearest.coords;
                        }
                        
                        updateSortState(territoryId, { isCalculatingRoute: false, sortOrder: 'optimized', userLocation: currentLoc, optimizedRoute: route });
                        showToast(`¡Ruta optimizada creada!`, "success");
                    },
                    (error) => {
                        updateSortState(territoryId, { isCalculatingRoute: false });
                        showToast("No se pudo obtener tu ubicación para la ruta.", "error");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            };
            
            const handleResetSort = (territoryId) => {
                setActiveSortStates(prev => {
                    const newState = { ...prev };
                    delete newState[territoryId];
                    return newState;
                });
                showToast('Orden original restaurado.', 'info');
            };

            const navigateToDetail = (territory, addressIdToHighlight = null) => {
                const newState = { 
                    name: 'detail', 
                    territoryId: territory.id, 
                    modal: null,
                    highlightedAddressId: addressIdToHighlight
                };
                
                const hash = `#/territorio/${territory.id}`;
                if (window.location.hash !== hash) {
                    window.history.pushState(newState, '', hash);
                }
                setView(newState);
                setViewHistory(prev => [...prev, newState]);
            };
            
            const navigateToGrid = () => {
                const newState = { name: 'grid', territoryId: null, modal: null };
                if (window.location.hash !== '#/') {
                    window.history.pushState(newState, '', '#/');
                }
                setView(newState);
                setViewHistory([newState]);
            };
            
const openModal = (modalName, fromMenu = false) => {
    const newState = { ...view, modal: modalName, fromMenu: fromMenu };
    const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
    urlParams.set('modal', modalName);
    if (fromMenu) urlParams.set('from', 'menu');
    const hash = `${window.location.hash.split('?')[0]}?${urlParams.toString()}`;
    if (window.location.hash !== hash) {
        window.history.pushState(newState, '', hash);
    }
    setView(newState);
};
            
const closeModal = () => {
    // Al cerrar un modal, simplemente vamos hacia atrás en el historial.
    // El 'popstate' listener se encargará de actualizar la vista al estado anterior.
    // Esto resuelve el problema de navegación.
    window.history.back();
};

            // --- INICIO DE LA CORRECCIÓN ---
            // Si no hay un usuario, SIEMPRE mostrar la pantalla de login.
            if (!currentUser) {
                return <LoginScreen onLogin={handleLogin} />;
            }
            // --- FIN DE LA CORRECCIÓN ---

            let viewToShow;
            const selectedTerritory = territories.find(t => t.id === view.territoryId);
            
            if (view.name === 'detail' && selectedTerritory) {
                viewToShow = <TerritoryDetailView 
                    view={view}
                    territory={selectedTerritory} 
                    onBack={navigateToGrid} 
                    onOpenModal={openModal}
                    highlightedAddressId={view.highlightedAddressId}
                    sortState={activeSortStates[selectedTerritory.id] || { sortOrder: 'alpha' }}
                    onSortByDistance={() => handleSortByDistance(selectedTerritory.id)}
                    onOptimizedRoute={() => handleOptimizedRoute(selectedTerritory.id)}
                    onResetSort={() => handleResetSort(selectedTerritory.id)}
                />;
            } else {
                viewToShow = <TerritoryGridView 
                    onSelectTerritory={navigateToDetail}
                    onOpenModal={openModal}
                />;
            }
            
            return (
                <div className="relative min-h-screen bg-gray-50">
                    {viewToShow}
<SmartSearchModal 
                        isOpen={view.modal === 'search'} 
                        onClose={closeModal}
                        onNavigate={navigateToDetail}
                    />

                    <MyActivityModal
                        isOpen={view.modal === 'myActivity'}
                        onClose={closeModal}
                        onNavigateToDetail={navigateToDetail}
                    />

                    <MyProposalsModal 
                        isOpen={view.modal === 'myProposals'} 
                        onClose={closeModal}
                        currentUser={currentUser}
                    />
                    
                    <AdminModal
                        isOpen={view.modal === 'admin'}
                        onClose={closeModal}
                    />
                    
                    <ChangePasswordModal
                        isOpen={view.modal === 'changePassword'}
                        onClose={closeModal}
                        currentUser={currentUser}
                    />

                    <InstallPwaPrompt />
                </div>
            );
        }

// --- GESTIÓN DE ERRORES GLOBAL ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { 
                    hasError: false, 
                    error: null,
                    errorInfo: null,
                    errorCount: 0
                };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error("Error capturado por ErrorBoundary:", error, errorInfo);
                
                this.setState(prevState => ({
                    errorInfo,
                    errorCount: prevState.errorCount + 1
                }));
                
                if (window.gtag) {
                    window.gtag('event', 'exception', {
                        description: error.toString(),
                        fatal: true
                    });
                }
                
                if (this.state.errorCount > 3) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            }
            
            handleReset = () => {
                this.setState({ 
                    hasError: false, 
                    error: null, 
                    errorInfo: null 
                });
            };
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
                                <Icon name="alertCircle" size={48} className="text-red-500 mx-auto mb-4" />
                                <h1 className="text-2xl font-bold text-gray-900 mb-2">
                                    ¡Ups! Algo salió mal
                                </h1>
                                <p className="text-gray-600 mb-6">
                                    Ha ocurrido un error inesperado. Por favor, intenta recargar la página.
                                </p>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors"
                                    >
                                        Recargar Página
                                    </button>
                                    <button
                                        onClick={this.handleReset}
                                        className="w-full bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Intentar de Nuevo
                                    </button>
                                </div>
                                
                                {this.state.errorCount > 2 && (
                                    <p className="mt-4 text-sm text-orange-600">
                                        Si el problema persiste, la página se recargará automáticamente...
                                    </p>
                                )}
                            </div>
                        </div>
                    );
                }
                
                return this.props.children;
            }
        }

// --- PUNTO DE ENTRADA DE LA APLICACIÓN ---
        const root = document.getElementById('root');
        
        const checkBrowserCompatibility = () => {
            const features = {
                'Promise': typeof Promise !== 'undefined',
                'fetch': typeof fetch !== 'undefined',
                'localStorage': typeof localStorage !== 'undefined',
                'sessionStorage': typeof sessionStorage !== 'undefined'
            };
            
            const unsupported = Object.entries(features)
                .filter(([feature, supported]) => !supported)
                .map(([feature]) => feature);
            
            if (unsupported.length > 0) {
                root.innerHTML = `
                    <div style="padding: 20px; text-align: center; font-family: sans-serif;">
                        <h1>Navegador no compatible</h1>
                        <p>Tu navegador no soporta las siguientes características necesarias:</p>
                        <p><strong>${unsupported.join(', ')}</strong></p>
                        <p>Por favor, actualiza tu navegador para usar esta aplicación.</p>
                    </div>
                `;
                return false;
            }
            
            return true;
        };
        
        if (checkBrowserCompatibility()) {
            ReactDOM.render(
                <React.StrictMode>
                    <ErrorBoundary>
                        <ToastProvider>
                            <AppProvider>
                                <App />
                            </AppProvider>
                        </ToastProvider>
                    </ErrorBoundary>
                </React.StrictMode>,
                root
            );
        }
        
// --- REGISTRO DEL SERVICE WORKER MEJORADO ---
if ('serviceWorker' in navigator) {
    // TEMPORAL: Forzar actualización del Service Worker (REMOVER DESPUÉS DE 1 SEMANA)
    // Descomentar las siguientes líneas solo si necesitas forzar actualización
    /*
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
    }).then(() => {
        // Re-registrar después de un pequeño delay
        setTimeout(() => {
            navigator.serviceWorker.register('/sw.js');
        }, 1000);
    });
    */
    
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registrado con éxito. Alcance:', registration.scope);
                
                // Verificar actualizaciones cada 60 segundos
                setInterval(() => {
                    registration.update();
                }, 60000);
                
                // Manejar actualizaciones del Service Worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('Nuevo Service Worker encontrado, instalando...');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('Nuevo Service Worker instalado, listo para actualizar');
                            
                            // Mostrar notificación de actualización disponible
                            if (window.showToast) {
                                window.showToast('Nueva versión disponible. La app se actualizará automáticamente.', 'info');
                            }
                            
                            // Auto-actualizar después de 2 segundos
                            setTimeout(() => {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                window.location.reload();
                            }, 2000);
                        }
                    });
                });
                
                // Detectar cuando el Service Worker toma control
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        console.log('Service Worker actualizado, recargando...');
                        window.location.reload();
                    }
                });
            })
            .catch(err => {
                console.error('Error al registrar el Service Worker:', err);
            });
    });
}

    </script>
</body>
</html>